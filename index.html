
<!DOCTYPE html>
<html lang="es">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tablero v11</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
    
<style>
    :root {
        --bg: #FFFFFF;
        --panel: #F8F9FA;
        --border: #E5E5E5;
        --dark: #000000;
        --accent: #007BFF;
        --pill-bg: #EAEAEA;
        --selection: rgba(0, 123, 255, 0.15);
    }

    body {
        margin: 0; padding: 0; 
        font-family: 'Open Sans', sans-serif; 
        background: var(--bg); 
        color: #333;
        height: 100vh; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
    }

  /* --- ENCABEZADO --- */
header { 
    padding: 8px 20px;   /* Reducido: antes 20px 30px. Ahora es mucho más delgado arriba y abajo */
    border-bottom: 1px solid var(--border); 
    background: white; 
    display: flex;
    align-items: baseline; /* Se mantiene como pediste: alineado a la base del texto */
    gap: 8px;            /* Reducido: antes 15px. El título y subtítulo estarán más juntos */
}
    header h1 { 
        font-family: 'Playfair Display', serif; 
        font-weight: 800; 
        font-size: 22px; 
        margin: 0; 
        color: var(--dark);
        letter-spacing: -0.5px;
    }

    .subtitle {
        font-family: 'Playfair Display', serif;
        font-weight: 400;
        font-size: 12px;
        color: #666;
        font-style: normal;
    }

    /* --- SELECTOR DE PESTAÑAS (Estilo Pill de la imagen) --- */
    .segmented-control {
        display: flex;
        background: var(--pill-bg);
        padding: 5px;
        border-radius: 50px;
        width: fit-content;
        margin: 15px auto;
        border: 1px solid #DBDBDB;
    }

    .tab-btn {
        border: none;
        background: transparent;
        padding: 8px 30px;
        border-radius: 50px;
        font-family: 'Open Sans', sans-serif;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #666;
    }

    .tab-btn.active {
        background: white;
        color: black;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* --- BARRA DE HERRAMIENTAS Y BOTONES (Open Sans) --- */
   /* Nueva Barra de Herramientas Vertical */
    
 .toolbar {
        display: flex;
        flex-direction: column;
        align-items: center;       /* Centra los elementos horizontalmente */
        gap: 10px;                 /* Espacio entre botones */
        padding: 15px 0;           /* Padding arriba y abajo, 0 a los lados */
        background: white; 
        border-right: 1px solid var(--border); 
        width: 85px;               /* Un poco más de ancho para comodidad */
        flex-shrink: 0;            /* Evita que la barra se encoja */
        
        /* Control de Scroll */
        height: calc(100vh - 60px); /* Altura total menos el header */
        overflow-y: auto;           /* Activa scroll si el contenido rebalsa */
        overflow-x: hidden;
        z-index: 10;
    }

    /* Estilo específico para los botones DENTRO de la toolbar */
    .toolbar .btn {
        flex-shrink: 0;            /* Evita que los botones se aplasten */
        width: 60px;               /* Ancho fijo para asegurar el centro */
        height: 60px;              /* Los hacemos cuadrados/circulares */
        padding: 0;                /* Quitamos el padding que los empujaba */
        display: flex;
        flex-direction: column;    /* Icono arriba, texto abajo */
        justify-content: center;
        align-items: center;
        font-size: 9px;            /* Texto más pequeño para que quepa */
        border-radius: 12px;       /* O 99px si los prefieres redondos */
        line-height: 1.2;
    }

    /* Si el botón tiene mucho texto (como 'SELECTOR'), esto ayuda */
    .toolbar .btn span {
        display: block;
        width: 100%;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
    }
   /* El divisor corregido: no se encoge y mantiene su forma */
    .divider { 
        height: 1px; 
        width: 30px; /* Un ancho más estético para la barra lateral */
        background: var(--border); 
        margin: 10px 0; 
        flex-shrink: 0; /* EVITA QUE LA LÍNEA DESAPAREZCA AL HACER SCROLL */
    }

    /* Contenedor de SNAP y otros divs internos corregidos */
    .toolbar > div[style*="display: flex"] {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 5px !important;
        margin: 10px 0 !important; /* Margen arriba/abajo, no a los lados */
        width: 100%;
        flex-shrink: 0;
    }

    /* Ajuste adicional para el texto dentro del SNAP si lo tienes */
    .toolbar span {
        font-size: 10px;
        text-transform: uppercase;
        font-weight: bold;
        color: #888;
        margin-bottom: 2px;
        flex-shrink: 0;
    }
    
  /* Botones de la barra de herramientas */
.btn {
    font-family: 'Open Sans', sans-serif;
    background: white; 
    border: 1px solid var(--border); 
    padding: 8px 22px; /* Un poco más de aire a los lados */
    border-radius: 99px; /* <--- ESTO los hace totalmente redondos */
    font-size: 12px; 
    font-weight: 600; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer; 
    transition: 0.2s;
    color: #444;
}

/* Pestañas del selector (Ya estaban en 50px, pero 99px asegura el efecto) */
.segmented-control, .tab-btn {
    border-radius: 99px; 
}

    /* --- LA PASTILLA GRIS (Segmented Control) --- */
    .segmented-control {
        display: flex;
        background: var(--pill-bg); /* Fondo gris que abarca todo */
        padding: 4px;
        border-radius: 99px; /* Redondeado total */
        width: fit-content;
        margin: 10px auto 20px auto;
        border: none; /* Sin bordes, solo el fondo gris */
    }
    
    .btn:hover { 
        background: #F0F0F0; 
        border-color: #BBB;
    }

    .btn.active { 
        background: var(--dark); 
        color: white; 
        border-color: var(--dark);
    }

    .divider { width: 1px; background: var(--border); margin: 0 10px; }

    /* --- ÁREA DE TRABAJO --- */
    #viewport { flex-grow: 1; position: relative; touch-action: none; background: white; }
    svg { width: 100%; height: 100%; display: block; }
    .grid { fill: url(#gridPattern); }
    
    /* --- ELEMENTOS DEL TABLERO --- */
    .drawing-element { fill: none; stroke: black; stroke-width: 2; stroke-linecap: round; pointer-events: all; }
    .latex-element { cursor: move; display: flex; align-items: center; justify-content: center; overflow: visible; }
    .latex-container { 
        width: 100%; height: 100%; display: flex; align-items: center; 
        justify-content: center; font-size: 20px; transition: font-size 0.1s;
    }
    
    /* --- SELECTOR Y UI --- */
    .selection-marquee { fill: var(--selection); stroke: var(--accent); stroke-dasharray: 4; pointer-events: none; }
    .element-highlight { stroke: var(--accent) !important; stroke-width: 3 !important; }
    .resize-handle { fill: white; stroke: var(--accent); stroke-width: 2; cursor: nwse-resize; }

    /* --- PANEL MODAL LATEX --- */
  /* PANEL LATEX REDISEÑADO */
#latex-panel {
    position: absolute;
    bottom: 20px; /* Ubicación inferior  */
    left: 50%;
    transform: translateX(-50%); /* Centrado horizontal */
    background: white; 
    padding: 15px 20px; 
    border-radius: 25px; /* Más redondeado [cite: 61] */
    border: 1px solid var(--border);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
    display: none; 
    z-index: 1000;
    min-width: 300px; /* Un poco más pequeño [cite: 62] */
    flex-direction: row; /* Para poner el visor al lado */
    align-items: center;
    gap: 15px;
}

/* El "manillar" para mover la ventana */
#latex-drag-handle {
    cursor: move;
    color: #ccc;
    font-size: 18px;
    padding-right: 10px;
    user-select: none;
}

/* El visor de vista previa */
#latex-preview {
    min-width: 80px;
    min-height: 50px;
    background: #f9f9f9;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border: 1px dashed #ddd;
    font-size: 14px;
}

#latex-val {
    border: 1px solid var(--border);
    border-radius: 12px; /* Redondeado [cite: 64] */
    padding: 8px 12px;
    outline: none;
    font-size: 14px;
}


/* PANEL LATERAL FIJO (SOBRE EL TABLERO) */
#symbols-side-panel {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 300px;
    background: white;
    border-left: 1px solid var(--border);
    box-shadow: -5px 0 15px rgba(0,0,0,0.05);
    display: none; /* Se controla con JS */
    flex-direction: column;
    z-index: 1000;
}


/* Cabecera con botón X */
.panel-header {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.panel-header h3 {
    margin: 0;
    font-family: 'Playfair Display', serif;
    font-size: 20px;
}

.close-panel-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    line-height: 1;
}
.close-panel-btn:hover { color: black; }

/* Sección de categorías (Scroll Vertical) */
.symbol-categories {
    display: flex;
    flex-direction: column;
    padding: 10px;
    gap: 5px;
    max-height: 250px; /* Limita el alto de las categorías */
    overflow-y: auto;
    background: #fcfcfc;
    border-bottom: 1px solid #eee;
}

.cat-btn {
    text-align: left;
    padding: 10px 15px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    color: #555;
}

.cat-btn.active {
    background: var(--dark);
    color: white;
    font-weight: 600;
}

/* Sección de símbolos (Scroll Vertical) */
#symbols-grid {
    flex-grow: 1;
    overflow-y: auto; /* Permite scroll en los símbolos */
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Tarjetas de símbolos (Horizontales) */
.sym-card {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: white;
    border: 1px solid #efefef;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.2s;
    gap: 15px;
}

.sym-card:hover {
    border-color: var(--accent);
    background: #f0f7ff;
}

.sym-card-icon {
    font-size: 20px;
    min-width: 35px;
    text-align: center;
}

.sym-card span {
    font-size: 12px;
    color: #777;
    font-weight: 600;
}

    /* Contenedor de herramientas del encabezado */
    .header-tools {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Botones pequeños para el encabezado */
    .btn-mini {
        width: 32px;
        height: 32px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        transition: all 0.2s;
    }

    .btn-mini:hover {
        background: var(--panel);
        border-color: #bbb;
    }

    .btn-danger:hover {
        background: #fff1f1;
        color: #dc3545;
        border-color: #dc3545;
    }

    /* Separador pequeño vertical */
    .mini-divider {
        width: 1px;
        height: 20px;
        background: var(--border);
        margin: 0 4px;
    }

    /* Contenedor del switch */
.switch {
  position: relative;
  display: inline-block;
  width: 38px;
  height: 20px;
}

/* Ocultamos el checkbox real */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* El fondo del slider (apagado) */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 20px;
}

/* El círculo blanco que se mueve */
.slider:before {
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

/* Color cuando está encendido (ON) */
input:checked + .slider {
  background-color: #1c1c1c; /* Verde, puedes cambiarlo a #2196F3 si prefieres azul */
}

/* Movimiento del círculo cuando está activado */
input:checked + .slider:before {
  transform: translateX(18px);
}


    /* Estilos del menú desplegable */
.dropdown-content {
    display: none; /* Oculto por defecto */
    position: absolute;
    right: 0; /* Se alinea a la derecha del botón */
    top: 40px;
    background-color: white;
    min-width: 160px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.1);
    border: 1px solid var(--border);
    border-radius: 15px; /* Redondeado como el panel latex */
    z-index: 1100;
    overflow: hidden;
    padding: 5px 0;
}

.dropdown-content button {
    width: 100%;
    padding: 10px 15px;
    border: none;
    background: none;
    text-align: left;
    font-size: 14px;
    cursor: pointer;
    font-family: 'Open Sans', sans-serif;
    transition: background 0.2s;
}

.dropdown-content button:hover {
    background-color: #f8f9fa;
    color: var(--accent);
}

/* Clase para mostrar el menú */
.show-menu {
    display: block !important;
}

#status-msg.show {
    display: block !important;
    animation: fadeInOut 3s forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(10px); }
    15% { opacity: 1; transform: translateY(0); }
    85% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(10px); }
}

/* Panel de figuras angosto */
.figure-panel-narrow {
    width: 85px !important; /* Igual que la toolbar */
    display: none; 
    flex-direction: column;
}

.figure-panel-narrow .side-panel-content {
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    
    /* CORRECCIÓN: */
    overflow-y: auto;      /* Habilita el scroll vertical */
    overflow-x: hidden;    /* Evita que se mueva hacia los lados */
    max-height: 80vh;      /* Altura máxima: 80% de la pantalla */
    width: 100%;           /* Asegura que ocupe el ancho del panel */
    box-sizing: border-box; /* Incluye el padding en el cálculo del ancho */
}

/* OPCIONAL: Haz que la barra de scroll sea más fina y moderna */
.figure-panel-narrow .side-panel-content::-webkit-scrollbar {
    width: 5px;
}
.figure-panel-narrow .side-panel-content::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
}

/* Tarjetas individuales dentro del panel */
.fig-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 65px;
    height: 65px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.fig-card:hover {
    background-color: var(--panel);
    border-color: var(--accent);
}

.fig-card i {
    width: 24px;
    height: 24px;
    margin-bottom: 4px;
}

.fig-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: #666;
}

    
    

/* --- ESTILO UNIFICADO PARA ICONOS LUCIDE --- */

/* 1. Tamaño y grosor para TODOS los iconos (Header y Barra Lateral) */
.btn-mini i, .btn-mini svg, 
.toolbar .btn i, .toolbar .btn svg {
    width: 18px;
    height: 18px;
    stroke-width: 2px; /* Grosor profesional */
    vertical-align: middle;
    flex-shrink: 0;    /* Evita que el icono se aplaste */
}

/* 2. Ajuste para botones pequeños del Header */
.btn-mini {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

/* 3. Ajuste para botones de la Barra Lateral */
.toolbar .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;    /* Espacio entre icono y texto */
    padding: 10px;
    width: 100%;
}

/* 4. Estilo del texto en los botones de la barra lateral */
.toolbar .btn span {
    font-size: 13px;
    font-weight: 500;
}
    
    /* Cursor de borrador */
.eraser-active {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 20 20"><rect x="0" y="0" width="18" height="18" fill="white" stroke="black" stroke-width="1"/></svg>') 10 10, auto !important;
}

    /* --- ESTILO DEL PANEL DE ENTRADA (Igual al de LaTeX) --- */
#graph-panel {
    display: none; 
    position: absolute; 
    bottom: 20px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: white; 
    padding: 15px 20px; 
    border-radius: 25px; 
    border: 1px solid #E5E5E5; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
    z-index: 1000;
    font-family: 'Open Sans', sans-serif;
}

/* Botones de funciones (sen, cos, sqrt...) */
.btn-math {
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 11px;
    cursor: pointer;
    padding: 6px;
    font-weight: 600;
    color: #333;
    transition: all 0.2s;
}
.btn-math:hover {
    background: #eeeeee;
    border-color: #ddd;
}

/* --- ESTILO DE LA GRÁFICA EN EL TABLERO --- */
.graph-widget-container {
    background: white;
    border: 1px solid #E5E5E5;
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
}

/* NÚMEROS DELGADOS Y EJES GRISES (Como pediste) */
.graph-widget-container text {
    font-family: 'Open Sans', sans-serif !important;
    font-weight: 100 !important; /* Grosor delgado */
    font-size: 10px !important;
    fill: #888 !important; /* Gris suave */
}

.graph-widget-container .axis path,
.graph-widget-container .axis line {
    stroke: #eee !important; /* Ejes muy sutiles */
}

/* PUNTERO: Crucial para rayar encima */
/* Si no estamos en modo SELECT, la gráfica ignora el mouse para que el lápiz pinte */
body:not(.mode-SELECT) foreignObject {
    pointer-events: none !important;
}

/* Si estamos en modo SELECT, permitimos mover y redimensionar */
body.mode-SELECT foreignObject {
    pointer-events: all !important;
    cursor: move;
}

/* Permite que el contenedor de la gráfica se pueda estirar desde la esquina */
.graph-wrapper {
    outline: none;
    resize: both;
    overflow: hidden !important;
    min-width: 100px;
    min-height: 100px;
}

    .pin-button {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 28px;
    height: 28px;
    background: white;
    border: 1px solid #E5E5E5;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    color: #333;
    transition: all 0.2s;
}
.pin-button:hover {
    background: #f0f0f0;
}
.pin-button.pinned {
    background: #000;
    color: #fff;
}

    
    
</style>
</head>
<body>

<header style="display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 60px;">
    <div style="display: flex; align-items: baseline; gap: 12px;">
        <div id="title" style="margin: 0; font-family: 'Playfair Display', serif; font-size: 24px;">
            Tablero
        </div>
        <span style="font-family: 'Playfair Display', serif; font-size: 18px; color: #555;">
            √(Raiz) Cuadrada²
        </span>
    </div>

<div class="header-tools">
    <button class="btn-mini btn-danger" onclick="clearEverything()" title="Eliminar Todo">
        <i data-lucide="trash-2"></i>
    </button>
    
    <div class="mini-divider"></div>
    
    <button class="btn-mini" onclick="undo()" title="Deshacer">
        <i data-lucide="undo-2"></i>
    </button>
    <button class="btn-mini" onclick="redo()" title="Rehacer">
        <i data-lucide="redo-2"></i>
    </button>
    
    <div class="mini-divider"></div>

    <button class="btn-mini" onclick="toggleFullScreen()" title="Pantalla Completa">
        <i data-lucide="maximize"></i>
    </button>

    <div class="mini-divider"></div>

    <div class="dropdown" style="position: relative; display: inline-block;">
        <button class="btn-mini" onclick="toggleDownloadMenu()" title="Descargar">
            <i data-lucide="download"></i>
        </button>
        <div id="download-menu" class="dropdown-content">
            <button onclick="downloadBoard('png')">
                <i data-lucide="image" style="width:14px; margin-right:8px;"></i> PNG
            </button>
            <button onclick="downloadBoard('pdf')">
                <i data-lucide="file-text" style="width:14px; margin-right:8px;"></i> PDF
            </button>
        </div>
    </div>
</div>
        
     <div class="snap-mini" style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 12px; font-weight: bold; font-family: sans-serif;">SNAP</span>
            <label class="switch">
                <input type="checkbox" id="snap-toggle-check" onclick="toggleSnap()">
                <span class="slider"></span>
            </label>
        </div>
    </div>
</header>
    

<div id="viewport" style="display: flex; flex-direction: row; position: relative; flex-grow: 1;">


    

    <div class="toolbar">

          <button class="btn" id="btn-SELECT" onclick="setMode('SELECT')" title="Selector">
        <i data-lucide="mouse-pointer-2"></i> <span>Selector</span>
    </button>

    
    <button class="btn active" id="btn-PENCIL" onclick="setMode('PENCIL')" title="Lápiz">
        <i data-lucide="pencil"></i>
    </button>
    <button class="btn" id="btn-POLY" onclick="setMode('POLY')" title="Línea/Polígono">
        <i data-lucide="pen-tool"></i>
    </button>

        <button class="btn" id="btn-ERASER" onclick="setMode('ERASER')" title="Borrador">
    <i data-lucide="eraser"></i> 
</button>

        <button class="btn" id="btn-FIGURES" onclick="toggleFiguresPanel()" title="Figuras">
    <i data-lucide="box"></i> <span>Figuras</span>
</button>
        
    <div class="divider"></div>

    <button class="btn" onclick="document.getElementById('img-up').click()" title="Insertar Imagen">
        <i data-lucide="image"></i> <span>Imagen</span>
    </button>
    <button class="btn" onclick="showLatexPanel()" title="Insertar LaTeX">
        <i data-lucide="sigma"></i> <span>Latex</span>
    </button>
    <button class="btn" id="btn-SYMBOLS" onclick="toggleSymbolsPanel()" title="Biblioteca de Símbolos">
        <i data-lucide="library"></i> <span>Símbolos</span>
    </button>

        <button class="btn" id="btn-GRAPH" onclick="setMode('GRAPH')" title="Graficar">
    <i data-lucide="box"></i>
    <span>Graficas</span>
</button>

    <div class="divider"></div>
</div>

    


    
    
    <div id="canvas-container" style="flex-grow: 1; position: relative; overflow: hidden; display: flex; flex-direction: column;">
        
<div id="latex-panel" style="display: none;">
    <div id="latex-drag-handle">⠿</div>
    
    <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
        <input type="text" id="latex-val" placeholder="\frac{a}{b^2}" oninput="updateLivePreview()">
        <div style="display: flex; gap: 8px;">
            <button class="btn-mini" onclick="addLatex()" title="Insertar">✓</button>
            <button class="btn-mini btn-danger" onclick="hideLatexPanel()" title="Cancelar">✕</button>
        </div>
    </div>

    <div id="latex-preview">
        <div id="preview-content">Vista...</div>
    </div>
</div>


        <div id="graph-panel" style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 20px; border-radius: 25px; border: 1px solid #E5E5E5; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000; flex-direction: row; align-items: center; gap: 15px;">
    <div style="cursor: move; color: #ccc; font-size: 18px; padding-right: 10px;">⠿</div>
    
    <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
        <input type="text" id="graph-exp" placeholder="x^2 + sin(x)" 
               style="border: 1px solid #E5E5E5; border-radius: 12px; padding: 8px 12px; outline: none; font-size: 14px; width: 200px;">
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; width: 100%;">
            <style> .btn-math { background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; font-size: 10px; cursor: pointer; padding: 4px; font-weight: 600; } .btn-math:hover { background: #eee; } </style>
            <button class="btn-math" onclick="addGraphSymbol('sen(')">sen</button>
            <button class="btn-math" onclick="addGraphSymbol('cos(')">cos</button>
            <button class="btn-math" onclick="addGraphSymbol('tan(')">tan</button>
            <button class="btn-math" onclick="addGraphSymbol('sqrt(')">sqrt</button>
            <button class="btn-math" onclick="addGraphSymbol('^')">^</button>
            <button class="btn-math" onclick="addGraphSymbol('ln(')">ln</button>
            <button class="btn-math" onclick="addGraphSymbol('exp(')">exp</button>
            <button class="btn-math" onclick="addGraphSymbol('abs(')">abs</button>
        </div>

        <div style="display: flex; gap: 8px; margin-top: 5px;">
            <button class="btn-mini" onclick="insertGraphOnBoard()" title="Insertar">✓</button>
            <button class="btn-mini btn-danger" onclick="hideGraphPanel()" title="Cancelar">✕</button>
        </div>
    </div>

    <div id="graph-live-preview" style="min-width: 120px; height: 120px; background: #f9f9f9; border-radius: 15px; border: 1px dashed #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden;">
    </div>
</div>

        
        <svg id="canvas">
    <defs>
        <marker id="arrowhead" 
                markerWidth="10" 
                markerHeight="7" 
                refX="10" 
                refY="3.5" 
                orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="black" />
        </marker>

        <pattern id="gridPattern" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#EEEEEE" stroke-width="1"/>
        </pattern>
    </defs>

    <rect class="grid" width="100%" height="100%" fill="url(#gridPattern)" />
    <g id="layer-images"></g>
    <g id="layer-latex"></g>
    <g id="layer-drawings"></g>
    <g id="layer-ui"></g>
</svg>

        
    </div> <div id="symbols-side-panel">
        <div class="panel-header">
            <h3>Símbolos</h3>
            <button onclick="toggleSymbolsPanel()" class="close-panel-btn">&times;</button>
        </div>
        
        <div class="symbol-categories">
            <button onclick="renderCategory('Principales')" class="cat-btn active">Principales</button>
            <button onclick="renderCategory('formulas')" class="cat-btn">Fórmulas</button>
            <button onclick="renderCategory('Letras Griegas')" class="cat-btn">Griegas</button>
            <button onclick="renderCategory('Flechas')" class="cat-btn">Flechas</button>
            <button onclick="renderCategory('Lógica')" class="cat-btn">Lógica</button>
            <button onclick="renderCategory('Desigualdades')" class="cat-btn">Desigualdades</button>
            <button onclick="renderCategory('Cálculo')" class="cat-btn">Cálculo</button>
            <button onclick="renderCategory('Conjuntos')" class="cat-btn">Conjuntos</button>
            <button onclick="renderCategory('Matrices/Sist')" class="cat-btn">Matrices</button>
            <button onclick="renderCategory('Paréntesis')" class="cat-btn">Paréntesis</button>
            <button onclick="renderCategory('Otros')" class="cat-btn">Otros</button>
        </div>

        <div id="symbols-grid">
            </div>
    </div>

    <div id="figures-side-panel" class="side-panel-right figure-panel-narrow">
    <div class="panel-header">
        <button class="close-panel-btn" onclick="toggleFiguresPanel()">×</button>
    </div>
    
    <div class="side-panel-content">
        <div class="fig-card" onclick="selectFigure('RECT')" title="Rectángulo">
            <i data-lucide="square"></i>
            <span class="fig-label">Rect</span>
        </div>
        
        <div class="fig-card" onclick="selectFigure('CIRCLE')" title="Círculo">
            <i data-lucide="circle"></i>
            <span class="fig-label">Circ</span>
        </div>
        
        <div class="fig-card" onclick="selectFigure('TRI')" title="Triángulo">
            <i data-lucide="triangle"></i>
            <span class="fig-label">Tri</span>
        </div>
        
        <div class="fig-card" onclick="selectFigure('COORD')" title="Coordenadas">
            <i data-lucide="move"></i>
            <span class="fig-label">Ejes</span>
        </div>
        <div class="fig-card" onclick="selectFigure('ELLIPSE')" title="Elipse">
        <i data-lucide="torus"></i><span class="fig-label">Elipse</span>
    </div>

    <div class="fig-card" onclick="selectFigure('ARROW')" title="Flecha">
        <i data-lucide="move-right"></i><span class="fig-label">Flecha</span>
    </div>
    <div class="fig-card" onclick="selectFigure('PARABOLA')" title="Parábola">
        <i data-lucide="spline"></i><span class="fig-label">Parab</span>
    </div>

    <div class="fig-card" onclick="selectFigure('CUBE')" title="Cubo">
        <i data-lucide="box"></i><span class="fig-label">Cubo</span>
    </div>
    <div class="fig-card" onclick="selectFigure('SPHERE')" title="Esfera">
        <i data-lucide="circle-dashed"></i><span class="fig-label">Esfera</span>
    </div>
    <div class="fig-card" onclick="selectFigure('CYLINDER')" title="Cilindro">
        <i data-lucide="cylinder"></i><span class="fig-label">Cilin</span>
    </div>
        
        </div>
</div>
    

</div>
    
    
<input type="file" id="img-up" hidden onchange="uploadImage(event)">

<script>
    /* =========================================
       SECCIÓN: ESTADO GLOBAL
    ========================================= */

    let snapEnabled = false;
const GRID_SIZE = 20; // El tamaño de cada cuadrito

function toggleSnap() {
    // 1. Detectamos si el switch está marcado (ON) o no (OFF)
    const isChecked = document.getElementById('snap-toggle-check').checked;
    
    // 2. Sincronizamos la variable que usa el tablero para el imán
    snapEnabled = isChecked;
    
    console.log("Snap " + (snapEnabled ? "Activado" : "Desactivado"));
}
    let mode = 'PENCIL';
    let isAction = false;
    let startPos = { x: 0, y: 0 };
    let currentEl = null;
    let selectedElements = [];
    let history = [];
    let redoHistory = []; 
let clipboard = [];
    let isResizing = false;

    const svg = document.getElementById('canvas');
    const layers = {
        img: document.getElementById('layer-images'),
        latex: document.getElementById('layer-latex'),
        draw: document.getElementById('layer-drawings'),
        ui: document.getElementById('layer-ui')
    };

    let editingEl = null; // Para saber si estamos creando uno nuevo o editando

    /* =========================================
       SECCIÓN: MOTOR DE EVENTOS (MOUSE / TOUCH)
    ========================================= */
    svg.addEventListener('pointerdown', onStart);
    svg.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onEnd);

   function getPos(e) {
    const r = svg.getBoundingClientRect();
    let x = e.clientX - r.left;
    let y = e.clientY - r.top;

    // Si el Snap está activo, redondeamos al múltiplo de 20 más cercano
    if (snapEnabled) {
        x = Math.round(x / GRID_SIZE) * GRID_SIZE;
        y = Math.round(y / GRID_SIZE) * GRID_SIZE;
    }

    return { x, y };
}

  function setMode(m) {
    mode = m;
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
    
    // El "if(btn)" evita que el código explote si el botón no existe
    const btn = document.getElementById('btn-' + m);
    if (btn) btn.classList.add('active');

    const viewport = document.getElementById('viewport');
    if (m === 'ERASER') viewport.classList.add('eraser-active');
    else viewport.classList.remove('eraser-active');
}

    /* =========================================
       SECCIÓN: LÓGICA DE SELECCIÓN (EL SELECTOR)
    ========================================= */
  function onStart(e) {
    const pos = getPos(e);
    startPos = pos;
    isAction = true;

    if (mode === 'ERASER') {
        saveHistory();
        return;
    }
    
    if (mode === 'SELECT') {
        if (e.target.classList.contains('resize-handle')) {
            isResizing = true;
            return;
        }
        const hit = e.target.closest('.draggable');
        if (hit && !e.shiftKey) {
            if (!selectedElements.includes(hit)) {
                deselect();
                selectElement(hit);
            }
        } else if (!hit) {
            deselect();
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            currentEl.setAttribute("class", "selection-marquee");
            layers.ui.appendChild(currentEl);
        }
        return;
    }

    if (mode === 'PENCIL') {
        saveHistory();
        currentEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
        currentEl.setAttribute("d", `M ${pos.x} ${pos.y}`);
        currentEl.setAttribute("class", "drawing-element draggable");
        layers.draw.appendChild(currentEl);
        return; // Añadido return para evitar que entre en otros bloques
    }

    if (mode === 'POLY') {
        if (!currentEl) {
            saveHistory();
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            currentEl.setAttribute("points", `${pos.x},${pos.y}`);
            currentEl.setAttribute("class", "drawing-element draggable");
            layers.draw.appendChild(currentEl);
        } else {
            let pts = currentEl.getAttribute("points");
            currentEl.setAttribute("points", `${pts} ${pos.x},${pos.y}`);
        }
        return;
    }

  const figureModes = ['RECT', 'CIRCLE', 'TRI', 'COORD', 'ELLIPSE', 'ARROW', 'CUBE', 'SPHERE', 'PARABOLA', 'CYLINDER'];
    
    if (figureModes.includes(mode)) {
        saveHistory();
        
        if (mode === 'RECT') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            currentEl.setAttribute("x", pos.x);
            currentEl.setAttribute("y", pos.y);
        } 
        else if (mode === 'CIRCLE') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            currentEl.setAttribute("cx", pos.x);
            currentEl.setAttribute("cy", pos.y);
        } 
        else if (mode === 'ELLIPSE') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
            currentEl.setAttribute("cx", pos.x);
            currentEl.setAttribute("cy", pos.y);
        }
        else if (mode === 'ARROW') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "line");
            currentEl.setAttribute("x1", pos.x);
            currentEl.setAttribute("y1", pos.y);
            // Arreglo del "enganche": inicializamos el final en la misma posición
            currentEl.setAttribute("x2", pos.x);
            currentEl.setAttribute("y2", pos.y);
            currentEl.setAttribute("marker-end", "url(#arrowhead)");
        }
        else if (mode === 'COORD') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "g");
            currentEl.classList.add('coord-system');
        } 
        else {
            // TRI, CUBE, SPHERE, PARABOLA, CYLINDER usan <path>
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
        }
        
        currentEl.classList.add('drawing-element', 'draggable');
        layers.draw.appendChild(currentEl);
    }
}
    function onMove(e) {
        if (!isAction) return;
        const pos = getPos(e);
        const dx = pos.x - startPos.x;
        const dy = pos.y - startPos.y;

        
// --- LÓGICA DEL BORRADOR ---
    if (mode === 'ERASER') {
        // Buscamos qué elemento hay bajo el puntero
        const el = document.elementFromPoint(e.clientX, e.clientY);
        
        // Si el elemento existe Y está en la capa de dibujos o de latex, lo borramos
        // Esto ignora automáticamente la capa 'layer-images'
        if (el && (layers.draw.contains(el) || layers.latex.contains(el))) {
            el.remove();
        }
        return;
    }
        if (mode === 'SELECT') {
            if (isResizing && selectedElements.length === 1) {
                resizeElement(selectedElements[0], pos);
            } else if (currentEl && currentEl.classList.contains('selection-marquee')) {
                // Dibujar recuadro de selección
                const x = Math.min(startPos.x, pos.x);
                const y = Math.min(startPos.y, pos.y);
                const w = Math.abs(dx);
                const h = Math.abs(dy);
                currentEl.setAttribute("x", x);
                currentEl.setAttribute("y", y);
                currentEl.setAttribute("width", w);
                currentEl.setAttribute("height", h);
                checkCollision(x, y, w, h);
            } else if (selectedElements.length > 0) {
                // Mover varios a la vez
                selectedElements.forEach(el => moveElement(el, dx, dy));
                startPos = pos;
            }
            updateSelectionUI();
            return;
        }

        if (mode === 'PENCIL' && currentEl) {
            let d = currentEl.getAttribute("d");
            currentEl.setAttribute("d", `${d} L ${pos.x} ${pos.y}`);
        }

if (isAction && ['RECT', 'CIRCLE', 'TRI', 'COORD', 'ELLIPSE', 'ARROW', 'CUBE', 'SPHERE', 'PARABOLA', 'CYLINDER'].includes(mode) && currentEl) {
        const w = Math.abs(pos.x - startPos.x);
        const h = Math.abs(pos.y - startPos.y);
        const x = Math.min(pos.x, startPos.x);
        const y = Math.min(pos.y, startPos.y);

        if (mode === 'RECT') {
            currentEl.setAttribute("x", x); 
            currentEl.setAttribute("y", y);
            currentEl.setAttribute("width", w); 
            currentEl.setAttribute("height", h);
        } else if (mode === 'CIRCLE') {
            const r = Math.sqrt(w*w + h*h);
            currentEl.setAttribute("r", r);
        } else if (mode === 'ELLIPSE') {
            currentEl.setAttribute('rx', w);
            currentEl.setAttribute('ry', h);
        } else if (mode === 'ARROW') {
            currentEl.setAttribute('x2', pos.x);
            currentEl.setAttribute('y2', pos.y);
        } else if (mode === 'TRI') {
            currentEl.setAttribute("d", `M ${startPos.x} ${pos.y} L ${pos.x} ${pos.y} L ${pos.x} ${startPos.y} Z`);
        } else if (mode === 'COORD') {
            drawCartesian(currentEl, x, y, w, h);
        } else if (mode === 'CUBE') {
            currentEl.setAttribute('d', drawCube(startPos.x, startPos.y, w));
        } else if (mode === 'SPHERE') {
            const r = Math.sqrt(w*w + h*h);
            currentEl.setAttribute('d', drawSphere(startPos.x, startPos.y, r));
        } else if (mode === 'PARABOLA') {
            const pw = pos.x - startPos.x;
            const ph = pos.y - startPos.y;
            currentEl.setAttribute('d', `M ${startPos.x-pw} ${startPos.y} Q ${startPos.x} ${startPos.y+ph*2} ${startPos.x+pw} ${startPos.y}`);
        } else if (mode === 'CYLINDER') {
            currentEl.setAttribute('d', drawCylinder(x, y, w, h));
        }
    }
         }
        

    function onEnd() {
        if (mode === 'SELECT') {
            if (currentEl) currentEl.remove();
            currentEl = null;
        }
        if (mode === 'PENCIL') currentEl = null;
        isAction = false;
        isResizing = false;
    }

            function clearEverything() {
    // Guardamos en el historial por si quieres deshacer el borrado
    saveHistory(); 
    
    // Limpiamos el contenido de todas las capas de dibujo 
    layers.draw.innerHTML = ''; 
    layers.latex.innerHTML = ''; 
    layers.img.innerHTML = '';
    
    // Quitamos cualquier selección activa
    deselect();
    
    console.log("Tablero vaciado por completo.");
}

    /* =========================================
       SECCIÓN: TRANSFORMACIONES (MOVER / ESCALAR)
    ========================================= */
    function moveElement(el, dx, dy) {
        if (el.tagName === 'path' || el.tagName === 'polyline'|| el.tagName === 'g') {
            const bbox = el.getBBox();
            const transform = el.getAttribute("transform") || "translate(0,0)";
            const parts = transform.split(/[() ,]+/);
            const tx = (parseFloat(parts[1]) || 0) + dx;
            const ty = (parseFloat(parts[2]) || 0) + dy;
            el.setAttribute("transform", `translate(${tx},${ty})`);
        } else {
            el.setAttribute("x", parseFloat(el.getAttribute("x")) + dx);
            el.setAttribute("y", parseFloat(el.getAttribute("y")) + dy);
        }
    }

    function resizeElement(el, pos) {
        const x = parseFloat(el.getAttribute("x"));
        const y = parseFloat(el.getAttribute("y"));
        const nw = Math.max(30, pos.x - x);
        const nh = Math.max(30, pos.y - y);
        
        el.setAttribute("width", nw);
        el.setAttribute("height", nh);

        // ESCALADO ESPECIAL PARA LATEX
        if (el.classList.contains('latex-element')) {
            const container = el.querySelector('.latex-container');
            container.style.fontSize = (nw / 8) + "px";
        }
    }

    function checkCollision(x, y, w, h) {
        const all = document.querySelectorAll('.draggable');
        selectedElements = [];
        all.forEach(el => {
            const b = el.getBBox();
            // Ajustar bbox si tiene transform translate
            let tx = 0, ty = 0;
            const t = el.getAttribute("transform");
            if(t) {
                const m = t.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if(m) { tx = parseFloat(m[1]); ty = parseFloat(m[2]); }
            }
            
            const ex = (parseFloat(el.getAttribute('x')) || b.x) + tx;
            const ey = (parseFloat(el.getAttribute('y')) || b.y) + ty;

            if (ex < x + w && ex + b.width > x && ey < y + h && ey + b.height > y) {
                el.classList.add('element-highlight');
                selectedElements.push(el);
            } else {
                el.classList.remove('element-highlight');
            }
        });
    }

    function updateSelectionUI() {
        const oldHandles = layers.ui.querySelectorAll('.resize-handle, .selection-rect');
        oldHandles.forEach(h => h.remove());

        if (selectedElements.length === 1) {
            const el = selectedElements[0];
            const b = el.getBBox();
            let tx = 0, ty = 0;
            const t = el.getAttribute("transform");
            if(t) {
                const m = t.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if(m) { tx = parseFloat(m[1]); ty = parseFloat(m[2]); }
            }
            const ex = (parseFloat(el.getAttribute('x')) || b.x) + tx;
            const ey = (parseFloat(el.getAttribute('y')) || b.y) + ty;

            // Handle de redimensión (solo para img y latex)
            if (el.tagName === 'image' || el.tagName === 'foreignObject') {
                const h = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                h.setAttribute("x", ex + b.width - 5);
                h.setAttribute("y", ey + b.height - 5);
                h.setAttribute("width", 12); h.setAttribute("height", 12);
                h.setAttribute("class", "resize-handle");
                layers.ui.appendChild(h);
            }
        }
    }

    function selectElement(el) {
        selectedElements = [el];
        el.classList.add('element-highlight');
        updateSelectionUI();
    }

    function deselect() {
        selectedElements.forEach(el => el.classList.remove('element-highlight'));
        selectedElements = [];
        updateSelectionUI();
    }

    /* =========================================
       SECCIÓN: FUNCIONES DE APOYO
    ========================================= */
function showLatexPanel() { 
    editingEl = null; // Resetear edición
    document.getElementById('latex-val').value = ''; // Limpiar input
    document.getElementById('latex-panel').style.display = 'block'; 
}
    function hideLatexPanel() { 
    document.getElementById('latex-panel').style.display = 'none'; 
    editingEl = null; // Resetear para que la próxima vez sea una nueva si se usa el botón Σ
}

function addLatex() {
    const val = document.getElementById('latex-val').value;
    if (!val) return;
    saveHistory();

    if (editingEl) {
        // MODO EDICIÓN: Actualizamos el elemento que ya existe
        editingEl.setAttribute("data-raw", val);
        const container = editingEl.querySelector('.latex-container');
        container.innerHTML = `\\[${val}\\]`;
    } else {
        // MODO CREACIÓN: Creamos uno nuevo
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("x", 150); fo.setAttribute("y", 150);
        fo.setAttribute("width", 180); fo.setAttribute("height", 100);
        fo.setAttribute("class", "latex-element draggable");
        fo.setAttribute("data-raw", val); 
        
        fo.innerHTML = `<div xmlns="http://www.w3.org/1999/xhtml" class="latex-container">\\[${val}\\]</div>`;
        layers.latex.appendChild(fo);
    }
    
    MathJax.typeset();
    hideLatexPanel();
    editingEl = null;
}

    function uploadImage(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = (ev) => {
            saveHistory();
            const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
            img.setAttribute("href", ev.target.result);
            img.setAttribute("x", 100); img.setAttribute("y", 100);
            img.setAttribute("width", 200); img.setAttribute("height", 150);
            img.setAttribute("class", "draggable");
            img.setAttribute("preserveAspectRatio", "none");
            layers.img.appendChild(img);
        };
        r.readAsDataURL(f);
    }

  function saveHistory() {
    // Al realizar una acción nueva, el historial de "rehacer" debe limpiarse
    redoHistory = []; 
    history.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
}

function undo() {
    if (history.length === 0) return;
    // Guardamos el estado actual en rehacer antes de volver atrás
    redoHistory.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
    
    const last = history.pop();
    layers.draw.innerHTML = last.draw;
    layers.latex.innerHTML = last.latex;
    layers.img.innerHTML = last.img;
    deselect();
}

function redo() {
    if (redoHistory.length === 0) return;
    // Guardamos el estado actual en el historial normal
    history.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
    
    const next = redoHistory.pop();
    layers.draw.innerHTML = next.draw;
    layers.latex.innerHTML = next.latex;
    layers.img.innerHTML = next.img;
    deselect();
}

   function toggleFullScreen() {
    // Verificamos si ya estamos en pantalla completa
    if (!document.fullscreenElement) {
        // Si no estamos, solicitamos entrar
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Error al intentar activar pantalla completa: ${err.message}`);
        });
    } else {
        // Si ya estamos, salimos de ella
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

    svg.addEventListener('dblclick', (e) => {
    // Buscamos si el doble clic fue en una fórmula de LaTeX
    const targetLatex = e.target.closest('.latex-element');
    
    if (targetLatex) {
        // 1. Marcamos ESTA fórmula como la que vamos a editar
        editingEl = targetLatex; 
        
        // 2. Recuperamos su texto original guardado en 'data-raw'
        const rawText = targetLatex.getAttribute("data-raw") || "";
        
        // 3. Abrimos el panel con ESE texto cargado
        document.getElementById('latex-val').value = rawText;
        document.getElementById('latex-panel').style.display = 'block';
        document.getElementById('latex-val').focus();
    } else if (mode === 'POLY') {
        currentEl = null; // Cerrar polilínea si no es latex
    }
});


    function copyElements() {
    if (selectedElements.length === 0) return;
    // Guardamos clones de los elementos seleccionados
    clipboard = selectedElements.map(el => el.cloneNode(true));
}

function pasteElements() {
    if (clipboard.length === 0) return;
    saveHistory();
    deselect();
    
    clipboard.forEach(clone => {
        const newEl = clone.cloneNode(true);
        // Movemos el pegado un poco para que no quede encima del original
        moveElement(newEl, 25, 25); 
        
        // Insertar en la capa correspondiente
        if (newEl.tagName === 'image') layers.img.appendChild(newEl);
        else if (newEl.tagName === 'foreignObject') layers.latex.appendChild(newEl);
        else layers.draw.appendChild(newEl);
        
        selectedElements.push(newEl);
        newEl.classList.add('element-highlight');
    });
    updateSelectionUI();
}

function deleteSelected() {
    if (selectedElements.length === 0) return;
    saveHistory();
    selectedElements.forEach(el => el.remove());
    selectedElements = [];
    updateSelectionUI();
}

     /* =========================================
   SECCIÓN: TECLADO (Atajos de sistema)
========================================= */
window.addEventListener('keydown', (e) => {
    // Si el foco está en un input, no hacemos nada para no romper la escritura
    if (document.activeElement.tagName === 'INPUT') return;

    // --- DESHACER: Ctrl + Z ---
    if (e.ctrlKey && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        undo();
    }

    // --- REHACER: Ctrl + Y ---
    if (e.ctrlKey && e.key.toLowerCase() === 'y') {
        e.preventDefault();
        redo();
    }

    // --- BORRAR: Backspace o Delete ---
    if (e.key === 'Backspace' || e.key === 'Delete') {
        deleteSelected();
    }

    // --- COPIAR: Ctrl + C ---
    if (e.ctrlKey && e.key.toLowerCase() === 'c') {
        e.preventDefault();
        copyElements();
    }

    // --- PEGAR: Ctrl + V ---
    if (e.ctrlKey && e.key.toLowerCase() === 'v') {
        e.preventDefault();
        pasteElements();
    }
});

    function switchTab(tabName) {
    // Quitar 'active' de todos los botones de la pestaña
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // Poner 'active' al que tocamos
    event.target.classList.add('active');
    
    // Aquí podrías mostrar u ocultar contenido según la pestaña
    console.log("Cambiando a: " + tabName);
}

    const menus = {
    "Principales": [
        {n: 'Suma', s: '+', i: '+'},
        {n: 'Raiz', s: '\\sqrt{x}', i: '√'},
        {n: 'Fracción', s: '\\frac{a}{b}', i: '÷'}
    ],


    "formulas":  [
        {n: 'Cuadrática', s: 'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}', i: 'f(x)'}
    ],
        
    "Letras Griegas": [
       {n: 'Alpha', s: '\\alpha', i: 'α'},
            {n: 'Beta', s: '\\beta', i: 'β'},
          
    ],
    "Flechas": [{n: 'Derecha', s: '\\rightarrow', i: '→'}],
    "Lógica": [{n: 'Para todo', s: '\\forall', i: '∀'}],
    "Desigualdades": [{n: 'Menor igual', s: '\\leq', i: '≤'}],
    "Cálculo": [{n: 'Integral', s: '\\int', i: '∫'}],
    "Conjuntos": [{n: 'Pertenece', s: '\\in', i: '∈'}],
    "Matrices/Sist": [{n: 'Matriz 2x2', s: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', i: '[M]'}],
    "Paréntesis": [{n: 'Llaves', s: '\\{x\\}', i: '{x}'}],
    "Otros": [{n: 'Infinito', s: '\\infty', i: '∞'}]
};

function toggleSymbolsPanel() {
    const panel = document.getElementById('symbols-side-panel');
    // Si no tiene estilo asignado o es 'none', lo ponemos en 'flex'
    const isVisible = panel.style.display === 'flex';
    panel.style.display = isVisible ? 'none' : 'flex';
    
    if (!isVisible) renderCategory('Principales');
}

function renderCategory(cat) {
    const grid = document.getElementById('symbols-grid');
    grid.innerHTML = '';
    
    // Actualizar estado visual de los botones de categoría
    document.querySelectorAll('.cat-btn').forEach(b => {
        b.classList.remove('active');
        if(b.innerText === cat || (cat === 'Letras Griegas' && b.innerText === 'Griegas')) {
            b.classList.add('active');
        }
    });

    // Cargar los símbolos de la categoría seleccionada
    menus[cat].forEach(sym => {
        const div = document.createElement('div');
        div.className = 'sym-card';
        div.innerHTML = `
            <div class="sym-card-icon">${sym.i}</div>
            <span>${sym.n}</span>
        `;
        div.onclick = () => insertSymbol(sym.s);
        grid.appendChild(div);
    });
}

function insertSymbol(latex) {
    saveHistory();
    const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
    fo.setAttribute("x", 200); 
    fo.setAttribute("y", 200);
    fo.setAttribute("width", 150); 
    fo.setAttribute("height", 80);
    fo.setAttribute("class", "latex-element draggable");
    fo.setAttribute("data-raw", latex); 
    
    fo.innerHTML = `<div xmlns="http://www.w3.org/1999/xhtml" class="latex-container">\\[${latex}\\]</div>`;
    layers.latex.appendChild(fo);
    
    MathJax.typeset(); 
}

    function drawCartesian(group, x, y, w, h) {
    group.innerHTML = ''; 
    group.setAttribute("class", "cartesian-element draggable");
    // Guardamos las coordenadas en atributos de datos porque <g> no usa x,y,w,h
    group.setAttribute("data-x", x);
    group.setAttribute("data-y", y);
    group.setAttribute("data-w", w);
    group.setAttribute("data-h", h);

    const centerX = x + w/2;
    const centerY = y + h/2;
    const step = 30; 

    // Fondo para detectar clics
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x); rect.setAttribute("y", y);
    rect.setAttribute("width", w); rect.setAttribute("height", h);
    rect.setAttribute("fill", "transparent");
    rect.style.pointerEvents = "all";
    group.appendChild(rect);

    const lineAttr = "stroke='black' stroke-width='1' vector-effect='non-scaling-stroke'";
    let html = `<line x1='${x}' y1='${centerY}' x2='${x+w}' y2='${centerY}' ${lineAttr} />`;
    html += `<line x1='${centerX}' y1='${y}' x2='${centerX}' y2='${y+h}' ${lineAttr} />`;

    // Ticks simplificados
    for(let i = step; i < w/2; i += step) {
        html += `<line x1='${centerX+i}' y1='${centerY-5}' x2='${centerX+i}' y2='${centerY+5}' ${lineAttr} />`;
        html += `<line x1='${centerX-i}' y1='${centerY-5}' x2='${centerX-i}' y2='${centerY+5}' ${lineAttr} />`;
    }
    for(let i = step; i < h/2; i += step) {
        html += `<line x1='${centerX-5}' y1='${centerY+i}' x2='${centerX+5}' y2='${centerY+i}' ${lineAttr} />`;
        html += `<line x1='${centerX-5}' y1='${centerY-i}' x2='${centerX+5}' y2='${centerY-i}' ${lineAttr} />`;
    }
    group.insertAdjacentHTML('beforeend', html);
}

// --- LÓGICA DE VISTA PREVIA EN VIVO ---
function updateLivePreview() {
    const val = document.getElementById('latex-val').value;
    const preview = document.getElementById('preview-content');
    if (!val) {
        preview.innerHTML = "Vista...";
        return;
    }
    preview.innerHTML = `\\[${val}\\]`;
    // Renderiza solo el visor 
    MathJax.typesetPromise([preview]);
}

// --- LÓGICA PARA HACER EL PANEL MOVIBLE ---
function makeDraggable(el, handle) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    handle.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        // Quitamos el transform de centrado para que no interfiera con el arrastre
        el.style.transform = "none"; 
        el.style.top = (el.offsetTop - pos2) + "px";
        el.style.left = (el.offsetLeft - pos1) + "px";
        el.style.bottom = "auto"; // Anulamos el bottom fijo al mover
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

// Inicializamos el movimiento al cargar el panel
const lp = document.getElementById('latex-panel');
const lh = document.getElementById('latex-drag-handle');
makeDraggable(lp, lh);

// Modificamos tu función existente para resetear la vista previa al abrir [cite: 173]
function showLatexPanel() {
    editingEl = null;
    document.getElementById('latex-val').value = '';
    document.getElementById('preview-content').innerHTML = "Vista...";
    document.getElementById('latex-panel').style.display = 'flex'; // Cambiado a flex para el visor
}
    

// --- FUNCIONES DE INTERFAZ Y DESCARGA ---

// Esta función permite mostrar mensajes sin ventanas emergentes
function showMessage(text) {
    const msg = document.getElementById("status-msg");
    if (!msg) return;
    msg.innerText = text;
    msg.classList.remove("show");
    void msg.offsetWidth; // Reinicia la animación
    msg.classList.add("show");
}

function toggleDownloadMenu() {
    const menu = document.getElementById("download-menu");
    if (menu) menu.classList.toggle("show-menu");
}

// Cerrar menú si haces clic fuera
window.addEventListener('click', function(event) {
    if (!event.target.matches('.btn-mini') && !event.target.closest('.dropdown')) {
        const dropdowns = document.getElementsByClassName("dropdown-content");
        for (let i = 0; i < dropdowns.length; i++) {
            dropdowns[i].classList.remove('show-menu');
        }
    }
});

async function downloadBoard(format) {
    const menu = document.getElementById("download-menu");
    if (menu) menu.classList.remove("show-menu");

    const board = document.getElementById('canvas-container'); 
    if (!board) {
        showMessage(" Error: No se encontró el área de dibujo.");
        return;
    }

    showMessage(" Generando archivo...");

    try {
        const canvas = await html2canvas(board, {
            scale: 2, 
            useCORS: true, 
            backgroundColor: "#ffffff",
            logging: false
        });

        if (format === 'png') {
            const link = document.createElement('a');
            link.download = `tablero-${Date.now()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            showMessage(" PNG descargado");
        } 
        else if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const imgData = canvas.toDataURL('image/png');
            const orientation = canvas.width > canvas.height ? 'l' : 'p';
            
            const pdf = new jsPDF({
                orientation: orientation,
                unit: 'px',
                format: [canvas.width, canvas.height]
            });

            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`tablero-${Date.now()}.pdf`);
            showMessage(" PDF descargado");
        }
    } catch (err) {
        console.error("Error:", err);
        showMessage(" Error al descargar.");
    }
}

    // Función para abrir/cerrar el panel de figuras
function toggleFiguresPanel() {
    const figPanel = document.getElementById('figures-side-panel');
    const symPanel = document.getElementById('symbols-side-panel');
    
    // Cerrar el panel de símbolos si está abierto
    if (symPanel) symPanel.style.display = 'none';
    
    // Alternar visibilidad
    const isVisible = figPanel.style.display === 'flex';
    figPanel.style.display = isVisible ? 'none' : 'flex';
}

// Función para seleccionar la figura y cerrar el panel
function selectFigure(mode) {
    setMode(mode); // Activa la herramienta (RECT, CIRCLE, etc.)
    toggleFiguresPanel(); // Cierra el panel
}

    function drawCube(x, y, s) {
    const offset = s * 0.4;
    return `M ${x} ${y} h ${s} v ${s} h ${-s} Z 
            M ${x+offset} ${y-offset} h ${s} v ${s} h ${-s} Z 
            M ${x} ${y} L ${x+offset} ${y-offset} 
            M ${x+s} ${y} L ${x+s+offset} ${y-offset} 
            M ${x} ${y+s} L ${x+offset} ${y+s-offset} 
            M ${x+s} ${y+s} L ${x+s+offset} ${y+s-offset}`;
}

function drawSphere(x, y, r) {
    return `M ${x-r} ${y} a ${r} ${r} 0 1 0 ${r*2} 0 a ${r} ${r} 0 1 0 ${-r*2} 0 
            M ${x-r} ${y} a ${r} ${r/3} 0 1 0 ${r*2} 0 a ${r} ${r/3} 0 1 0 ${-r*2} 0`;
}


    function drawCylinder(x, y, w, h) {
    const rh = h * 0.15; // Altura de la elipse de la tapa
    return `M ${x} ${y+rh} L ${x} ${y+h-rh} 
            A ${w/2} ${rh} 0 1 0 ${x+w} ${y+h-rh} 
            L ${x+w} ${y+rh} 
            A ${w/2} ${rh} 0 1 0 ${x} ${y+rh} 
            A ${w/2} ${rh} 0 1 0 ${x+w} ${y+rh}`;
}

    // 1. Mostrar/Ocultar el panel
function showGraphPanel() {
    document.getElementById('graph-panel').style.display = 'flex';
    document.getElementById('graph-exp').focus();
}
function hideGraphPanel() {
    document.getElementById('graph-panel').style.display = 'none';
}

// 2. Insertar símbolos en el input
function addGraphSymbol(sym) {
    const input = document.getElementById('graph-exp');
    input.value += sym;
    input.focus();
    updateGraphLivePreview();
}

// 3. Traductor de funciones (sen -> sin, ^ -> **)
function cleanFormula(f) {
    return f.toLowerCase()
        .replace(/sen/g, "sin")
        .replace(/\^/g, "**")
        .replace(/ln/g, "log");
}

// 4. Previsualización en tiempo real
document.getElementById('graph-exp').addEventListener('input', updateGraphLivePreview);

function updateGraphLivePreview() {
    const exp = document.getElementById('graph-exp').value;
    if(!exp) return;
    try {
        functionPlot({
            target: '#graph-live-preview',
            width: 120, height: 120,
            disableZoom: true,
            data: [{ fn: cleanFormula(exp), color: 'black' }]
        });
    } catch(e) {}
}

    function insertGraphOnBoard() {
    const exp = document.getElementById('graph-exp').value;
    if(!exp) return;

    const id = 'g' + Date.now();
    const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
    
    fo.setAttribute("x", 100); 
    fo.setAttribute("y", 100);
    fo.setAttribute("width", "350"); 
    fo.setAttribute("height", "350");
    fo.classList.add('drawing-element', 'draggable', 'graph-wrapper'); 

    const div = document.createElement("div");
    div.id = id;
    div.className = "graph-widget-container";
    div.style.width = "100%"; 
    div.style.height = "100%";
    div.style.position = "relative"; // Para que el PIN se ubique bien

    // --- BOTÓN PIN ---
    const pinBtn = document.createElement("div");
    pinBtn.className = "pin-button";
    pinBtn.innerHTML = `<i data-lucide="pin"></i>`;
    pinBtn.title = "Fijar gráfica";
    div.dataset.pinned = "false";
    
    pinBtn.onclick = (e) => {
        e.stopPropagation();
        toggleGraphPin(id, exp, div, pinBtn);
    };
    div.appendChild(pinBtn);
    // -----------------

    fo.appendChild(div);
    layers.draw.appendChild(fo);

    const render = (w, h) => {
        const isPinned = div.dataset.pinned === "true";
        try {
            functionPlot({
                target: `#${id}`,
                width: w,
                height: h,
                grid: true,
                disableZoom: isPinned,
                disablePan: isPinned,
                data: [{ 
                    fn: cleanFormula(exp), 
                    color: 'black' 
                }]
            });
            if(window.lucide) lucide.createIcons();
        } catch (e) { console.error("Error:", e); }
    };

    render(350, 350);

    let timeout;
    const ro = new ResizeObserver(entries => {
        for (let entry of entries) {
            const { width, height } = entry.contentRect;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                fo.setAttribute("width", width);
                fo.setAttribute("height", height);
                render(width, height);
            }, 50);
        }
    });
    
    ro.observe(fo);

    hideGraphPanel();
    if(typeof saveHistory === 'function') saveHistory();
}



// Modificar tu función setMode existente para que abra el panel
const oldSetMode = setMode;
window.setMode = function(m) {
    oldSetMode(m);
    if(m === 'GRAPH') showGraphPanel();
    
    // Bloquear interacción con gráficas si NO estamos en SELECT
    const graphs = document.querySelectorAll('foreignObject');
    graphs.forEach(g => {
        g.style.pointerEvents = (m === 'SELECT') ? 'all' : 'none';
    });
};


    
    function toggleGraphPin(id, exp, container, btn) {
    const isPinned = container.dataset.pinned === "true";
    const newState = !isPinned;
    
    // Guardamos el nuevo estado
    container.dataset.pinned = newState.toString();
    
    // Cambiamos el icono y color
    btn.classList.toggle('pinned', newState);
    btn.innerHTML = newState ? `<i data-lucide="pin-off"></i>` : `<i data-lucide="pin"></i>`;
    
    // Re-renderizamos con las dimensiones actuales
    const rect = container.getBoundingClientRect();
    functionPlot({
        target: `#${id}`,
        width: rect.width,
        height: rect.height,
        grid: true,
        disableZoom: newState,
        disablePan: newState,
        data: [{ fn: cleanFormula(exp), color: 'black' }]
    });
    
}        
    lucide.createIcons(); 
    
</script>

    <div id="status-msg" style="position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 50px; font-size: 13px; display: none; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"></div>

</body>
</html>
