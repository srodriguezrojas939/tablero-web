<!DOCTYPE html>
<html lang="es">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tablero v1</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
    :root {
        --bg: #FFFFFF;
        --panel: #F8F9FA;
        --border: #E5E5E5;
        --dark: #000000;
        --accent: #007BFF;
        --pill-bg: #EAEAEA;
        --selection: rgba(0, 123, 255, 0.15);
    }

    body {
        margin: 0; padding: 0; 
        font-family: 'Open Sans', sans-serif; 
        background: var(--bg); 
        color: #333;
        height: 100vh; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
    }

    /* --- ENCABEZADO (Playfair Display) --- */
    header { 
        padding: 20px 30px; 
        border-bottom: 1px solid var(--border); 
        background: white; 
        display: flex;
        align-items: baseline;
        gap: 15px;
    }

    header h1 { 
        font-family: 'Playfair Display', serif; 
        font-weight: 800; 
        font-size: 32px; 
        margin: 0; 
        color: var(--dark);
        letter-spacing: -0.5px;
    }

    .subtitle {
        font-family: 'Playfair Display', serif;
        font-weight: 400;
        font-size: 20px;
        color: #666;
        font-style: normal;
    }

    /* --- SELECTOR DE PESTAÃ‘AS (Estilo Pill de la imagen) --- */
    .segmented-control {
        display: flex;
        background: var(--pill-bg);
        padding: 5px;
        border-radius: 50px;
        width: fit-content;
        margin: 15px auto;
        border: 1px solid #DBDBDB;
    }

    .tab-btn {
        border: none;
        background: transparent;
        padding: 8px 30px;
        border-radius: 50px;
        font-family: 'Open Sans', sans-serif;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #666;
    }

    .tab-btn.active {
        background: white;
        color: black;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* --- BARRA DE HERRAMIENTAS Y BOTONES (Open Sans) --- */
    .toolbar {
        display: flex; 
        justify-content: center; 
        gap: 10px; 
        padding: 12px;
        background: white; 
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }

  /* Botones de la barra de herramientas */
.btn {
    font-family: 'Open Sans', sans-serif;
    background: white; 
    border: 1px solid var(--border); 
    padding: 8px 22px; /* Un poco mÃ¡s de aire a los lados */
    border-radius: 99px; /* <--- ESTO los hace totalmente redondos */
    font-size: 12px; 
    font-weight: 600; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer; 
    transition: 0.2s;
    color: #444;
}

/* PestaÃ±as del selector (Ya estaban en 50px, pero 99px asegura el efecto) */
.segmented-control, .tab-btn {
    border-radius: 99px; 
}

    /* --- LA PASTILLA GRIS (Segmented Control) --- */
    .segmented-control {
        display: flex;
        background: var(--pill-bg); /* Fondo gris que abarca todo */
        padding: 4px;
        border-radius: 99px; /* Redondeado total */
        width: fit-content;
        margin: 10px auto 20px auto;
        border: none; /* Sin bordes, solo el fondo gris */
    }
    
    .btn:hover { 
        background: #F0F0F0; 
        border-color: #BBB;
    }

    .btn.active { 
        background: var(--dark); 
        color: white; 
        border-color: var(--dark);
    }

    .divider { width: 1px; background: var(--border); margin: 0 10px; }

    /* --- ÃREA DE TRABAJO --- */
    #viewport { flex-grow: 1; position: relative; touch-action: none; background: white; }
    svg { width: 100%; height: 100%; display: block; }
    .grid { fill: url(#gridPattern); }
    
    /* --- ELEMENTOS DEL TABLERO --- */
    .drawing-element { fill: none; stroke: black; stroke-width: 2; stroke-linecap: round; pointer-events: all; }
    .latex-element { cursor: move; display: flex; align-items: center; justify-content: center; overflow: visible; }
    .latex-container { 
        width: 100%; height: 100%; display: flex; align-items: center; 
        justify-content: center; font-size: 20px; transition: font-size 0.1s;
    }
    
    /* --- SELECTOR Y UI --- */
    .selection-marquee { fill: var(--selection); stroke: var(--accent); stroke-dasharray: 4; pointer-events: none; }
    .element-highlight { stroke: var(--accent) !important; stroke-width: 3 !important; }
    .resize-handle { fill: white; stroke: var(--accent); stroke-width: 2; cursor: nwse-resize; }

    /* --- PANEL MODAL LATEX --- */
    #latex-panel {
        position: absolute; 
        top: 50%; left: 50%; 
        transform: translate(-50%, -50%);
        background: white; 
        padding: 25px; 
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15); 
        display: none; 
        z-index: 1000;
        min-width: 400px;
    }

    #latex-panel h3 {
        margin-top: 0;
        font-family: 'Playfair Display', serif;
        font-size: 22px;
    }

    #latex-val {
        font-family: 'Open Sans', sans-serif;
        border: 1px solid var(--border);
        border-radius: 6px;
        outline: none;
    }

    #latex-val:focus {
        border-color: var(--accent);
    }


/* PANEL LATERAL FIJO (SOBRE EL TABLERO) */
#symbols-side-panel {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 300px;
    background: white;
    border-left: 1px solid var(--border);
    box-shadow: -5px 0 15px rgba(0,0,0,0.05);
    display: none; /* Se controla con JS */
    flex-direction: column;
    z-index: 1000;
}


/* Cabecera con botÃ³n X */
.panel-header {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.panel-header h3 {
    margin: 0;
    font-family: 'Playfair Display', serif;
    font-size: 20px;
}

.close-panel-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    line-height: 1;
}
.close-panel-btn:hover { color: black; }

/* SecciÃ³n de categorÃ­as (Scroll Vertical) */
.symbol-categories {
    display: flex;
    flex-direction: column;
    padding: 10px;
    gap: 5px;
    max-height: 250px; /* Limita el alto de las categorÃ­as */
    overflow-y: auto;
    background: #fcfcfc;
    border-bottom: 1px solid #eee;
}

.cat-btn {
    text-align: left;
    padding: 10px 15px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    color: #555;
}

.cat-btn.active {
    background: var(--dark);
    color: white;
    font-weight: 600;
}

/* SecciÃ³n de sÃ­mbolos (Scroll Vertical) */
#symbols-grid {
    flex-grow: 1;
    overflow-y: auto; /* Permite scroll en los sÃ­mbolos */
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Tarjetas de sÃ­mbolos (Horizontales) */
.sym-card {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: white;
    border: 1px solid #efefef;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.2s;
    gap: 15px;
}

.sym-card:hover {
    border-color: var(--accent);
    background: #f0f7ff;
}

.sym-card-icon {
    font-size: 20px;
    min-width: 35px;
    text-align: center;
}

.sym-card span {
    font-size: 12px;
    color: #777;
    font-weight: 600;
}
    
    
</style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span class="subtitle">âˆš(Raiz) CuadradaÂ²</span>
</header>

<div class="toolbar">
    <button class="btn active" id="btn-PENCIL" onclick="setMode('PENCIL')">ðŸ–‰</button>
    <button class="btn" id="btn-POLY" onclick="setMode('POLY')">ð–¡¬</button>
    <button class="btn" id="btn-RECT" onclick="setMode('RECT')">â–¡</button>
    <button class="btn" id="btn-CIRCLE" onclick="setMode('CIRCLE')">â—Ž</button>
    <button class="btn" id="btn-TRI" onclick="setMode('TRI')">âŠ¿</button>
    <button class="btn" id="btn-COORD" onclick="setMode('COORD')">âŒ–</button>
    <button class="btn" id="btn-SELECT" onclick="setMode('SELECT')">Selector â¬š </button>
    <div class="divider"></div>
    <button class="btn" onclick="document.getElementById('img-up').click()"> ðŸ—Ž Imagen </button>
    <button class="btn" onclick="showLatexPanel()">Î£ Latex</button>
    <button class="btn" id="btn-SYMBOLS" onclick="toggleSymbolsPanel()">Î© Simbolos </button>
    <div class="divider"></div>
    <button class="btn" onclick="undo()">â†¶</button>
    <button class="btn" onclick="redo()">â†·</button>
    <button class="btn" onclick="clearAll()" style="color:red">â¨¯</button>
</div>

    

<div id="viewport" style="display: flex; flex-direction: row; position: relative; flex-grow: 1;">
    
    <div id="canvas-container" style="flex-grow: 1; position: relative; overflow: hidden; display: flex; flex-direction: column;">
        
        <div id="latex-panel">
            <h3>Insertar LaTeX</h3>
            <input type="text" id="latex-val" style="width:100%; padding:10px;" placeholder="\frac{a}{b^2}">
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn active" onclick="addLatex()">INSERTAR</button>
                <button class="btn" onclick="hideLatexPanel()">CANCELAR</button>
            </div>
        </div>

        <svg id="canvas">
            <defs>
                <pattern id="gridPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#EEEEEE" stroke-width="1"/>
                </pattern>
            </defs>
            <rect class="grid" width="100%" height="100%" />
            <g id="layer-images"></g>
            <g id="layer-latex"></g>
            <g id="layer-drawings"></g>
            <g id="layer-ui"></g>
        </svg>
    </div> <div id="symbols-side-panel">
        <div class="panel-header">
            <h3>SÃ­mbolos</h3>
            <button onclick="toggleSymbolsPanel()" class="close-panel-btn">&times;</button>
        </div>
        
        <div class="symbol-categories">
            <button onclick="renderCategory('Principales')" class="cat-btn active">Principales</button>
            <button onclick="renderCategory('Letras Griegas')" class="cat-btn">Griegas</button>
            <button onclick="renderCategory('Flechas')" class="cat-btn">Flechas</button>
            <button onclick="renderCategory('LÃ³gica')" class="cat-btn">LÃ³gica</button>
            <button onclick="renderCategory('formulas')" class="cat-btn">FÃ³rmulas</button>
            <button onclick="renderCategory('Desigualdades')" class="cat-btn">Desigualdades</button>
            <button onclick="renderCategory('CÃ¡lculo')" class="cat-btn">CÃ¡lculo</button>
            <button onclick="renderCategory('Conjuntos')" class="cat-btn">Conjuntos</button>
            <button onclick="renderCategory('Matrices/Sist')" class="cat-btn">Matrices</button>
            <button onclick="renderCategory('ParÃ©ntesis')" class="cat-btn">ParÃ©ntesis</button>
            <button onclick="renderCategory('Otros')" class="cat-btn">Otros</button>
        </div>

        <div id="symbols-grid">
            </div>
    </div> </div>
    
    
<input type="file" id="img-up" hidden onchange="uploadImage(event)">

<script>
    /* =========================================
       SECCIÃ“N: ESTADO GLOBAL
    ========================================= */
    let mode = 'PENCIL';
    let isAction = false;
    let startPos = { x: 0, y: 0 };
    let currentEl = null;
    let selectedElements = [];
    let history = [];
    let redoHistory = []; 
let clipboard = [];
    let isResizing = false;

    const svg = document.getElementById('canvas');
    const layers = {
        img: document.getElementById('layer-images'),
        latex: document.getElementById('layer-latex'),
        draw: document.getElementById('layer-drawings'),
        ui: document.getElementById('layer-ui')
    };

    let editingEl = null; // Para saber si estamos creando uno nuevo o editando

    /* =========================================
       SECCIÃ“N: MOTOR DE EVENTOS (MOUSE / TOUCH)
    ========================================= */
    svg.addEventListener('pointerdown', onStart);
    svg.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onEnd);

    function getPos(e) {
        const r = svg.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        deselect();
    }

    /* =========================================
       SECCIÃ“N: LÃ“GICA DE SELECCIÃ“N (EL SELECTOR)
    ========================================= */
    function onStart(e) {
        const pos = getPos(e);
        startPos = pos;
        isAction = true;

        if (mode === 'SELECT') {
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                return;
            }

            const hit = e.target.closest('.draggable');
            if (hit && !e.shiftKey) {
                if (!selectedElements.includes(hit)) {
                    deselect();
                    selectElement(hit);
                }
            } else if (!hit) {
                deselect();
                currentEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                currentEl.setAttribute("class", "selection-marquee");
                layers.ui.appendChild(currentEl);
            }
            return;
        }

        if (mode === 'PENCIL') {
            saveHistory();
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentEl.setAttribute("d", `M ${pos.x} ${pos.y}`);
            currentEl.setAttribute("class", "drawing-element draggable");
            layers.draw.appendChild(currentEl);
        }

        if (mode === 'POLY') {
            if (!currentEl) {
                saveHistory();
                currentEl = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                currentEl.setAttribute("points", `${pos.x},${pos.y}`);
                currentEl.setAttribute("class", "drawing-element draggable");
                layers.draw.appendChild(currentEl);
            } else {
                let pts = currentEl.getAttribute("points");
                currentEl.setAttribute("points", `${pts} ${pos.x},${pos.y}`);
            }
        }

        if (['RECT', 'CIRCLE', 'TRI', 'COORD'].includes(mode)) {
        saveHistory();
        if (mode === 'RECT') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            currentEl.setAttribute("class", "drawing-element draggable");
        } else if (mode === 'CIRCLE') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            currentEl.setAttribute("class", "drawing-element draggable");
        } else if (mode === 'TRI') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentEl.setAttribute("class", "drawing-element draggable");
        } else if (mode === 'COORD') {
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "g");
            currentEl.setAttribute("class", "draggable coord-system");
        }
        
        currentEl.setAttribute("x", pos.x);
        currentEl.setAttribute("y", pos.y);
        layers.draw.appendChild(currentEl);
    }
    }

    function onMove(e) {
        if (!isAction) return;
        const pos = getPos(e);
        const dx = pos.x - startPos.x;
        const dy = pos.y - startPos.y;

        if (mode === 'SELECT') {
            if (isResizing && selectedElements.length === 1) {
                resizeElement(selectedElements[0], pos);
            } else if (currentEl && currentEl.classList.contains('selection-marquee')) {
                // Dibujar recuadro de selecciÃ³n
                const x = Math.min(startPos.x, pos.x);
                const y = Math.min(startPos.y, pos.y);
                const w = Math.abs(dx);
                const h = Math.abs(dy);
                currentEl.setAttribute("x", x);
                currentEl.setAttribute("y", y);
                currentEl.setAttribute("width", w);
                currentEl.setAttribute("height", h);
                checkCollision(x, y, w, h);
            } else if (selectedElements.length > 0) {
                // Mover varios a la vez
                selectedElements.forEach(el => moveElement(el, dx, dy));
                startPos = pos;
            }
            updateSelectionUI();
            return;
        }

        if (mode === 'PENCIL' && currentEl) {
            let d = currentEl.getAttribute("d");
            currentEl.setAttribute("d", `${d} L ${pos.x} ${pos.y}`);
        }

    if (isAction && ['RECT', 'CIRCLE', 'TRI', 'COORD'].includes(mode) && currentEl) {
        const w = Math.abs(pos.x - startPos.x);
        const h = Math.abs(pos.y - startPos.y);
        const x = Math.min(pos.x, startPos.x);
        const y = Math.min(pos.y, startPos.y);

        if (mode === 'RECT') {
            currentEl.setAttribute("x", x); currentEl.setAttribute("y", y);
            currentEl.setAttribute("width", w); currentEl.setAttribute("height", h);
        } else if (mode === 'CIRCLE') {
            const r = Math.sqrt(w*w + h*h);
            currentEl.setAttribute("cx", startPos.x);
            currentEl.setAttribute("cy", startPos.y);
            currentEl.setAttribute("r", r);
        } else if (mode === 'TRI') {
            currentEl.setAttribute("d", `M ${startPos.x} ${pos.y} L ${pos.x} ${pos.y} L ${pos.x} ${startPos.y} Z`);
        } else if (mode === 'COORD') {
            currentEl.setAttribute("data-w", w); 
            currentEl.setAttribute("data-h", h);
            drawCartesian(currentEl, x, y, w, h);
        }
    }
    }

    function onEnd() {
        if (mode === 'SELECT') {
            if (currentEl) currentEl.remove();
            currentEl = null;
        }
        if (mode === 'PENCIL') currentEl = null;
        isAction = false;
        isResizing = false;
    }

    /* =========================================
       SECCIÃ“N: TRANSFORMACIONES (MOVER / ESCALAR)
    ========================================= */
    function moveElement(el, dx, dy) {
        if (el.tagName === 'path' || el.tagName === 'polyline') {
            const bbox = el.getBBox();
            const transform = el.getAttribute("transform") || "translate(0,0)";
            const parts = transform.split(/[() ,]+/);
            const tx = (parseFloat(parts[1]) || 0) + dx;
            const ty = (parseFloat(parts[2]) || 0) + dy;
            el.setAttribute("transform", `translate(${tx},${ty})`);
        } else {
            el.setAttribute("x", parseFloat(el.getAttribute("x")) + dx);
            el.setAttribute("y", parseFloat(el.getAttribute("y")) + dy);
        }
    }

    function resizeElement(el, pos) {
        const x = parseFloat(el.getAttribute("x"));
        const y = parseFloat(el.getAttribute("y"));
        const nw = Math.max(30, pos.x - x);
        const nh = Math.max(30, pos.y - y);
        
        el.setAttribute("width", nw);
        el.setAttribute("height", nh);

        // ESCALADO ESPECIAL PARA LATEX
        if (el.classList.contains('latex-element')) {
            const container = el.querySelector('.latex-container');
            container.style.fontSize = (nw / 8) + "px";
        }
    }

    function checkCollision(x, y, w, h) {
        const all = document.querySelectorAll('.draggable');
        selectedElements = [];
        all.forEach(el => {
            const b = el.getBBox();
            // Ajustar bbox si tiene transform translate
            let tx = 0, ty = 0;
            const t = el.getAttribute("transform");
            if(t) {
                const m = t.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if(m) { tx = parseFloat(m[1]); ty = parseFloat(m[2]); }
            }
            
            const ex = (parseFloat(el.getAttribute('x')) || b.x) + tx;
            const ey = (parseFloat(el.getAttribute('y')) || b.y) + ty;

            if (ex < x + w && ex + b.width > x && ey < y + h && ey + b.height > y) {
                el.classList.add('element-highlight');
                selectedElements.push(el);
            } else {
                el.classList.remove('element-highlight');
            }
        });
    }

    function updateSelectionUI() {
        const oldHandles = layers.ui.querySelectorAll('.resize-handle, .selection-rect');
        oldHandles.forEach(h => h.remove());

        if (selectedElements.length === 1) {
            const el = selectedElements[0];
            const b = el.getBBox();
            let tx = 0, ty = 0;
            const t = el.getAttribute("transform");
            if(t) {
                const m = t.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if(m) { tx = parseFloat(m[1]); ty = parseFloat(m[2]); }
            }
            const ex = (parseFloat(el.getAttribute('x')) || b.x) + tx;
            const ey = (parseFloat(el.getAttribute('y')) || b.y) + ty;

            // Handle de redimensiÃ³n (solo para img y latex)
            if (el.tagName === 'image' || el.tagName === 'foreignObject') {
                const h = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                h.setAttribute("x", ex + b.width - 5);
                h.setAttribute("y", ey + b.height - 5);
                h.setAttribute("width", 12); h.setAttribute("height", 12);
                h.setAttribute("class", "resize-handle");
                layers.ui.appendChild(h);
            }
        }
    }

    function selectElement(el) {
        selectedElements = [el];
        el.classList.add('element-highlight');
        updateSelectionUI();
    }

    function deselect() {
        selectedElements.forEach(el => el.classList.remove('element-highlight'));
        selectedElements = [];
        updateSelectionUI();
    }

    /* =========================================
       SECCIÃ“N: FUNCIONES DE APOYO
    ========================================= */
function showLatexPanel() { 
    editingEl = null; // Resetear ediciÃ³n
    document.getElementById('latex-val').value = ''; // Limpiar input
    document.getElementById('latex-panel').style.display = 'block'; 
}
    function hideLatexPanel() { 
    document.getElementById('latex-panel').style.display = 'none'; 
    editingEl = null; // Resetear para que la prÃ³xima vez sea una nueva si se usa el botÃ³n Î£
}

function addLatex() {
    const val = document.getElementById('latex-val').value;
    if (!val) return;
    saveHistory();

    if (editingEl) {
        // MODO EDICIÃ“N: Actualizamos el elemento que ya existe
        editingEl.setAttribute("data-raw", val);
        const container = editingEl.querySelector('.latex-container');
        container.innerHTML = `\\[${val}\\]`;
    } else {
        // MODO CREACIÃ“N: Creamos uno nuevo
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("x", 150); fo.setAttribute("y", 150);
        fo.setAttribute("width", 180); fo.setAttribute("height", 100);
        fo.setAttribute("class", "latex-element draggable");
        fo.setAttribute("data-raw", val); 
        
        fo.innerHTML = `<div xmlns="http://www.w3.org/1999/xhtml" class="latex-container">\\[${val}\\]</div>`;
        layers.latex.appendChild(fo);
    }
    
    MathJax.typeset();
    hideLatexPanel();
    editingEl = null;
}

    function uploadImage(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = (ev) => {
            saveHistory();
            const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
            img.setAttribute("href", ev.target.result);
            img.setAttribute("x", 100); img.setAttribute("y", 100);
            img.setAttribute("width", 200); img.setAttribute("height", 150);
            img.setAttribute("class", "draggable");
            img.setAttribute("preserveAspectRatio", "none");
            layers.img.appendChild(img);
        };
        r.readAsDataURL(f);
    }

  function saveHistory() {
    // Al realizar una acciÃ³n nueva, el historial de "rehacer" debe limpiarse
    redoHistory = []; 
    history.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
}

function undo() {
    if (history.length === 0) return;
    // Guardamos el estado actual en rehacer antes de volver atrÃ¡s
    redoHistory.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
    
    const last = history.pop();
    layers.draw.innerHTML = last.draw;
    layers.latex.innerHTML = last.latex;
    layers.img.innerHTML = last.img;
    deselect();
}

function redo() {
    if (redoHistory.length === 0) return;
    // Guardamos el estado actual en el historial normal
    history.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
    
    const next = redoHistory.pop();
    layers.draw.innerHTML = next.draw;
    layers.latex.innerHTML = next.latex;
    layers.img.innerHTML = next.img;
    deselect();
}

    function clearAll() { if(confirm("Â¿Borrar todo?")) { saveHistory(); layers.draw.innerHTML = ''; layers.latex.innerHTML = ''; layers.img.innerHTML = ''; deselect(); } }

    svg.addEventListener('dblclick', (e) => {
    // Buscamos si el doble clic fue en una fÃ³rmula de LaTeX
    const targetLatex = e.target.closest('.latex-element');
    
    if (targetLatex) {
        // 1. Marcamos ESTA fÃ³rmula como la que vamos a editar
        editingEl = targetLatex; 
        
        // 2. Recuperamos su texto original guardado en 'data-raw'
        const rawText = targetLatex.getAttribute("data-raw") || "";
        
        // 3. Abrimos el panel con ESE texto cargado
        document.getElementById('latex-val').value = rawText;
        document.getElementById('latex-panel').style.display = 'block';
        document.getElementById('latex-val').focus();
    } else if (mode === 'POLY') {
        currentEl = null; // Cerrar polilÃ­nea si no es latex
    }
});


    function copyElements() {
    if (selectedElements.length === 0) return;
    // Guardamos clones de los elementos seleccionados
    clipboard = selectedElements.map(el => el.cloneNode(true));
}

function pasteElements() {
    if (clipboard.length === 0) return;
    saveHistory();
    deselect();
    
    clipboard.forEach(clone => {
        const newEl = clone.cloneNode(true);
        // Movemos el pegado un poco para que no quede encima del original
        moveElement(newEl, 25, 25); 
        
        // Insertar en la capa correspondiente
        if (newEl.tagName === 'image') layers.img.appendChild(newEl);
        else if (newEl.tagName === 'foreignObject') layers.latex.appendChild(newEl);
        else layers.draw.appendChild(newEl);
        
        selectedElements.push(newEl);
        newEl.classList.add('element-highlight');
    });
    updateSelectionUI();
}

function deleteSelected() {
    if (selectedElements.length === 0) return;
    saveHistory();
    selectedElements.forEach(el => el.remove());
    selectedElements = [];
    updateSelectionUI();
}

     /* =========================================
   SECCIÃ“N: TECLADO (Atajos de sistema)
========================================= */
window.addEventListener('keydown', (e) => {
    // Si el foco estÃ¡ en un input, no hacemos nada para no romper la escritura
    if (document.activeElement.tagName === 'INPUT') return;

    // --- DESHACER: Ctrl + Z ---
    if (e.ctrlKey && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        undo();
    }

    // --- REHACER: Ctrl + Y ---
    if (e.ctrlKey && e.key.toLowerCase() === 'y') {
        e.preventDefault();
        redo();
    }

    // --- BORRAR: Backspace o Delete ---
    if (e.key === 'Backspace' || e.key === 'Delete') {
        deleteSelected();
    }

    // --- COPIAR: Ctrl + C ---
    if (e.ctrlKey && e.key.toLowerCase() === 'c') {
        e.preventDefault();
        copyElements();
    }

    // --- PEGAR: Ctrl + V ---
    if (e.ctrlKey && e.key.toLowerCase() === 'v') {
        e.preventDefault();
        pasteElements();
    }
});

    function switchTab(tabName) {
    // Quitar 'active' de todos los botones de la pestaÃ±a
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // Poner 'active' al que tocamos
    event.target.classList.add('active');
    
    // AquÃ­ podrÃ­as mostrar u ocultar contenido segÃºn la pestaÃ±a
    console.log("Cambiando a: " + tabName);
}

    const menus = {
    "Principales": [
        {n: 'Suma', s: '+', i: '+'},
        {n: 'Raiz', s: '\\sqrt{x}', i: 'âˆš'},
        {n: 'FracciÃ³n', s: '\\frac{a}{b}', i: 'Ã·'}
    ],
    "Letras Griegas": [
       {n: 'Alpha', s: '\\alpha', i: 'Î±'},
            {n: 'Beta', s: '\\beta', i: 'Î²'},
            {n: 'Gamma', s: '\\gamma', i: 'Î³'},
            {n: 'Delta', s: '\\delta', i: 'Î´'},
            {n: 'Epsilon', s: '\\epsilon', i: 'Îµ'},
            {n: 'Zeta', s: '\\zeta', i: 'Î¶'},
            {n: 'Theta', s: '\\theta', i: 'Î¸'},
            {n: 'Lambda', s: '\\lambda', i: 'Î»'},
            {n: 'Mu', s: '\\mu', i: 'Î¼'},
            {n: 'Pi', s: '\\pi', i: 'Ï€'},
            {n: 'Rho', s: '\\rho', i: 'Ï'},
            {n: 'Sigma', s: '\\sigma', i: 'Ïƒ'},
            {n: 'Tau', s: '\\tau', i: 'Ï„'},
            {n: 'Phi', s: '\\phi', i: 'Ï†'},
            {n: 'Omega', s: '\\omega', i: 'Ï‰'},
            {n: 'Delta M.', s: '\\Delta', i: 'Î”'},
            {n: 'Sigma M.', s: '\\Sigma', i: 'Î£'},
            {n: 'Omega M.', s: '\\Omega', i: 'Î©'},
            {n: 'Gamma', s: '\\Gamma ', i: 'Î“'},
            {n: 'Theta', s: '\\Theta ', i: 'Î˜'},
            {n: 'Lambda', s: ' \\Lambda ', i: 'Î›'},
            {n: 'Xi', s: '\\Xi ', i: 'Îž'},
            {n: 'Pi', s: '\\Pi ', i: 'Î '},
            {n: 'Upsilon', s: '\\Upsilon ', i: 'Î¥'},
            {n: 'Phi', s: '\\Phi ', i: 'Î¦'},
            {n: 'Psi', s: '\\Psi ', i: 'Î¨'}
    ],
    "Flechas": [{n: 'Derecha', s: '\\rightarrow', i: 'â†’'}],
    "LÃ³gica": [{n: 'Para todo', s: '\\forall', i: 'âˆ€'}],
    "formulas": [{n: 'CuadrÃ¡tica', s: 'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}', i: 'f(x)'}],
    "Desigualdades": [{n: 'Menor igual', s: '\\leq', i: 'â‰¤'}],
    "CÃ¡lculo": [{n: 'Integral', s: '\\int', i: 'âˆ«'}],
    "Conjuntos": [{n: 'Pertenece', s: '\\in', i: 'âˆˆ'}],
    "Matrices/Sist": [{n: 'Matriz 2x2', s: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', i: '[M]'}],
    "ParÃ©ntesis": [{n: 'Llaves', s: '\\{x\\}', i: '{x}'}],
    "Otros": [{n: 'Infinito', s: '\\infty', i: 'âˆž'}]
};

function toggleSymbolsPanel() {
    const panel = document.getElementById('symbols-side-panel');
    // Si no tiene estilo asignado o es 'none', lo ponemos en 'flex'
    const isVisible = panel.style.display === 'flex';
    panel.style.display = isVisible ? 'none' : 'flex';
    
    if (!isVisible) renderCategory('Principales');
}

function renderCategory(cat) {
    const grid = document.getElementById('symbols-grid');
    grid.innerHTML = '';
    
    // Actualizar estado visual de los botones de categorÃ­a
    document.querySelectorAll('.cat-btn').forEach(b => {
        b.classList.remove('active');
        if(b.innerText === cat || (cat === 'Letras Griegas' && b.innerText === 'Griegas')) {
            b.classList.add('active');
        }
    });

    // Cargar los sÃ­mbolos de la categorÃ­a seleccionada
    menus[cat].forEach(sym => {
        const div = document.createElement('div');
        div.className = 'sym-card';
        div.innerHTML = `
            <div class="sym-card-icon">${sym.i}</div>
            <span>${sym.n}</span>
        `;
        div.onclick = () => insertSymbol(sym.s);
        grid.appendChild(div);
    });
}

function insertSymbol(latex) {
    saveHistory();
    const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
    fo.setAttribute("x", 200); 
    fo.setAttribute("y", 200);
    fo.setAttribute("width", 150); 
    fo.setAttribute("height", 80);
    fo.setAttribute("class", "latex-element draggable");
    fo.setAttribute("data-raw", latex); 
    
    fo.innerHTML = `<div xmlns="http://www.w3.org/1999/xhtml" class="latex-container">\\[${latex}\\]</div>`;
    layers.latex.appendChild(fo);
    
    MathJax.typeset(); 
}

    function drawCartesian(group, x, y, w, h) {
    group.innerHTML = ''; // Limpiar para redibujar
    const centerX = x + w/2;
    const centerY = y + h/2;
    const step = 30; // Distancia entre rayitas

    // Fondo invisible para poder agarrarlo con el selector
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x); rect.setAttribute("y", y);
    rect.setAttribute("width", w); rect.setAttribute("height", h);
    rect.setAttribute("fill", "transparent");
    group.appendChild(rect);

    const lineAttr = "stroke='black' stroke-width='1'";
    let html = `<line x1='${x}' y1='${centerY}' x2='${x+w}' y2='${centerY}' ${lineAttr} />`; // Eje X
    html += `<line x1='${centerX}' y1='${y}' x2='${centerX}' y2='${y+h}' ${lineAttr} />`; // Eje Y

    // Rayitas (Ticks)
    for(let i = step; i < w/2; i += step) {
        html += `<line x1='${centerX+i}' y1='${centerY-5}' x2='${centerX+i}' y2='${centerY+5}' ${lineAttr} />`;
        html += `<line x1='${centerX-i}' y1='${centerY-5}' x2='${centerX-i}' y2='${centerY+5}' ${lineAttr} />`;
    }
    for(let i = step; i < h/2; i += step) {
        html += `<line x1='${centerX-5}' y1='${centerY+i}' x2='${centerX+5}' y2='${centerY+i}' ${lineAttr} />`;
        html += `<line x1='${centerX-5}' y1='${centerY-i}' x2='${centerX+5}' y2='${centerY-i}' ${lineAttr} />`;
    }
    group.innerHTML += html;
    
    // Guardar dimensiones para redimensionar despuÃ©s
    group.setAttribute("x", x); group.setAttribute("y", y);
    group.setAttribute("width", w); group.setAttribute("height", h);
}
    
</script>
</body>
</html>
