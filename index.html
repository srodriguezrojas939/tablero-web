<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Pro - Raiz Cuadrada</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F0F2F5;
            --white: #FFFFFF;
            --primary: #1A1A1A;
            --accent: #007AFF;
            --pill-bg: #E4E6EB;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg); }

        /* --- HEADER --- */
        header {
            position: absolute; top: 15px; left: 20px; z-index: 100;
            display: flex; align-items: baseline; gap: 10px; pointer-events: none;
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; color: var(--primary); }
        header span { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--accent); font-weight: bold; }

        /* --- PANEL DE PILDORAS (S√çMBOLOS) --- */
        .symbol-library {
            position: absolute; top: 70px; left: 20px; width: 350px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-radius: 18px; padding: 15px; border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); z-index: 1000;
        }

        .pill-container {
            display: flex; gap: 6px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: none; border-bottom: 1px solid #eee;
        }
        .pill-container::-webkit-scrollbar { display: none; }

        .pill {
            padding: 6px 12px; background: var(--pill-bg); border-radius: 20px;
            font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: 0.2s; border: none; color: #444;
        }
        .pill.active { background: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--primary); }

        .symbol-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px;
            max-height: 150px; overflow-y: auto;
        }
        .symbol-btn {
            background: white; border: 1px solid #eee; border-radius: 10px;
            height: 45px; cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .symbol-btn:hover { border-color: var(--accent); transform: translateY(-2px); }
        .symbol-btn span { font-size: 14px; margin-bottom: 2px; }
        .symbol-btn small { font-size: 8px; text-transform: uppercase; color: #999; }

        /* --- TABLERO --- */
        #board-container { width: 100vw; height: 100vh; position: relative; }
        svg { width: 100%; height: 100%; cursor: crosshair; }

        .draggable-item {
            position: absolute; cursor: move; padding: 10px;
            transition: outline 0.2s; border-radius: 8px;
            transform-origin: center;
        }
        .draggable-item:hover { outline: 2px dashed var(--accent); }

        /* Estilos de Dibujo */
        .sketch-path { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; cursor: move; }

        /* Toolbar inferior */
        .toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 20px; border-radius: 50px;
            display: flex; gap: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .tool-btn { border: none; background: none; font-size: 20px; cursor: pointer; padding: 5px 10px; border-radius: 10px; }
        .tool-btn.active { background: var(--accent); color: white; }
    </style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span>‚àö(Raiz) Cuadrada¬≤</span>
</header>

<div class="symbol-library">
    <div class="pill-container" id="category-pills">
        </div>
    <div class="symbol-grid" id="symbol-display">
        </div>
</div>

<div class="toolbar">
    <button class="tool-btn active" onclick="setMode('DRAW')">‚úé</button>
    <button class="tool-btn" onclick="setMode('MOVE')">‚¨à</button>
    <button class="tool-btn" onclick="clearBoard()">üóë</button>
    <button class="tool-btn" style="color: var(--accent)" onclick="exportPNG()">üì∑</button>
</div>

<div id="board-container">
    <svg id="svg-canvas"></svg>
    <div id="latex-layer"></div>
</div>

<script>
    let mode = 'DRAW';
    let isDrawing = false;
    let currentPath = null;

    const svg = document.getElementById('svg-canvas');
    const latexLayer = document.getElementById('latex-layer');
    const symbolDisplay = document.getElementById('symbol-display');
    const categoryPills = document.getElementById('category-pills');

    // --- CONFIGURACI√ìN DE LIBRER√çA (Un ejemplo por pildora como pediste) ---
    const library = {
        "Letras Griegas": [{ s: "\\alpha", n: "alpha" }],
        "Flechas": [{ s: "\\rightarrow", n: "right" }],
        "L√≥gica": [{ s: "\\forall", n: "forall" }],
        "Principales": [{ s: "\\sum", n: "sum" }],
        "Desigualdades": [{ s: "\\leq", n: "leq" }],
        "C√°lculo": [{ s: "\\int", n: "integral" }],
        "Conjuntos": [{ s: "\\in", n: "belongs" }],
        "Matrices/Sist": [{ s: "\\begin{matrix} a & b \\\\ c & d \\end{matrix}", n: "matrix" }],
        "Par√©ntesis": [{ s: "\\left( x \\right)", n: "parent" }],
        "Otros": [{ s: "\\infty", n: "inf" }]
    };

    // Cargar Pildoras
    Object.keys(library).forEach((cat, index) => {
        const btn = document.createElement('button');
        btn.className = `pill ${index === 0 ? 'active' : ''}`;
        btn.innerText = cat;
        btn.onclick = () => {
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            renderSymbols(cat);
        };
        categoryPills.appendChild(btn);
    });

    function renderSymbols(cat) {
        symbolDisplay.innerHTML = '';
        library[cat].forEach(item => {
            const b = document.createElement('div');
            b.className = 'symbol-btn';
            b.innerHTML = `<span id="temp-${item.n}"></span><small>${item.n}</small>`;
            symbolDisplay.appendChild(b);
            katex.render(item.s, b.querySelector('span'));
            b.onclick = () => addLatexItem(item.s);
        });
    }
    renderSymbols("Letras Griegas");

    // --- L√ìGICA DEL TABLERO ---
    function setMode(m) { mode = m; svg.style.cursor = m === 'DRAW' ? 'crosshair' : 'default'; }

    svg.onmousedown = (e) => {
        if (mode !== 'DRAW') return;
        isDrawing = true;
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        currentPath.setAttribute("class", "sketch-path draggable-element");
        currentPath.setAttribute("d", `M ${x} ${y}`);
        svg.appendChild(currentPath);
        
        // Hacer el dibujo movible despu√©s de terminarlo
        makeMovable(currentPath);
    };

    svg.onmousemove = (e) => {
        if (!isDrawing) return;
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const d = currentPath.getAttribute("d");
        currentPath.setAttribute("d", `${d} L ${x} ${y}`);
    };

    window.onmouseup = () => isDrawing = false;

    function addLatexItem(tex) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-item';
        wrapper.style.left = '50%';
        wrapper.style.top = '50%';
        wrapper.dataset.scale = 1;
        
        const content = document.createElement('div');
        wrapper.appendChild(content);
        latexLayer.appendChild(wrapper);
        
        katex.render(tex, content);
        makeMovable(wrapper);
        makeScalable(wrapper);
    }

    // --- SISTEMA DE MOVIMIENTO Y ESCALADO ---
    function makeMovable(el) {
        let isDragging = false;
        let startX, startY;

        el.addEventListener('mousedown', (e) => {
            if (mode !== 'MOVE') return;
            e.stopPropagation();
            isDragging = true;
            startX = e.clientX; startY = e.clientY;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            if (el.tagName === 'path') {
                el.setAttribute("transform", `translate(${dx}, ${dy})`);
            } else {
                el.style.left = (el.offsetLeft + dx) + 'px';
                el.style.top = (el.offsetTop + dy) + 'px';
            }
            startX = e.clientX; startY = e.clientY;
        });

        document.addEventListener('mouseup', () => isDragging = false);
    }

    function makeScalable(el) {
        el.addEventListener('wheel', (e) => {
            e.preventDefault();
            let scale = parseFloat(el.dataset.scale || 1);
            scale += e.deltaY * -0.001;
            scale = Math.min(Math.max(.2, scale), 5); // Limites
            el.dataset.scale = scale;
            el.style.transform = `scale(${scale})`;
        });
    }

    function clearBoard() { svg.innerHTML = ''; latexLayer.innerHTML = ''; }

    async function exportPNG() {
        const canvas = await html2canvas(document.getElementById('board-container'), { backgroundColor: '#F0F2F5' });
        const link = document.createElement('a');
        link.download = 'clase.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
