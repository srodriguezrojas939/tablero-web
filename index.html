<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tablero Matemático Pro</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --bg: #FFFFFF;
            --panel: #F8F9FA;
            --border: #DEE2E6;
            --dark: #212529;
            --accent: #6C757D;
            --select-box: rgba(0, 123, 255, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--dark);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* =========================================
           SECCIÓN: ENCABEZADO Y TOOLBAR
        ========================================= */
        header {
            background: var(--bg);
            padding: 8px; text-align: center;
            border-bottom: 1px solid var(--border);
        }
        h1 { font-size: 14px; margin: 0; text-transform: uppercase; letter-spacing: 2px; }

        .toolbar {
            display: flex; justify-content: center; gap: 4px;
            padding: 8px; background: var(--panel);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .btn {
            background: var(--bg); border: 1px solid var(--border);
            padding: 6px 12px; border-radius: 4px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .btn:hover { background: #eee; }
        .btn.active { background: var(--dark); color: white; border-color: var(--dark); }
        .divider { width: 1px; background: var(--border); margin: 0 8px; }

        /* =========================================
           SECCIÓN: ÁREA DE DIBUJO (SVG)
        ========================================= */
        #viewport {
            flex-grow: 1; position: relative; touch-action: none; overflow: hidden;
        }

        svg { width: 100%; height: 100%; cursor: crosshair; }
        .grid { fill: url(#gridPattern); }
        
        /* Capas Geométricas */
        .drawing-element { fill: none; stroke: var(--dark); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; pointer-events: stroke; }
        .image-element { cursor: move; }
        .latex-element { cursor: move; user-select: none; }

        /* UI de Selección */
        .selection-rect { fill: none; stroke: #007BFF; stroke-width: 1; stroke-dasharray: 4; pointer-events: none; }
        .resize-handle { fill: white; stroke: #007BFF; stroke-width: 2; cursor: nwse-resize; pointer-events: all; }

        #latex-input {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px; border: 1px solid var(--border);
            display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100;
        }
    </style>
</head>
<body>

<header><h1>Matemáticas Lab</h1></header>

<div class="toolbar">
    <button class="btn active" id="btn-PENCIL" onclick="setMode('PENCIL')">Lápiz</button>
    <button class="btn" id="btn-POLY" onclick="setMode('POLY')">Polilínea</button>
    <button class="btn" id="btn-SELECT" onclick="setMode('SELECT')">Selector</button>
    <div class="divider"></div>
    <button class="btn" onclick="document.getElementById('file-img').click()">+ Imagen</button>
    <button class="btn" onclick="openLatex()">Σ LaTeX</button>
    <div class="divider"></div>
    <button class="btn" onclick="undo()">Deshacer</button>
    <button class="btn" onclick="clearBoard()" style="color: #d9534f;">Limpiar</button>
    <input type="file" id="file-img" hidden accept="image/*" onchange="uploadImage(event)">
</div>

<div id="viewport">
    <div id="latex-input">
        <input type="text" id="latex-val" placeholder="Código LaTeX..." style="padding:5px; border:1px solid #ccc">
        <button class="btn" onclick="insertLatex()" style="display:inline">OK</button>
    </div>

    <svg id="canvas">
        <defs>
            <pattern id="gridPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="1"/>
            </pattern>
        </defs>
        <rect class="grid" width="100%" height="100%" />
        
        <g id="layer-images"></g>
        <g id="layer-latex"></g>
        <g id="layer-drawings"></g>
        <g id="layer-ui"></g>
    </svg>
</div>

<script>
    /* ==========================================================================
       LÓGICA CORE: VARIABLES Y ESTADO
       ========================================================================== */
    let mode = 'PENCIL';
    let isDrawing = false;
    let selectedEl = null;
    let isResizing = false;
    let startCoords = { x: 0, y: 0 };
    let history = [];

    const svg = document.getElementById('canvas');
    const layers = {
        img: document.getElementById('layer-images'),
        latex: document.getElementById('layer-latex'),
        draw: document.getElementById('layer-drawings'),
        ui: document.getElementById('layer-ui')
    };

    const snap = 20;

    /* ==========================================================================
       SISTEMA DE EVENTOS (MOUSE + TOUCH)
       ========================================================================== */
    svg.addEventListener('pointerdown', onPointerDown);
    svg.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);

    function getPos(e) {
        const rect = svg.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;
        return { x, y };
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + m).classList.add('active');
        deselect();
    }

    /* ==========================================================================
       ACCIONES DE PUNTERO
       ========================================================================== */
    function onPointerDown(e) {
        const pos = getPos(e);
        startCoords = pos;

        if (mode === 'SELECT') {
            // Verificar si clicamos en un handle de redimensión
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                return;
            }

            // Intentar seleccionar elemento (buscamos el más cercano al puntero)
            const hit = e.target.closest('.draggable');
            if (hit) {
                selectElement(hit);
                isDrawing = true; // Usamos esto para el drag
            } else {
                deselect();
            }
            return;
        }

        if (mode === 'PENCIL') {
            isDrawing = true;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", `M ${pos.x} ${pos.y}`);
            path.setAttribute("class", "drawing-element draggable");
            layers.draw.appendChild(path);
            selectedEl = path;
        }

        if (mode === 'POLY') {
            if (!isDrawing) {
                isDrawing = true;
                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                poly.setAttribute("points", `${pos.x},${pos.y}`);
                poly.setAttribute("class", "drawing-element draggable");
                layers.draw.appendChild(poly);
                selectedEl = poly;
            } else {
                let pts = selectedEl.getAttribute("points");
                selectedEl.setAttribute("points", `${pts} ${pos.x},${pos.y}`);
            }
        }
    }

    function onPointerMove(e) {
        if (!isDrawing && !isResizing) return;
        const pos = getPos(e);

        if (isResizing && selectedEl) {
            resizeElement(pos);
            updateUI();
            return;
        }

        if (mode === 'SELECT' && selectedEl) {
            const dx = pos.x - startCoords.x;
            const dy = pos.y - startCoords.y;
            moveElement(selectedEl, dx, dy);
            startCoords = pos;
            updateUI();
        } else if (mode === 'PENCIL' && isDrawing) {
            let d = selectedEl.getAttribute("d");
            selectedEl.setAttribute("d", `${d} L ${pos.x} ${pos.y}`);
        }
    }

    function onPointerUp() {
        if (mode === 'PENCIL') {
            isDrawing = false;
            saveHistory();
        }
        isResizing = false;
        if (mode === 'SELECT') isDrawing = false;
    }

    // Doble click para cerrar polilínea
    svg.ondblclick = () => { if(mode === 'POLY') { isDrawing = false; saveHistory(); deselect(); } };

    /* ==========================================================================
       MANIPULACIÓN DE ELEMENTOS (MOVER / REDIMENSIONAR)
       ========================================================================== */
    function moveElement(el, dx, dy) {
        if (el.tagName === 'path' || el.tagName === 'polyline') {
            // Mover elementos de dibujo usando transform
            const bbox = el.getBBox();
            const currentT = el.getAttribute("transform") || "translate(0,0)";
            const match = /translate\(([^,]+)[, ]+([^)]+)\)/.exec(currentT);
            let tx = parseFloat(match[1]) + dx;
            let ty = parseFloat(match[2]) + dy;
            el.setAttribute("transform", `translate(${tx},${ty})`);
        } else {
            // Mover imágenes y LaTeX (foreignObject)
            el.setAttribute("x", parseFloat(el.getAttribute("x")) + dx);
            el.setAttribute("y", parseFloat(el.getAttribute("y")) + dy);
        }
    }

    function resizeElement(pos) {
        const x = parseFloat(selectedEl.getAttribute("x"));
        const y = parseFloat(selectedEl.getAttribute("y"));
        const newW = Math.max(20, pos.x - x);
        const newH = Math.max(20, pos.y - y);

        if (selectedEl.classList.contains('latex-element')) {
            // LaTeX escala proporcionalmente
            selectedEl.setAttribute("width", newW);
            selectedEl.setAttribute("height", newW * 0.5); 
            selectedEl.style.fontSize = (newW / 10) + "px";
        } else if (selectedEl.tagName === 'image') {
            selectedEl.setAttribute("width", newW);
            selectedEl.setAttribute("height", newH);
        }
    }

    /* ==========================================================================
       INTERFAZ DE SELECCIÓN (SELECTOR PROFESIONAL)
       ========================================================================== */
    function selectElement(el) {
        selectedEl = el;
        updateUI();
    }

    function deselect() {
        selectedEl = null;
        layers.ui.innerHTML = '';
    }

    function updateUI() {
        layers.ui.innerHTML = '';
        if (!selectedEl) return;

        const b = selectedEl.getBBox();
        // Obtener matriz de transformación para dibujos
        const ctm = selectedEl.getScreenCTM();
        const svgRect = svg.getBoundingClientRect();
        
        // Calculamos posición real considerando transformaciones
        const x = (selectedEl.tagName === 'image' || selectedEl.tagName === 'foreignObject') 
                  ? parseFloat(selectedEl.getAttribute('x')) 
                  : b.x + (parseFloat(selectedEl.getAttribute("transform")?.split('(')[1]) || 0);
        
        const y = (selectedEl.tagName === 'image' || selectedEl.tagName === 'foreignObject') 
                  ? parseFloat(selectedEl.getAttribute('y')) 
                  : b.y + (parseFloat(selectedEl.getAttribute("transform")?.split(',')[1]) || 0);

        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", x - 5);
        rect.setAttribute("y", y - 5);
        rect.setAttribute("width", b.width + 10);
        rect.setAttribute("height", b.height + 10);
        rect.setAttribute("class", "selection-rect");
        layers.ui.appendChild(rect);

        // Solo permitir resize en Imagen y LaTeX
        if (selectedEl.tagName === 'image' || selectedEl.tagName === 'foreignObject') {
            const handle = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            handle.setAttribute("x", x + b.width);
            handle.setAttribute("y", y + b.height);
            handle.setAttribute("width", 12);
            handle.setAttribute("height", 12);
            handle.setAttribute("class", "resize-handle");
            layers.ui.appendChild(handle);
        }
    }

    /* ==========================================================================
       LATEX E IMÁGENES
       ========================================================================== */
    function openLatex() { document.getElementById('latex-input').style.display = 'block'; }

    function insertLatex() {
        const val = document.getElementById('latex-val').value;
        if (!val) return;
        
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("x", 100); fo.setAttribute("y", 100);
        fo.setAttribute("width", 150); fo.setAttribute("height", 80);
        fo.setAttribute("class", "latex-element draggable");
        
        const div = document.createElement("div");
        div.style.fontSize = "20px";
        div.innerHTML = `\\[${val}\\]`;
        
        fo.appendChild(div);
        layers.latex.appendChild(fo);
        MathJax.typeset();
        
        document.getElementById('latex-input').style.display = 'none';
        saveHistory();
    }

    function uploadImage(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
            img.setAttribute("href", ev.target.result);
            img.setAttribute("x", 50); img.setAttribute("y", 50);
            img.setAttribute("width", 200); img.setAttribute("height", 150);
            img.setAttribute("class", "image-element draggable");
            img.setAttribute("preserveAspectRatio", "none");
            layers.img.appendChild(img);
            saveHistory();
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    /* ==========================================================================
       HISTORIAL Y LIMPIEZA
       ========================================================================== */
    function saveHistory() {
        const state = {
            draw: layers.draw.innerHTML,
            latex: layers.latex.innerHTML,
            img: layers.img.innerHTML
        };
        history.push(state);
    }

    function undo() {
        if (history.length < 2) return;
        history.pop();
        const last = history[history.length - 1];
        layers.draw.innerHTML = last.draw;
        layers.latex.innerHTML = last.latex;
        layers.img.innerHTML = last.img;
        deselect();
    }

    function clearBoard() {
        layers.draw.innerHTML = '';
        layers.latex.innerHTML = '';
        layers.img.innerHTML = '';
        deselect();
        saveHistory();
    }

    // Inicializar historial
    saveHistory();
</script>

</body>
</html>
