<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Raiz Cuadrada</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-canvas: #FFFFFF;
            --ui-white: #FFFFFF;
            --ui-gray-light: #F2F2F2;
            --ui-gray-med: #CCCCCC;
            --ui-gray-dark: #888888;
            --text-main: #222222;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--ui-gray-light); }

        header {
            position: absolute; top: 15px; left: 20px; z-index: 100;
            display: flex; align-items: baseline; gap: 10px; pointer-events: none;
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; color: var(--text-main); }
        header span { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--ui-gray-dark); font-weight: bold; }

        /* --- LIBRER√çA INFERIOR DERECHA --- */
        .symbol-library {
            position: absolute; bottom: 90px; right: 20px; width: 380px;
            background: var(--ui-white); border-radius: 12px; padding: 12px;
            border: 1px solid var(--ui-gray-med); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000;
        }
        .pill-container {
            display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px;
            scrollbar-width: thin; scrollbar-color: var(--ui-gray-med) transparent;
            border-bottom: 1px solid var(--ui-gray-light);
        }
        .symbol-grid {
            display: flex; gap: 8px; overflow-x: auto; padding: 10px 0;
            scrollbar-width: thin; scrollbar-color: var(--ui-gray-med) transparent;
        }
        .pill {
            padding: 5px 12px; background: var(--ui-gray-light); border-radius: 15px;
            font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: 0.2s; border: none; color: var(--ui-gray-dark);
        }
        .pill.active { background: var(--text-main); color: var(--ui-white); }
        .symbol-btn {
            background: white; border: 1px solid var(--ui-gray-med); border-radius: 8px;
            min-width: 50px; height: 50px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* --- TABLERO --- */
        #board-container { width: 100vw; height: 100vh; position: relative; background: var(--bg-canvas); }
        svg { width: 100%; height: 100%; }

        /* Elementos Manipulables */
        .draggable-item {
            position: absolute; cursor: move; padding: 10px;
            transform-origin: top left; user-select: none;
        }
        .draggable-item.selected { outline: 1px solid var(--ui-gray-med); }
        
        /* Flecha de expansi√≥n (Manija) */
        .resize-handle {
            position: absolute; bottom: -5px; right: -5px; width: 15px; height: 15px;
            background: var(--ui-gray-dark); clip-path: polygon(100% 0, 100% 100%, 0 100%);
            cursor: nwse-resize; display: none;
        }
        .draggable-item.selected .resize-handle { display: block; }

        .sketch-path, .polyline-path {
            fill: none; stroke: var(--text-main); stroke-width: 3;
            stroke-linecap: round; stroke-linejoin: round; cursor: move;
            transform-origin: center;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--ui-white); padding: 8px 15px; border-radius: 50px;
            display: flex; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--ui-gray-med); z-index: 100;
        }
        .tool-btn {
            border: 1px solid transparent; background: none; font-size: 13px;
            cursor: pointer; padding: 8px 12px; border-radius: 10px;
            color: var(--ui-gray-dark); font-weight: 600;
        }
        .tool-btn.active { background: var(--ui-gray-light); color: var(--text-main); border-color: var(--ui-gray-med); }
        .divider { width: 1px; background: var(--ui-gray-med); margin: 0 5px; }

    </style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span>‚àö(Raiz) Cuadrada¬≤</span>
</header>

<div class="symbol-library">
    <div class="pill-container" id="category-pills"></div>
    <div class="symbol-grid" id="symbol-display"></div>
</div>

<div class="toolbar">
    <button class="tool-btn active" onclick="setMode('DRAW')">‚úé L√°piz</button>
    <button class="tool-btn" onclick="setMode('POLY')">üìè Polil√≠nea</button>
    <button class="tool-btn" onclick="setMode('ERASE')">‚úñ Borrador</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="promptLatex()">‚àë Escribir en LaTeX</button>
    <button class="tool-btn" onclick="clearBoard()">üóë Limpiar</button>
    <button class="tool-btn" onclick="exportPNG()">‚¨á PNG</button>
</div>

<div id="board-container">
    <svg id="svg-canvas"></svg>
    <div id="latex-layer"></div>
</div>

<script>
    let mode = 'DRAW';
    let isDrawing = false;
    let currentPath = null;
    let polyPoints = [];
    let selectedElement = null;

    const svg = document.getElementById('svg-canvas');
    const latexLayer = document.getElementById('latex-layer');
    const symbolDisplay = document.getElementById('symbol-display');
    const categoryPills = document.getElementById('category-pills');

    // --- CONFIGURACI√ìN DE LIBRER√çA (Exactamente tus categor√≠as) ---
    const library = {
        "Letras Griegas": [{ s: "\\alpha" }], "Flechas": [{ s: "\\rightarrow" }],
        "L√≥gica": [{ s: "\\forall" }], "Principales": [{ s: "\\sum" }],
        "Desigualdades": [{ s: "\\geq" }], "C√°lculo": [{ s: "\\int" }],
        "Conjuntos": [{ s: "\\in" }], "Matrices/Sist": [{ s: "\\begin{pmatrix} a & b \\end{pmatrix}" }],
        "Par√©ntesis": [{ s: "\\left( x \\right)" }], "Otros": [{ s: "\\infty" }]
    };

    // Renderizado UI Librer√≠a
    Object.keys(library).forEach((cat, i) => {
        const btn = document.createElement('button');
        btn.className = `pill ${i === 0 ? 'active' : ''}`;
        btn.innerText = cat;
        btn.onclick = (e) => {
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            renderSymbols(cat);
        };
        categoryPills.appendChild(btn);
    });

    function renderSymbols(cat) {
        symbolDisplay.innerHTML = '';
        library[cat].forEach(item => {
            const b = document.createElement('div');
            b.className = 'symbol-btn';
            symbolDisplay.appendChild(b);
            katex.render(item.s, b);
            b.onclick = () => addLatexItem(item.s);
        });
    }
    renderSymbols("Letras Griegas");

    // --- FUNCIONES DE MODO ---
    function setMode(m) {
        mode = m;
        polyPoints = []; // Reset polil√≠nea al cambiar
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        svg.style.cursor = (m === 'DRAW' || m === 'POLY') ? 'crosshair' : 'default';
    }

    // --- MANEJO DE EVENTOS ---
    svg.onmousedown = (e) => {
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (mode === 'DRAW') {
            isDrawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentPath.setAttribute("class", "sketch-path");
            currentPath.setAttribute("d", `M ${x} ${y}`);
            currentPath.setAttribute("transform", "translate(0,0) scale(1)");
            svg.appendChild(currentPath);
            makeMovable(currentPath, 'path');
        } else if (mode === 'POLY') {
            if (polyPoints.length === 0) {
                currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                currentPath.setAttribute("class", "polyline-path");
                currentPath.setAttribute("points", `${x},${y}`);
                currentPath.setAttribute("transform", "translate(0,0) scale(1)");
                svg.appendChild(currentPath);
            }
            polyPoints.push(`${x},${y}`);
            currentPath.setAttribute("points", polyPoints.join(' '));
        }
    };

    svg.onmousemove = (e) => {
        if (!isDrawing || mode !== 'DRAW') return;
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const d = currentPath.getAttribute("d");
        currentPath.setAttribute("d", `${d} L ${x} ${y}`);
    };

    svg.ondblclick = () => {
        if (mode === 'POLY') {
            makeMovable(currentPath, 'path');
            polyPoints = [];
            currentPath = null;
        }
    };

    window.onmouseup = () => { isDrawing = false; };

    // --- GESTI√ìN DE LATEX ---
    function promptLatex() {
        const code = prompt("Escribe tu c√≥digo LaTeX:", "\\sqrt{x^2 + y^2}");
        if (code) addLatexItem(code);
    }

    function addLatexItem(tex) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-item';
        wrapper.style.left = '100px';
        wrapper.style.top = '100px';
        wrapper.style.transform = "scale(1)";
        wrapper.dataset.tex = tex;

        const content = document.createElement('div');
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        
        wrapper.appendChild(content);
        wrapper.appendChild(handle);
        latexLayer.appendChild(wrapper);
        
        katex.render(tex, content);

        wrapper.ondblclick = (e) => {
            e.stopPropagation();
            const newTex = prompt("Editar LaTeX:", wrapper.dataset.tex);
            if (newTex) {
                wrapper.dataset.tex = newTex;
                katex.render(newTex, content);
            }
        };

        wrapper.onclick = (e) => {
            e.stopPropagation();
            if (selectedElement) selectedElement.classList.remove('selected');
            selectedElement = wrapper;
            wrapper.classList.add('selected');
        };

        makeMovable(wrapper, 'div');
        makeManualResize(wrapper, handle);
    }

    // --- MOVIMIENTO, ESCALADO Y BORRADO ---
    function makeMovable(el, type) {
        let dragging = false;
        let startX, startY;

        el.addEventListener('mousedown', (e) => {
            if (mode === 'ERASE') {
                el.remove();
                return;
            }
            e.stopPropagation();
            dragging = true;
            startX = e.clientX; startY = e.clientY;
        });

        document.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            if (type === 'path') {
                const t = el.getAttribute("transform") || "translate(0,0) scale(1)";
                const mTranslate = t.match(/translate\(([^,]+),([^)]+)\)/);
                const mScale = t.match(/scale\(([^)]+)\)/);
                const tx = mTranslate ? parseFloat(mTranslate[1]) + dx : dx;
                const ty = mTranslate ? parseFloat(mTranslate[2]) + dy : dy;
                el.setAttribute("transform", `translate(${tx},${ty}) ${mScale ? mScale[0] : 'scale(1)'}`);
            } else {
                el.style.left = (el.offsetLeft + dx) + 'px';
                el.style.top = (el.offsetTop + dy) + 'px';
            }
            startX = e.clientX; startY = e.clientY;
        });

        document.addEventListener('mouseup', () => dragging = false);

        // Escalado con rueda
        el.addEventListener('wheel', (e) => {
            e.preventDefault();
            let scale;
            if (type === 'path') {
                const t = el.getAttribute("transform") || "scale(1)";
                scale = parseFloat(t.match(/scale\(([^)]+)\)/)[1]);
                scale += e.deltaY * -0.001;
                el.setAttribute("transform", t.replace(/scale\([^)]+\)/, `scale(${scale})`));
            } else {
                const t = el.style.transform || "scale(1)";
                scale = parseFloat(t.match(/scale\(([^)]+)\)/)[1]);
                scale += e.deltaY * -0.001;
                el.style.transform = `scale(${scale})`;
            }
        });
    }

    function makeManualResize(el, handle) {
        let resizing = false;
        handle.onmousedown = (e) => {
            e.stopPropagation();
            resizing = true;
        };
        document.onmousemove = (e) => {
            if (!resizing) return;
            const t = el.style.transform || "scale(1)";
            let scale = parseFloat(t.match(/scale\(([^)]+)\)/)[1]);
            scale += 0.01 * (e.movementX + e.movementY);
            el.style.transform = `scale(${Math.max(0.2, scale)})`;
        };
        document.onmouseup = () => resizing = false;
    }

    function clearBoard() { if(confirm("¬øLimpiar todo?")) { svg.innerHTML = ''; latexLayer.innerHTML = ''; } }

    async function exportPNG() {
        const canvas = await html2canvas(document.getElementById('board-container'));
        const link = document.createElement('a');
        link.download = 'tablero.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
