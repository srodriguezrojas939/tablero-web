<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tablero Matemático Pro</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --bg: #FFFFFF;
            --panel: #F4F4F4;
            --border: #CCCCCC;
            --dark: #333333;
            --accent: #007BFF;
            --selection: rgba(0, 123, 255, 0.15);
        }

        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background: var(--bg); color: var(--dark);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* TÍTULOS GIGANTES Y SECCIONES */
        header { padding: 10px; border-bottom: 1px solid var(--border); text-align: center; background: white; }
        h1 { font-size: 18px; margin: 0; letter-spacing: 3px; text-transform: uppercase; }

        .toolbar {
            display: flex; justify-content: center; gap: 8px; padding: 10px;
            background: var(--panel); border-bottom: 1px solid var(--border); flex-wrap: wrap;
        }

        .btn {
            background: white; border: 1px solid var(--border); padding: 8px 15px;
            border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background: #E0E0E0; }
        .btn.active { background: var(--dark); color: white; }
        .divider { width: 1px; background: var(--border); margin: 0 10px; }

        /* ÁREA DE TRABAJO */
        #viewport { flex-grow: 1; position: relative; touch-action: none; background: white; }
        svg { width: 100%; height: 100%; display: block; }
        
        .grid { fill: url(#gridPattern); }
        
        /* ELEMENTOS */
        .drawing-element { fill: none; stroke: black; stroke-width: 2; stroke-linecap: round; pointer-events: all; }
        .latex-element { cursor: move; display: flex; align-items: center; justify-content: center; overflow: visible; }
        .latex-container { 
            width: 100%; height: 100%; display: flex; align-items: center; 
            justify-content: center; font-size: 20px; transition: font-size 0.1s;
        }
        
        /* SELECTOR */
        .selection-marquee { fill: var(--selection); stroke: var(--accent); stroke-dasharray: 4; pointer-events: none; }
        .element-highlight { stroke: var(--accent) !important; stroke-width: 3 !important; }
        .resize-handle { fill: white; stroke: var(--accent); stroke-width: 2; cursor: nwse-resize; }

        #latex-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 1000;
        }
    </style>
</head>
<body>

<header><h1>TABLERO </h1></header>

<div class="toolbar">
    <button class="btn active" id="btn-PENCIL" onclick="setMode('PENCIL')">LÁPIZ</button>
    <button class="btn" id="btn-POLY" onclick="setMode('POLY')">POLILÍNEA</button>
    <button class="btn" id="btn-SELECT" onclick="setMode('SELECT')">SELECTOR</button>
    <div class="divider"></div>
    <button class="btn" onclick="document.getElementById('img-up').click()">+ IMAGEN</button>
    <button class="btn" onclick="showLatexPanel()">Σ LATEX</button>
    <div class="divider"></div>
    <button class="btn" onclick="undo()">DESHACER</button>
    <button class="btn" onclick="redo()">REHACER</button>
    <button class="btn" onclick="clearAll()" style="color:red">LIMPIAR</button>
</div>

<div id="viewport">
    <div id="latex-panel">
        <h3>Insertar LaTeX</h3>
        <input type="text" id="latex-val" style="width:100%; padding:10px;" placeholder="\frac{a}{b^2}">
        <div style="margin-top:10px; display:flex; gap:10px;">
            <button class="btn" onclick="addLatex()">INSERTAR</button>
            <button class="btn" onclick="hideLatexPanel()">CANCELAR</button>
        </div>
    </div>

    <svg id="canvas">
        <defs>
            <pattern id="gridPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#EEEEEE" stroke-width="1"/>
            </pattern>
        </defs>
        <rect class="grid" width="100%" height="100%" />
        
        <g id="layer-images"></g>
        <g id="layer-latex"></g>
        <g id="layer-drawings"></g>
        <g id="layer-ui"></g>
    </svg>
</div>

<input type="file" id="img-up" hidden onchange="uploadImage(event)">

<script>
    /* =========================================
       SECCIÓN: ESTADO GLOBAL
    ========================================= */
    let mode = 'PENCIL';
    let isAction = false;
    let startPos = { x: 0, y: 0 };
    let currentEl = null;
    let selectedElements = [];
    let history = [];
    let isResizing = false;

    const svg = document.getElementById('canvas');
    const layers = {
        img: document.getElementById('layer-images'),
        latex: document.getElementById('layer-latex'),
        draw: document.getElementById('layer-drawings'),
        ui: document.getElementById('layer-ui')
    };

    /* =========================================
       SECCIÓN: MOTOR DE EVENTOS (MOUSE / TOUCH)
    ========================================= */
    svg.addEventListener('pointerdown', onStart);
    svg.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onEnd);

    function getPos(e) {
        const r = svg.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        deselect();
    }

    /* =========================================
       SECCIÓN: LÓGICA DE SELECCIÓN (EL SELECTOR)
    ========================================= */
    function onStart(e) {
        const pos = getPos(e);
        startPos = pos;
        isAction = true;

        if (mode === 'SELECT') {
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                return;
            }

            const hit = e.target.closest('.draggable');
            if (hit && !e.shiftKey) {
                if (!selectedElements.includes(hit)) {
                    deselect();
                    selectElement(hit);
                }
            } else if (!hit) {
                deselect();
                currentEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                currentEl.setAttribute("class", "selection-marquee");
                layers.ui.appendChild(currentEl);
            }
            return;
        }

        if (mode === 'PENCIL') {
            saveHistory();
            currentEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentEl.setAttribute("d", `M ${pos.x} ${pos.y}`);
            currentEl.setAttribute("class", "drawing-element draggable");
            layers.draw.appendChild(currentEl);
        }

        if (mode === 'POLY') {
            if (!currentEl) {
                saveHistory();
                currentEl = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                currentEl.setAttribute("points", `${pos.x},${pos.y}`);
                currentEl.setAttribute("class", "drawing-element draggable");
                layers.draw.appendChild(currentEl);
            } else {
                let pts = currentEl.getAttribute("points");
                currentEl.setAttribute("points", `${pts} ${pos.x},${pos.y}`);
            }
        }
    }

    function onMove(e) {
        if (!isAction) return;
        const pos = getPos(e);
        const dx = pos.x - startPos.x;
        const dy = pos.y - startPos.y;

        if (mode === 'SELECT') {
            if (isResizing && selectedElements.length === 1) {
                resizeElement(selectedElements[0], pos);
            } else if (currentEl && currentEl.classList.contains('selection-marquee')) {
                // Dibujar recuadro de selección
                const x = Math.min(startPos.x, pos.x);
                const y = Math.min(startPos.y, pos.y);
                const w = Math.abs(dx);
                const h = Math.abs(dy);
                currentEl.setAttribute("x", x);
                currentEl.setAttribute("y", y);
                currentEl.setAttribute("width", w);
                currentEl.setAttribute("height", h);
                checkCollision(x, y, w, h);
            } else if (selectedElements.length > 0) {
                // Mover varios a la vez
                selectedElements.forEach(el => moveElement(el, dx, dy));
                startPos = pos;
            }
            updateSelectionUI();
            return;
        }

        if (mode === 'PENCIL' && currentEl) {
            let d = currentEl.getAttribute("d");
            currentEl.setAttribute("d", `${d} L ${pos.x} ${pos.y}`);
        }
    }

    function onEnd() {
        if (mode === 'SELECT') {
            if (currentEl) currentEl.remove();
            currentEl = null;
        }
        if (mode === 'PENCIL') currentEl = null;
        isAction = false;
        isResizing = false;
    }

    /* =========================================
       SECCIÓN: TRANSFORMACIONES (MOVER / ESCALAR)
    ========================================= */
    function moveElement(el, dx, dy) {
        if (el.tagName === 'path' || el.tagName === 'polyline') {
            const bbox = el.getBBox();
            const transform = el.getAttribute("transform") || "translate(0,0)";
            const parts = transform.split(/[() ,]+/);
            const tx = (parseFloat(parts[1]) || 0) + dx;
            const ty = (parseFloat(parts[2]) || 0) + dy;
            el.setAttribute("transform", `translate(${tx},${ty})`);
        } else {
            el.setAttribute("x", parseFloat(el.getAttribute("x")) + dx);
            el.setAttribute("y", parseFloat(el.getAttribute("y")) + dy);
        }
    }

    function resizeElement(el, pos) {
        const x = parseFloat(el.getAttribute("x"));
        const y = parseFloat(el.getAttribute("y"));
        const nw = Math.max(30, pos.x - x);
        const nh = Math.max(30, pos.y - y);
        
        el.setAttribute("width", nw);
        el.setAttribute("height", nh);

        // ESCALADO ESPECIAL PARA LATEX
        if (el.classList.contains('latex-element')) {
            const container = el.querySelector('.latex-container');
            container.style.fontSize = (nw / 8) + "px";
        }
    }

    function checkCollision(x, y, w, h) {
        const all = document.querySelectorAll('.draggable');
        selectedElements = [];
        all.forEach(el => {
            const b = el.getBBox();
            // Ajustar bbox si tiene transform translate
            let tx = 0, ty = 0;
            const t = el.getAttribute("transform");
            if(t) {
                const m = t.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if(m) { tx = parseFloat(m[1]); ty = parseFloat(m[2]); }
            }
            
            const ex = (parseFloat(el.getAttribute('x')) || b.x) + tx;
            const ey = (parseFloat(el.getAttribute('y')) || b.y) + ty;

            if (ex < x + w && ex + b.width > x && ey < y + h && ey + b.height > y) {
                el.classList.add('element-highlight');
                selectedElements.push(el);
            } else {
                el.classList.remove('element-highlight');
            }
        });
    }

    function updateSelectionUI() {
        const oldHandles = layers.ui.querySelectorAll('.resize-handle, .selection-rect');
        oldHandles.forEach(h => h.remove());

        if (selectedElements.length === 1) {
            const el = selectedElements[0];
            const b = el.getBBox();
            let tx = 0, ty = 0;
            const t = el.getAttribute("transform");
            if(t) {
                const m = t.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if(m) { tx = parseFloat(m[1]); ty = parseFloat(m[2]); }
            }
            const ex = (parseFloat(el.getAttribute('x')) || b.x) + tx;
            const ey = (parseFloat(el.getAttribute('y')) || b.y) + ty;

            // Handle de redimensión (solo para img y latex)
            if (el.tagName === 'image' || el.tagName === 'foreignObject') {
                const h = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                h.setAttribute("x", ex + b.width - 5);
                h.setAttribute("y", ey + b.height - 5);
                h.setAttribute("width", 12); h.setAttribute("height", 12);
                h.setAttribute("class", "resize-handle");
                layers.ui.appendChild(h);
            }
        }
    }

    function selectElement(el) {
        selectedElements = [el];
        el.classList.add('element-highlight');
        updateSelectionUI();
    }

    function deselect() {
        selectedElements.forEach(el => el.classList.remove('element-highlight'));
        selectedElements = [];
        updateSelectionUI();
    }

    /* =========================================
       SECCIÓN: FUNCIONES DE APOYO
    ========================================= */
    function showLatexPanel() { document.getElementById('latex-panel').style.display = 'block'; }
    function hideLatexPanel() { document.getElementById('latex-panel').style.display = 'none'; }

    function addLatex() {
        const val = document.getElementById('latex-val').value;
        if (!val) return;
        saveHistory();
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("x", 150); fo.setAttribute("y", 150);
        fo.setAttribute("width", 180); fo.setAttribute("height", 100);
        fo.setAttribute("class", "latex-element draggable");
        
        fo.innerHTML = `<div xmlns="http://www.w3.org/1999/xhtml" class="latex-container">\\[${val}\\]</div>`;
        layers.latex.appendChild(fo);
        MathJax.typeset();
        hideLatexPanel();
    }

    function uploadImage(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = (ev) => {
            saveHistory();
            const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
            img.setAttribute("href", ev.target.result);
            img.setAttribute("x", 100); img.setAttribute("y", 100);
            img.setAttribute("width", 200); img.setAttribute("height", 150);
            img.setAttribute("class", "draggable");
            img.setAttribute("preserveAspectRatio", "none");
            layers.img.appendChild(img);
        };
        r.readAsDataURL(f);
    }

  function saveHistory() {
    // Al realizar una acción nueva, el historial de "rehacer" debe limpiarse
    redoHistory = []; 
    history.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
}

function undo() {
    if (history.length === 0) return;
    // Guardamos el estado actual en rehacer antes de volver atrás
    redoHistory.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
    
    const last = history.pop();
    layers.draw.innerHTML = last.draw;
    layers.latex.innerHTML = last.latex;
    layers.img.innerHTML = last.img;
    deselect();
}

function redo() {
    if (redoHistory.length === 0) return;
    // Guardamos el estado actual en el historial normal
    history.push({ draw: layers.draw.innerHTML, latex: layers.latex.innerHTML, img: layers.img.innerHTML });
    
    const next = redoHistory.pop();
    layers.draw.innerHTML = next.draw;
    layers.latex.innerHTML = next.latex;
    layers.img.innerHTML = next.img;
    deselect();
}

    function clearAll() { if(confirm("¿Borrar todo?")) { saveHistory(); layers.draw.innerHTML = ''; layers.latex.innerHTML = ''; layers.img.innerHTML = ''; deselect(); } }

    svg.ondblclick = () => { if(mode === 'POLY') currentEl = null; };


    function copyElements() {
    if (selectedElements.length === 0) return;
    // Guardamos clones de los elementos seleccionados
    clipboard = selectedElements.map(el => el.cloneNode(true));
}

function pasteElements() {
    if (clipboard.length === 0) return;
    saveHistory();
    deselect();
    
    clipboard.forEach(clone => {
        const newEl = clone.cloneNode(true);
        // Movemos el pegado un poco para que no quede encima del original
        moveElement(newEl, 25, 25); 
        
        // Insertar en la capa correspondiente
        if (newEl.tagName === 'image') layers.img.appendChild(newEl);
        else if (newEl.tagName === 'foreignObject') layers.latex.appendChild(newEl);
        else layers.draw.appendChild(newEl);
        
        selectedElements.push(newEl);
        newEl.classList.add('element-highlight');
    });
    updateSelectionUI();
}

function deleteSelected() {
    if (selectedElements.length === 0) return;
    saveHistory();
    selectedElements.forEach(el => el.remove());
    selectedElements = [];
    updateSelectionUI();
}
</script>
</body>
</html>
