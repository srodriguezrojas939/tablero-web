<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Pro - Raiz Cuadrada</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-canvas: #FFFFFF; --ui-white: #FFFFFF; --ui-gray-light: #F2F2F2;
            --ui-gray-med: #CCCCCC; --ui-gray-dark: #888888; --text-main: #222222; --accent: #4A90E2;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--ui-gray-light); }

        header { position: absolute; top: 15px; left: 20px; z-index: 100; display: flex; align-items: baseline; gap: 10px; pointer-events: none; }
        header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; color: var(--text-main); }
        header span { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--ui-gray-dark); font-weight: bold; }

        .symbol-library { position: absolute; bottom: 90px; right: 20px; width: 300px; background: var(--ui-white); border-radius: 12px; padding: 12px; border: 1px solid var(--ui-gray-med); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .pill-container { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; border-bottom: 1px solid var(--ui-gray-light); }
        .symbol-grid { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
        .pill { padding: 5px 12px; background: var(--ui-gray-light); border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; color: var(--ui-gray-dark); white-space: nowrap; }
        .pill.active { background: var(--text-main); color: var(--ui-white); }
        .symbol-btn { background: white; border: 1px solid var(--ui-gray-med); border-radius: 8px; min-width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        #editor-panel { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); background: white; padding: 15px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid var(--ui-gray-med); display: none; z-index: 2000; flex-direction: column; gap: 10px; width: 300px; }
        #editor-panel input { padding: 10px; border: 1px solid var(--ui-gray-med); border-radius: 8px; font-family: monospace; }
        .editor-btns { display: flex; gap: 8px; }
        .editor-btns button { flex: 1; padding: 8px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }

        #board-container { width: 100vw; height: 100vh; position: relative; background: var(--bg-canvas); overflow: hidden; }
        
        /* CAPAS RESTAURADAS SEGÃšN TU FUENTE [cite: 64-67] */
        #svg-canvas { position: absolute; inset: 0; z-index: 3; pointer-events: none; }
        #latex-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }

        .draw-mode #svg-canvas, .select-mode #svg-canvas { pointer-events: auto; }
        .select-mode.dragging-item #svg-canvas { pointer-events: none; }

        .draggable-item { position: absolute; cursor: move; padding: 10px; transform-origin: top left; pointer-events: auto; border: 1px dashed transparent; }
        .draggable-item.selected { border: 1px dashed var(--accent) !important; background: rgba(74, 144, 226, 0.05); }
        .draggable-item img { width: 100%; height: 100%; display: block; user-select: none; -webkit-user-drag: none; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--accent); cursor: nwse-resize; display: none; z-index: 100; }
        .draggable-item.selected .resize-handle { display: block; }

        .sketch-path { fill: none; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; cursor: move; pointer-events: auto; }
        .sketch-path.selected { stroke: var(--accent); filter: drop-shadow(0 0 3px rgba(74, 144, 226, 0.5)); }
        .selection-box { fill: rgba(74, 144, 226, 0.1); stroke: var(--accent); stroke-width: 1; stroke-dasharray: 4; pointer-events: none; }

        .toolbar { position: absolute; bottom: 20px; left: 50%; background: var(--ui-white); padding: 8px 15px; border-radius: 50px; display: flex; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--ui-gray-med); z-index: 1000; transform: none !important; }
        .tool-btn { border: 1px solid transparent; background: none; font-size: 13px; cursor: pointer; padding: 8px 12px; border-radius: 10px; color: var(--ui-gray-dark); font-weight: 600; }
        .tool-btn.active { background: var(--ui-gray-light); color: var(--text-main); border-color: var(--ui-gray-med); }
        .divider { width: 1px; background: var(--ui-gray-med); margin: 0 5px; }

        #board-container.grid-active { background-color: #ffffff !important; background-image: radial-gradient(rgba(0, 0, 0, 0.2) 1px, transparent 1px), linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px); background-size: 20px 20px, 20px 20px, 20px 20px; background-position: -1px -1px; }

        .style-bar { position: absolute; top: 80px; left: 20px; background: var(--ui-white); padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 12px; border: 1px solid var(--ui-gray-med); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .color-picker { width: 35px; height: 35px; border: 2px solid var(--ui-gray-light); border-radius: 50%; cursor: pointer; padding: 0; overflow: hidden; }
        .stroke-slider { width: 100%; cursor: pointer; accent-color: var(--accent); }
        
        .toolbar, .symbol-library, .style-bar { cursor: grab; user-select: none; }
        .toolbar:active, .symbol-library:active, .style-bar:active { cursor: grabbing; }
    </style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span>âˆš(Raiz) CuadradaÂ²</span>
</header>

<div id="editor-panel">
    <strong id="editor-title" style="font-size: 12px; color: var(--ui-gray-dark);">EDITAR LATEX</strong>
    <input type="text" id="latex-input" placeholder="Escribe aquÃ­...">
    <div class="editor-btns">
        <button onclick="confirmEdit()" style="background: var(--text-main); color: white;">Aplicar</button>
        <button onclick="closeEditor()" style="background: var(--ui-gray-light);">Cancelar</button>
    </div>
</div>

<div class="symbol-library">
    <div class="pill-container" id="category-pills"></div>
    <div class="symbol-grid" id="symbol-display"></div>
</div>

<div class="style-bar">
    <span style="font-size: 10px; color: var(--ui-gray-dark); font-weight: bold;">ESTILO</span>
    <input type="color" id="stroke-color" class="color-picker" value="#222222">
    <input type="range" id="stroke-width" class="stroke-slider" min="1" max="15" value="3">
    <div style="height:1px; background: var(--ui-gray-light); margin: 5px 0;"></div>
    <span style="font-size: 10px; color: var(--ui-gray-dark); font-weight: bold;">CAPAS</span>
</div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()">â†¶</button>
    <button class="tool-btn" onclick="redo()">â†·</button>
    <div class="divider"></div>
    <button class="tool-btn active" onclick="setMode('DRAW', this)">ðŸ–‰ LÃ¡piz</button>
    <button class="tool-btn" onclick="setMode('POLY', this)">ð–¡¬ PolilÃ­nea</button>
    <button class="tool-btn" onclick="setMode('ERASE', this)">âœ„</button>
    <button class="tool-btn" onclick="setMode('SELECT', this)">â¬š</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="openEditorForNew()"> âˆ‘ LaTeX</button>
    <button class="tool-btn" onclick="setMode('RECT', this)">â–¢</button>
    <button class="tool-btn" onclick="setMode('CIRCLE', this)">â—¯</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="clearBoard()">â¨¯</button>
    <button class="tool-btn" onclick="exportPNG()">â‡ª PNG</button>
    <button id="grid-btn" class="tool-btn" onclick="toggleGrid()"> âŒ— Grilla</button>
    <button class="tool-btn" onclick="document.getElementById('image-input').click()">ðŸ—Ž Imagen</button>
    <input type="file" id="image-input" style="display:none" accept="image/*" onchange="handleImageUpload(event)">
</div>

<div id="board-container">
    <svg id="svg-canvas"></svg>
    <div id="latex-layer"></div>
</div>

<script>
    /* VARIABLES DE ESTADO ORIGINALES [cite: 72-81] */
    let mode = 'DRAW', isDrawing = false, startX, startY, isDraggingItem = false;
    let currentPath = null, polyPoints = [], selectedElements = [], selectionRect = null;
    let undoStack = [], redoStack = [], editingItem = null, clipboard = [];
    const svg = document.getElementById('svg-canvas');
    const latexLayer = document.getElementById('latex-layer');
    const editorPanel = document.getElementById('editor-panel');
    const latexInput = document.getElementById('latex-input');
    let snapEnabled = false; const gridStep = 20;
    let currentStrokeColor = '#222222'; let currentStrokeWidth = 3;
    let isPanning = false; let viewBox = { x: 0, y: 0, w: window.innerWidth, h: window.innerHeight };

    document.getElementById('stroke-color').onchange = (e) => currentStrokeColor = e.target.value;
    document.getElementById('stroke-width').oninput = (e) => currentStrokeWidth = e.target.value;

    const library = {
        "Griegas": [{ s: "\\alpha" }, { s: "\\beta" }, { s: "\\gamma" }, { s: "\\theta" }],
        "CÃ¡lculo": [{ s: "\\int_{a}^{b}" }, { s: "\\frac{df}{dx}" }, { s: "\\lim_{x \\to \\infty}" }],
        "Ãlgebra": [{ s: "\\sqrt{x^2 + y^2}" }, { s: "x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}" }],
        "Matrices": [{ s: "\\begin{matrix} 1 & 0 \\\\ 0 & 1 \\end{matrix}" }]
    };

    function initLibrary() {
        const container = document.getElementById('category-pills');
        Object.keys(library).forEach((cat, i) => {
            const btn = document.createElement('button');
            btn.className = `pill ${i === 0 ? 'active' : ''}`;
            btn.innerText = cat;
            btn.onclick = () => {
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                btn.classList.add('active'); renderSymbols(cat);
            };
            container.appendChild(btn);
        });
        renderSymbols(Object.keys(library)[0]);
        saveState();
    }

    function renderSymbols(cat) {
        const grid = document.getElementById('symbol-display');
        grid.innerHTML = '';
        library[cat].forEach(item => {
            const b = document.createElement('div');
            b.className = 'symbol-btn';
            katex.render(item.s, b);
            b.onclick = () => addLatexItem(item.s);
            grid.appendChild(b);
        });
    }

    /* MODO SEGURO [cite: 88-96] */
    function setMode(m, btn = null) {
        document.querySelectorAll('.selection-box').forEach(el => el.remove());
        isDrawing = false; mode = m;
        const board = document.getElementById('board-container');
        board.classList.remove('draw-mode', 'select-mode');
        document.querySelectorAll('.tool-btn.active').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        if (['DRAW', 'POLY', 'RECT', 'CIRCLE'].includes(m)) {
            board.classList.add('draw-mode');
            deselectAll();
        } else if (m === 'SELECT') {
            board.classList.add('select-mode');
        }
    }

    /* LÃ“GICA DE DIBUJO Y MOUSE [cite: 97-126] */
    svg.onmousedown = (e) => {
        if (isPanning) return;
        document.querySelectorAll('.selection-box').forEach(el => el.remove());
        const x = snap(e.offsetX + viewBox.x), y = snap(e.offsetY + viewBox.y);
        startX = x; startY = y;

        if (mode === 'SELECT') {
            if (isDraggingItem) return;
            deselectAll(); isDrawing = true;
            selectionRect = createSVGElement('rect', { class: 'selection-box', x, y, width: 0, height: 0 });
            svg.appendChild(selectionRect);
            return;
        }

        isDrawing = true;
        if (mode === 'POLY') {
            if (polyPoints.length === 0) {
                currentPath = createSVGElement('polyline', { class: 'sketch-path', transform: 'translate(0,0) scale(1)' });
                svg.appendChild(currentPath);
            }
            polyPoints.push(`${x},${y}`);
            currentPath.setAttribute('points', polyPoints.join(' '));
        } else {
            if (mode === 'DRAW') currentPath = createSVGElement('path', { d: `M ${x} ${y}` });
            else if (mode === 'RECT') currentPath = createSVGElement('rect', { x, y, width: 0, height: 0 });
            else if (mode === 'CIRCLE') currentPath = createSVGElement('circle', { cx: x, cy: y, r: 0 });
            
            if (currentPath) {
                Object.assign(currentPath.style, { stroke: currentStrokeColor, fill: 'none', strokeWidth: currentStrokeWidth });
                currentPath.setAttribute('class', 'sketch-path');
                currentPath.setAttribute('transform', 'translate(0,0) scale(1)');
                svg.appendChild(currentPath);
            }
        }
    };

    svg.onmousemove = (e) => {
        if (isPanning && e.buttons === 1) {
            viewBox.x -= e.movementX; viewBox.y -= e.movementY;
            svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
            latexLayer.style.transform = `translate(${-viewBox.x}px, ${-viewBox.y}px)`;
            return;
        }
        if (isDraggingItem || (!isDrawing && mode !== 'POLY')) return;
        const x = snap(e.offsetX + viewBox.x), y = snap(e.offsetY + viewBox.y);
        
        if (selectionRect) {
            let w = x - startX, h = y - startY;
            selectionRect.setAttribute('width', Math.abs(w)); selectionRect.setAttribute('height', Math.abs(h));
            selectionRect.setAttribute('x', w < 0 ? x : startX); selectionRect.setAttribute('y', h < 0 ? y : startY);
        } else if (currentPath) {
            if (mode === 'DRAW') currentPath.setAttribute('d', currentPath.getAttribute('d') + ` L ${x} ${y}`);
            else if (mode === 'RECT') {
                currentPath.setAttribute('width', Math.abs(x - startX)); currentPath.setAttribute('height', Math.abs(y - startY));
                currentPath.setAttribute('x', Math.min(x, startX)); currentPath.setAttribute('y', Math.min(y, startY));
            } else if (mode === 'CIRCLE') currentPath.setAttribute('r', Math.sqrt((x-startX)**2 + (y-startY)**2));
            else if (mode === 'POLY') currentPath.setAttribute('points', [...polyPoints, `${x},${y}`].join(' '));
        }
    };

    window.onmouseup = () => {
        if (selectionRect) {
            const box = selectionRect.getBoundingClientRect();
            selectedElements = []; 
            document.querySelectorAll('.sketch-path, .draggable-item').forEach(el => {
                const r = el.getBoundingClientRect();
                if (!(r.left > box.right || r.right < box.left || r.top > box.bottom || r.bottom < box.top)) {
                    el.classList.add('selected'); selectedElements.push(el);
                }
            });
            selectionRect.remove(); selectionRect = null;
        }
        if (isDrawing && currentPath && mode !== 'POLY') {
            makeMovable(currentPath, 'path'); saveState(); currentPath = null;
        }
        isDrawing = false;
        document.querySelectorAll('.selection-box').forEach(el => el.remove());
    };

    /* TECLADO Y PANEO [cite: 127-158] */
    window.onkeydown = (e) => {
        if (document.activeElement.tagName === 'INPUT') return;
        if (e.code === 'Space') { isPanning = true; document.body.style.cursor = 'grab'; }
        if (e.key === 'Backspace' || e.key === 'Delete') { selectedElements.forEach(el => el.remove()); saveState(); }
        if (e.ctrlKey && e.key === 'c') clipboard = selectedElements.map(el => el.cloneNode(true));
        if (e.ctrlKey && e.key === 'v') {
            if (clipboard.length === 0) return;
            deselectAll();
            clipboard.forEach(clone => {
                const newEl = clone.cloneNode(true);
                if (newEl.tagName.toLowerCase() === 'div') {
                    newEl.style.left = (parseFloat(newEl.style.left) + 20) + "px";
                    newEl.style.top = (parseFloat(newEl.style.top) + 20) + "px";
                    latexLayer.appendChild(newEl);
                    makeMovable(newEl, 'div');
                    makeManualResize(newEl, newEl.querySelector('.resize-handle'));
                    newEl.ondblclick = (e) => { e.stopPropagation(); if (newEl.dataset.tex) { editingItem = newEl; latexInput.value = newEl.dataset.tex; editorPanel.style.display = 'flex'; latexInput.focus(); } };
                } else {
                    svg.appendChild(newEl); makeMovable(newEl, 'path');
                }
                newEl.classList.add('selected'); selectedElements.push(newEl);
            });
            saveState();
        }
        if (e.ctrlKey && e.key === 'z') undo();
        if (e.ctrlKey && e.key === 'y') redo();
    };

    window.onkeyup = (e) => { if (e.code === 'Space') { isPanning = false; document.body.style.cursor = 'auto'; } };

    /* FUNCIONES DE ELEMENTOS [cite: 159-203] */
    function addLatexItem(tex) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-item'; wrapper.dataset.tex = tex;
        wrapper.style.left = (100 + viewBox.x) + 'px'; wrapper.style.top = (100 + viewBox.y) + 'px';
        wrapper.innerHTML = `<div></div><div class="resize-handle"></div>`;
        latexLayer.appendChild(wrapper);
        katex.render(tex, wrapper.querySelector('div'));
        wrapper.ondblclick = (e) => { e.stopPropagation(); editingItem = wrapper; latexInput.value = wrapper.dataset.tex; editorPanel.style.display = 'flex'; latexInput.focus(); };
        makeMovable(wrapper, 'div');
        makeManualResize(wrapper, wrapper.querySelector('.resize-handle'));
        saveState();
    }

    function addImageItem(src) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-item'; wrapper.style.width = '200px';
        wrapper.style.left = (50 + viewBox.x) + 'px'; wrapper.style.top = (50 + viewBox.y) + 'px';
        wrapper.innerHTML = `<img src="${src}"><div class="resize-handle"></div>`;
        latexLayer.appendChild(wrapper);
        makeMovable(wrapper, 'div');
        makeManualResize(wrapper, wrapper.querySelector('.resize-handle'));
        saveState();
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) { const reader = new FileReader(); reader.onload = (e) => addImageItem(e.target.result); reader.readAsDataURL(file); }
        event.target.value = '';
    }

    function deselectAll() { document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected')); selectedElements = []; }

    function makeMovable(el, type) {
        let dragging = false, iX = 0, iY = 0;
        el.onmousedown = (e) => {
            if (mode === 'ERASE') { el.remove(); saveState(); return; }
            if (mode !== 'SELECT') return;
            if (!el.classList.contains('selected')) { deselectAll(); el.classList.add('selected'); selectedElements = [el]; }
            e.stopPropagation(); dragging = true; isDraggingItem = true;
            iX = e.clientX; iY = e.clientY;
        };
        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const dx = snap(e.clientX - iX), dy = snap(e.clientY - iY);
            selectedElements.forEach(item => {
                if (item.tagName.toLowerCase() === 'div') {
                    item.style.left = (parseFloat(item.style.left) + dx) + 'px';
                    item.style.top = (parseFloat(item.style.top) + dy) + 'px';
                } else {
                    const t = item.getAttribute('transform') || 'translate(0,0) scale(1)';
                    const m = t.match(/translate\(([^,)]+),\s*([^)]+)\)/);
                    const tx = (m ? parseFloat(m[1]) : 0) + dx;
                    const ty = (m ? parseFloat(m[2]) : 0) + dy;
                    item.setAttribute('transform', t.replace(/translate\([^)]+\)/, `translate(${tx},${ty})`));
                }
            });
            iX = e.clientX; iY = e.clientY;
        });
        window.addEventListener('mouseup', () => { dragging = false; isDraggingItem = false; saveState(); });
    }

    function makeManualResize(el, handle) {
        let sX, sY, sW, sH, sR;
        handle.onmousedown = (e) => {
            e.stopPropagation(); sX = e.clientX; sY = e.clientY;
            if (el.tagName.toLowerCase() === 'div') { sW = el.offsetWidth; sH = el.offsetHeight; }
            else if (el.tagName === 'rect') { sW = parseFloat(el.getAttribute('width')); sH = parseFloat(el.getAttribute('height')); }
            else if (el.tagName === 'circle') { sR = parseFloat(el.getAttribute('r')); }

            window.onmousemove = (ev) => {
                const dx = snap(ev.clientX - sX), dy = snap(ev.clientY - sY);
                if (el.tagName.toLowerCase() === 'div') {
                    if (el.dataset.tex) {
                        let scale = Math.min(Math.max(20, sW + dx) / sW, Math.max(20, sH + dy) / sH);
                        el.querySelector('div').style.fontSize = `${16 * scale}px`;
                    } else { el.style.width = Math.max(20, sW + dx) + 'px'; el.style.height = Math.max(20, sH + dy) + 'px'; }
                } else if (el.tagName === 'rect') { el.setAttribute('width', Math.max(10, sW + dx)); el.setAttribute('height', Math.max(10, sH + dy)); }
                else if (el.tagName === 'circle') { el.setAttribute('r', Math.max(5, sR + dx)); }
            };
            window.onmouseup = () => { window.onmousemove = null; window.onmouseup = null; saveState(); };
        };
    }

    /* HISTORIAL Y EXPORTACIÃ“N [cite: 211-231] */
    function createSVGElement(tag, attrs) { const el = document.createElementNS("http://www.w3.org/2000/svg", tag); for (let k in attrs) el.setAttribute(k, attrs[k]); return el; }
    function toggleGrid() { snapEnabled = !snapEnabled; document.getElementById('grid-btn').classList.toggle('active'); document.getElementById('board-container').classList.toggle('grid-active'); }
    function snap(val) { return snapEnabled ? Math.round(val / gridStep) * gridStep : val; }
    function confirmEdit() { if (!latexInput.value) return; if (editingItem) { editingItem.dataset.tex = latexInput.value; katex.render(latexInput.value, editingItem.querySelector('div')); } else { addLatexItem(latexInput.value); } closeEditor(); saveState(); }
    function closeEditor() { editorPanel.style.display = 'none'; }
    function openEditorForNew() { editingItem = null; latexInput.value = ''; editorPanel.style.display = 'flex'; latexInput.focus(); }
    function undo() { if (undoStack.length < 2) return; redoStack.push(undoStack.pop()); applyState(undoStack[undoStack.length - 1]); }
    function redo() { if (redoStack.length === 0) return; const state = redoStack.pop(); undoStack.push(state); applyState(state); }
    function saveState() { undoStack.push({svg: svg.innerHTML, latex: latexLayer.innerHTML}); if(undoStack.length > 30) undoStack.shift(); }
    function applyState(state) { svg.innerHTML = state.svg; latexLayer.innerHTML = state.latex; document.querySelectorAll('.sketch-path').forEach(el => makeMovable(el, 'path')); document.querySelectorAll('.draggable-item').forEach(el => { makeMovable(el, 'div'); makeManualResize(el, el.querySelector('.resize-handle')); el.ondblclick = (e) => { e.stopPropagation(); if (el.dataset.tex) { editingItem = el; latexInput.value = el.dataset.tex; editorPanel.style.display = 'flex'; latexInput.focus(); } }; }); }
    function clearBoard() { if(confirm("Â¿Limpiar todo?")) { svg.innerHTML = ''; latexLayer.innerHTML = ''; saveState(); } }
    async function exportPNG() { deselectAll(); const canvas = await html2canvas(document.getElementById('board-container')); const link = document.createElement('a'); link.download = 'tablero.png'; link.href = canvas.toDataURL(); link.click(); }
    
    function makePanelDraggable(el) {
        let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
        el.onmousedown = (e) => {
            if (['BUTTON', 'INPUT'].includes(e.target.tagName) || e.target.classList.contains('pill')) return;
            e.preventDefault(); p3 = e.clientX; p4 = e.clientY;
            document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
            document.onmousemove = (ev) => { ev.preventDefault(); p1 = p3 - ev.clientX; p2 = p4 - ev.clientY; p3 = ev.clientX; p4 = ev.clientY; el.style.top = (el.offsetTop - p2) + "px"; el.style.left = (el.offsetLeft - p1) + "px"; el.style.bottom = "auto"; el.style.right = "auto"; };
        }
    }

    initLibrary();
    makePanelDraggable(document.querySelector('.toolbar'));
    makePanelDraggable(document.querySelector('.symbol-library'));
    makePanelDraggable(document.querySelector('.style-bar'));
    setMode('DRAW', document.querySelector('.tool-btn.active'));
</script>
</body>
</html>
