<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Pro - Raiz Cuadrada</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        /* ============================================================
           ESTILOS GENERALES Y VARIABLES (F√°cil de modificar: agrega variables aqu√≠)
           ============================================================ */
        :root {
            --bg-canvas: #FFFFFF;
            --ui-white: #FFFFFF;
            --ui-gray-light: #F2F2F2;
            --ui-gray-med: #CCCCCC;
            --ui-gray-dark: #888888;
            --text-main: #222222;
            --accent: #4A90E2;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--ui-gray-light); }

        /* --- CABECERA --- */
        header {
            position: absolute; top: 15px; left: 20px; z-index: 100;
            display: flex; align-items: baseline; gap: 10px; pointer-events: none;
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; color: var(--text-main); }
        header span { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--ui-gray-dark); font-weight: bold; }

        /* --- LIBRER√çA DE S√çMBOLOS --- */
        .symbol-library {
            position: absolute; bottom: 90px; right: 20px; width: 300px;
            background: var(--ui-white); border-radius: 12px; padding: 12px;
            border: 1px solid var(--ui-gray-med); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000;
        }
        .pill-container { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; border-bottom: 1px solid var(--ui-gray-light); }
        .symbol-grid { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
        .pill { padding: 5px 12px; background: var(--ui-gray-light); border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; color: var(--ui-gray-dark); white-space: nowrap; }
        .pill.active { background: var(--text-main); color: var(--ui-white); }
        .symbol-btn { background: white; border: 1px solid var(--ui-gray-med); border-radius: 8px; min-width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* --- EDITOR DE LATEX --- */
        #editor-panel {
            position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid var(--ui-gray-med);
            display: none; z-index: 2000; flex-direction: column; gap: 10px; width: 300px;
        }
        #editor-panel input { padding: 10px; border: 1px solid var(--ui-gray-med); border-radius: 8px; font-family: monospace; }
        .editor-btns { display: flex; gap: 8px; }
        .editor-btns button { flex: 1; padding: 8px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }

        /* --- CONTENEDORES DEL TABLERO (Jerarqu√≠a: images 1, latex 2, svg 3) --- */
        #board-container { width: 100vw; height: 100vh; position: relative; background: var(--bg-canvas); overflow: hidden; }
        #image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #latex-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #svg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; background: transparent !important; pointer-events: none; }

        /* --- ELEMENTOS INTERACTIVOS --- */
        .draggable-item { position: absolute; cursor: move; padding: 10px; transform-origin: top left; pointer-events: auto; border: 1px dashed transparent; }
        .draggable-item.selected { border: 1px dashed var(--accent) !important; background: rgba(74, 144, 226, 0.05); }
        .draggable-item img { width: 100%; height: 100%; display: block; user-select: none; -webkit-user-drag: none; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--accent); cursor: nwse-resize; display: none; }
        .draggable-item.selected .resize-handle { display: block; }

        .sketch-path { fill: none; stroke-linecap: round; stroke-linejoin: round; cursor: move; pointer-events: auto; }
        .sketch-path.selected { stroke: var(--accent); filter: drop-shadow(0 0 3px rgba(74, 144, 226, 0.5)); }

        .selection-box { fill: rgba(74, 144, 226, 0.1); stroke: var(--accent); stroke-width: 1; stroke-dasharray: 4; pointer-events: none; }

        /* --- BARRA DE HERRAMIENTAS --- */
        .toolbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--ui-white); padding: 8px 15px; border-radius: 50px;
            display: flex; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--ui-gray-med); z-index: 1000;
        }
        .tool-btn { border: 1px solid transparent; background: none; font-size: 13px; cursor: pointer; padding: 8px 12px; border-radius: 10px; color: var(--ui-gray-dark); font-weight: 600; }
        .tool-btn.active { background: var(--ui-gray-light); color: var(--text-main); border-color: var(--ui-gray-med); }
        .divider { width: 1px; background: var(--ui-gray-med); margin: 0 5px; }

        #board-container.grid-active {
            background-color: #ffffff !important;
            background-image: 
                radial-gradient(rgba(0, 0, 0, 0.2) 1px, transparent 1px),
                linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px, 20px 20px, 20px 20px;
            background-position: -1px -1px;
        }

        /* --- BARRA DE ESTILOS Y CAPAS --- */
        .style-bar {
            position: absolute; top: 80px; left: 20px; /* Debajo del t√≠tulo "Tablero" */
            background: var(--ui-white); padding: 12px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 12px;
            border: 1px solid var(--ui-gray-med); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000;
        }
        .color-picker { 
            width: 35px; height: 35px; border: 2px solid var(--ui-gray-light); 
            border-radius: 50%; cursor: pointer; padding: 0; overflow: hidden;
        }
        .stroke-slider { width: 100%; cursor: pointer; accent-color: var(--accent); }
        .layer-btn { 
            font-size: 18px; cursor: pointer; background: var(--ui-gray-light); 
            border: 1px solid var(--ui-gray-med); border-radius: 8px; padding: 5px;
            transition: 0.2s;
        }
        .layer-btn:hover { background: var(--ui-gray-med); }

        /* Modifica estas clases en tu bloque <style> */

.toolbar, .symbol-library, .style-bar {
    cursor: grab; /* Indica que se puede agarrar */
    user-select: none; /* Evita seleccionar texto al arrastrar */
}

.toolbar:active, .symbol-library:active, .style-bar:active {
    cursor: grabbing; /* Cambia el cursor al mover */
}

/* Ajuste espec√≠fico para que la toolbar se deje mover sin saltos */
.toolbar {
    /* Quitamos el transform negativo que sol√≠a centrarla */
    transform: none !important; 
    left: 30%; /* Posici√≥n inicial manual */
}
        /* Permitir dibujar sobre im√°genes y LaTeX */
 /* Normalmente, im√°genes y LaTeX capturan mouse */
.draggable-item {
    pointer-events: auto;
}

/* Cuando dibujamos, dejan pasar el mouse */
.draw-mode .draggable-item {
    pointer-events: none;
}


/* LaTeX e im√°genes encima */
#latex-layer {
    z-index: 2;
}

  /* ============================================================
   0. CAPAS E INTERACCI√ìN DEL SVG
   ============================================================ */

#svg-canvas {
    position: absolute;
    inset: 0;
    z-index: 3;
    pointer-events: none;
}

/* Modos de dibujo */
.draw-mode #svg-canvas {
    pointer-events: auto;
}

/* Modo selecci√≥n por recuadro */
.select-mode #svg-canvas {
    pointer-events: auto;
}

/* Cuando se arrastra un item, el SVG NO intercepta */
.select-mode.dragging-item #svg-canvas {
    pointer-events: none;
}

    </style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span>‚àö(Raiz) Cuadrada¬≤</span>
</header>

<div id="editor-panel">
    <strong id="editor-title" style="font-size: 12px; color: var(--ui-gray-dark);">EDITAR LATEX</strong>
    <input type="text" id="latex-input" placeholder="Escribe aqu√≠...">
    <div class="editor-btns">
        <button onclick="confirmEdit()" style="background: var(--text-main); color: white;">Aplicar</button>
        <button onclick="closeEditor()" style="background: var(--ui-gray-light);">Cancelar</button>
    </div>
</div>

<div class="symbol-library">
    <div class="pill-container" id="category-pills"></div>
    <div class="symbol-grid" id="symbol-display"></div>
</div>

    <div class="style-bar">
    <span style="font-size: 10px; color: var(--ui-gray-dark); font-weight: bold;">ESTILO</span>
    <input type="color" id="stroke-color" class="color-picker" value="#222222" title="Color del trazo">
    <input type="range" id="stroke-width" class="stroke-slider" min="1" max="15" value="3" title="Grosor">
    
    <div style="height:1px; background: var(--ui-gray-light); margin: 5px 0;"></div>
    
    <span style="font-size: 10px; color: var(--ui-gray-dark); font-weight: bold;">CAPAS</span>
</div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()">‚Ü∂</button>
    <button class="tool-btn" onclick="redo()">‚Ü∑</button>
    <div class="divider"></div>
    <button class="tool-btn active" onclick="setMode('DRAW', this)">üñâ L√°piz</button>
    <button class="tool-btn" onclick="setMode('POLY', this)">ñ°¨ Polil√≠nea</button>
    <button class="tool-btn" onclick="setMode('ERASE', this)">‚úÑ</button>
    <button class="tool-btn" onclick="setMode('SELECT', this)">‚¨ö</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="toggleGrid()">‚ó∞ Cuadr√≠cula</button>
    <button class="tool-btn" onclick="clearBoard()">üóë Limpiar</button>
    <button class="tool-btn" onclick="exportPNG()">üì∑ Exportar</button>
    <button class="tool-btn" onclick="openLatexEditor()">‚úé LaTeX</button>
    <label class="tool-btn" style="cursor:pointer;">üñº Imagen <input type="file" id="image-upload" accept="image/*" style="display:none;" onchange="handleImageUpload(event)"></label>
</div>

<div id="board-container">
    <div id="image-layer"></div>
    <div id="latex-layer"></div>
    <svg id="svg-canvas"></svg>
</div>

<script>
    // ============================================================
    // 1. VARIABLES GLOBALES Y CONFIGURACI√ìN (Agrega nuevas aqu√≠ para extender)
    // ============================================================

    let currentMode = 'DRAW';
    let currentColor = '#222222';
    let currentWidth = 3;
    let isDrawing = false;
    let currentPath = null;
    let paths = [];
    let redoStack = [];
    let gridActive = false;

    let selectedObject = null; // Para edici√≥n de LaTeX

    // Inicializar canvas SVG
    const svg = document.getElementById('svg-canvas');
    const latexLayer = document.getElementById('latex-layer');
    const imageLayer = document.getElementById('image-layer');

    // Eventos de resize para el tablero
    window.addEventListener('resize', () => {
        svg.setAttribute('width', window.innerWidth);
        svg.setAttribute('height', window.innerHeight);
    });

    // ============================================================
    // 2. MODOS DE HERRAMIENTA (F√°cil agregar nuevos modos aqu√≠)
    // ============================================================

    function setMode(mode, btn) {
        currentMode = mode;

        // Actualizar bot√≥n activo
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Cambiar clases en body para CSS
        document.body.className = mode.toLowerCase() + '-mode';
    }

    // ============================================================
    // 3. DIBUJO LIBRE Y FORMAS (Agregar nuevas formas aqu√≠)
    // ============================================================

    function handleMouseDown(e) {
        if (currentMode !== 'DRAW' && currentMode !== 'POLY' && currentMode !== 'RECT' && currentMode !== 'CIRCLE') return;

        isDrawing = true;
        const pointer = e.offsetX, e.offsetY;

        if (currentMode === 'DRAW') {
            currentPath = new fabric.Path(`M ${pointer.x} ${pointer.y}`, {
                stroke: currentColor,
                strokeWidth: currentWidth,
                fill: null,
                strokeLineCap: 'round',
                strokeLineJoin: 'round',
                selectable: true,
                hasControls: true,
                objectCaching: false
            });
        } else if (currentMode === 'RECT') {
            currentPath = new fabric.Rect({
                left: pointer.x,
                top: pointer.y,
                width: 0,
                height: 0,
                stroke: currentColor,
                strokeWidth: currentWidth,
                fill: null,
                selectable: true,
                hasControls: true
            });
        } else if (currentMode === 'CIRCLE') {
            currentPath = new fabric.Circle({
                left: pointer.x,
                top: pointer.y,
                radius: 0,
                stroke: currentColor,
                strokeWidth: currentWidth,
                fill: null,
                selectable: true,
                hasControls: true
            });
        } else if (currentMode === 'POLY') {
            // L√≥gica para polil√≠nea
            if (!currentPath) {
                currentPath = new fabric.Polyline([pointer], {
                    stroke: currentColor,
                    strokeWidth: currentWidth,
                    fill: null,
                    selectable: true,
                    hasControls: true
                });
            } else {
                currentPath.path.push(pointer);
            }
        }

        canvas.add(currentPath);
        paths.push(currentPath);
        redoStack = [];
    }

    function handleMouseMove(e) {
        if (!isDrawing || !currentPath) return;

        const pointer = e.offsetX, e.offsetY;

        if (currentMode === 'DRAW') {
            currentPath.path.push(['L', pointer.x, pointer.y]);
        } else if (currentMode === 'RECT') {
            currentPath.set({
                width: pointer.x - currentPath.left,
                height: pointer.y - currentPath.top
            });
        } else if (currentMode === 'CIRCLE') {
            currentPath.set({
                radius: Math.sqrt(Math.pow(pointer.x - currentPath.left, 2) + Math.pow(pointer.y - currentPath.top, 2))
            });
        } else if (currentMode === 'POLY') {
            currentPath.path[currentPath.path.length - 1] = ['L', pointer.x, pointer.y];
        }

        canvas.renderAll();
    }

    function handleMouseUp() {
        if (!isDrawing) return;
        isDrawing = false;
        currentPath = null;
        canvas.renderAll();
    }

    // ============================================================
    // 4. FUNCIONES UTILIDADES (Undo, Redo, Clear, Export)
    // ============================================================

    function undo() {
        if (paths.length === 0) return;
        const last = paths.pop();
        canvas.remove(last);
        redoStack.push(last);
        canvas.renderAll();
    }

    function redo() {
        if (redoStack.length === 0) return;
        const next = redoStack.pop();
        canvas.add(next);
        paths.push(next);
        canvas.renderAll();
    }

    function clearBoard() {
        canvas.clear();
        paths = [];
        redoStack = [];
    }

    function exportPNG() {
        html2canvas(document.getElementById('board-container')).then(c => {
            const link = document.createElement('a');
            link.download = 'tablero.png';
            link.href = c.toDataURL();
            link.click();
        });
    }

    // ============================================================
    // 5. CUADR√çCULA
    // ============================================================

    function toggleGrid() {
        gridActive = !gridActive;
        const container = document.getElementById('board-container');
        if (gridActive) {
            container.classList.add('grid-active');
        } else {
            container.classList.remove('grid-active');
        }
    }

    // ============================================================
    // 6. LATEX E IM√ÅGENES (Agregar nuevos tipos de objetos aqu√≠)
    // ============================================================

    function openLatexEditor() {
        document.getElementById('editor-panel').style.display = 'flex';
        document.getElementById('latex-input').focus();
    }

    function closeEditor() {
        document.getElementById('editor-panel').style.display = 'none';
        selectedObject = null;
    }

    function confirmEdit() {
        const latex = document.getElementById('latex-input').value.trim();
        if (!latex) return;

        // Renderizar con KaTeX
        const container = document.createElement('div');
        container.style.padding = '20px';
        container.style.background = 'white';
        container.style.display = 'inline-block';
        katex.render(latex, container, { throwOnError: false, displayMode: true });

        html2canvas(container).then(c => {
            const dataURL = c.toDataURL('image/png');

            fabric.Image.fromURL(dataURL, function(img) {
                img.set({
                    left: canvas.width / 2 - img.width / 2,
                    top: canvas.height / 2 - img.height / 2,
                    selectable: true,
                    hasControls: true,
                    hasBorders: true
                });

                img.setControlsVisibility({
                    mt: true, mb: true, ml: true, mr: true,
                    mtr: true, tl: true, tr: true, bl: true, br: true
                });

                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.renderAll();
            });
        });

        closeEditor();
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            fabric.Image.fromURL(e.target.result, function(img) {
                img.set({
                    left: canvas.width / 2 - img.width / 2,
                    top: canvas.height / 2 - img.height / 2,
                    selectable: true,
                    hasControls: true,
                    hasBorders: true
                });

                img.setControlsVisibility({
                    mt: true, mb: true, ml: true, mr: true,
                    mtr: true, tl: true, tr: true, bl: true, br: true
                });

                img.scaleToWidth(300);
                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.renderAll();
            });
        };
        reader.readAsDataURL(file);
    }

    // ============================================================
    // INICIALIZACI√ìN (Agrega nuevos listeners o init aqu√≠)
    // ============================================================

    function init() {
        initCanvas();
        initLibrary();
        makePanelDraggable(document.querySelector('.toolbar'));
        makePanelDraggable(document.querySelector('.symbol-library'));
        makePanelDraggable(document.querySelector('.style-bar'));
    }

    init();
</script>
</body>
</html>
