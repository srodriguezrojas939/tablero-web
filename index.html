<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Raiz Cuadrada</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-canvas: #FFFFFF;
            --ui-white: #FFFFFF;
            --ui-gray-light: #F2F2F2;
            --ui-gray-med: #CCCCCC;
            --ui-gray-dark: #888888;
            --text-main: #222222;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--ui-gray-light); }

        header {
            position: absolute; top: 15px; left: 20px; z-index: 100;
            display: flex; align-items: baseline; gap: 10px; pointer-events: none;
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; color: var(--text-main); }
        header span { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--ui-gray-dark); font-weight: bold; }

        /* --- LIBRER√çA --- */
        .symbol-library {
            position: absolute; bottom: 90px; right: 20px; width: 380px;
            background: var(--ui-white); border-radius: 12px; padding: 12px;
            border: 1px solid var(--ui-gray-med); box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000;
        }
        .pill-container {
            display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px;
            border-bottom: 1px solid var(--ui-gray-light);
        }
        .symbol-grid { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
        .pill {
            padding: 5px 12px; background: var(--ui-gray-light); border-radius: 15px;
            font-size: 11px; font-weight: 600; cursor: pointer; border: none; color: var(--ui-gray-dark);
        }
        .pill.active { background: var(--text-main); color: var(--ui-white); }
        .symbol-btn {
            background: white; border: 1px solid var(--ui-gray-med); border-radius: 8px;
            min-width: 50px; height: 50px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* --- TABLERO --- */
        #board-container { width: 100vw; height: 100vh; position: relative; background: var(--bg-canvas); overflow: hidden; }
        svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        #latex-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }

        /* Elementos */
        .draggable-item {
            position: absolute; cursor: move; padding: 10px;
            transform-origin: top left; user-select: none; pointer-events: auto;
            border: 1px dashed transparent;
        }
        .draggable-item.selected { border: 1px dashed #888888 !important; outline: 2px solid #222222; }
        
        .resize-handle {
            position: absolute; bottom: -5px; right: -5px; width: 15px; height: 15px;
            background: var(--ui-gray-dark); clip-path: polygon(100% 0, 100% 100%, 0 100%);
            cursor: nwse-resize; display: none;
        }
        .draggable-item.selected .resize-handle { display: block; }

        .sketch-path {
            fill: none; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round;
            cursor: move; pointer-events: auto;
        }
        .sketch-path.selected { stroke: #000; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); outline: 2px solid #222222; }

        .selection-box {
            fill: rgba(136, 136, 136, 0.15); stroke: #888888; stroke-width: 1;
            stroke-dasharray: 4; pointer-events: none;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--ui-white); padding: 8px 15px; border-radius: 50px;
            display: flex; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--ui-gray-med); z-index: 1000;
        }
        .tool-btn {
            border: 1px solid transparent; background: none; font-size: 13px;
            cursor: pointer; padding: 8px 12px; border-radius: 10px;
            color: var(--ui-gray-dark); font-weight: 600;
        }
        .tool-btn.active { background: var(--ui-gray-light); color: var(--text-main); border-color: var(--ui-gray-med); }
        .divider { width: 1px; background: var(--ui-gray-med); margin: 0 5px; }

        /* --- CUADRO LATEX PERSONALIZADO --- */
        #latex-input-panel {
            position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--ui-gray-med);
            display: none; z-index: 2000; gap: 8px; align-items: center;
        }
        #latex-input-panel input {
            padding: 8px; border: 1px solid var(--ui-gray-med); border-radius: 6px; width: 200px;
        }
        #latex-input-panel button {
            background: var(--text-main); color: white; border: none; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span>‚àö(Raiz) Cuadrada¬≤</span>
</header>

<div id="latex-input-panel">
    <input type="text" id="latex-input-field" placeholder="Escribe LaTeX aqu√≠...">
    <button onclick="confirmLatex()">Insertar</button>
    <button onclick="closeLatexPanel()" style="background:#888">√ó</button>
</div>

<div class="symbol-library">
    <div class="pill-container" id="category-pills"></div>
    <div class="symbol-grid" id="symbol-display"></div>
</div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()">‚Ü∂</button>
    <button class="tool-btn" onclick="redo()">‚Ü∑</button>
    <div class="divider"></div>
    <button class="tool-btn active" onclick="setMode('DRAW', this)"> üñâ L√°piz</button>
    <button class="tool-btn" onclick="setMode('POLY', this)"> ñ°¨ Polil√≠nea</button>
    <button class="tool-btn" onclick="setMode('ERASE', this)"> ‚úÑ Borrador</button>
    <button class="tool-btn" onclick="setMode('SELECT', this)">‚¨ö Seleccionar</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="openLatexPanel()">‚àë LaTeX</button>
    <button class="tool-btn" onclick="setMode('RECT', this)"> ‚ñ¢ </button>
    <button class="tool-btn" onclick="setMode('CIRCLE', this)">‚óØ </button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="clearBoard()"> ‚®Ø Limpiar</button>
    <button class="tool-btn" onclick="exportPNG()"> ‚á™ PNG</button>
</div>

<div id="board-container">
    <svg id="svg-canvas"></svg>
    <div id="latex-layer"></div>
</div>

<script>
    let mode = 'DRAW';
    let isDrawing = false;
    let startX, startY;
    let currentPath = null;
    let polyPoints = [];
    let selectedElements = [];
    let selectionRect = null;
    let clipboard = [];

    // Historial para Undo/Redo
    let undoStack = [];
    let redoStack = [];

    const svg = document.getElementById('svg-canvas');
    const latexLayer = document.getElementById('latex-layer');
    const symbolDisplay = document.getElementById('symbol-display');
    const categoryPills = document.getElementById('category-pills');

    // --- GUARDAR ESTADO (Undo/Redo) ---
    function saveState() {
        const state = {
            svg: svg.innerHTML,
            latex: latexLayer.innerHTML
        };
        undoStack.push(JSON.stringify(state));
        redoStack = []; // Limpiar redo al hacer algo nuevo
        if(undoStack.length > 30) undoStack.shift(); // L√≠mite de 30 pasos
    }

    function undo() {
        if (undoStack.length <= 1) return;
        redoStack.push(undoStack.pop());
        const state = JSON.parse(undoStack[undoStack.length - 1]);
        applyState(state);
    }

    function redo() {
        if (redoStack.length === 0) return;
        const state = JSON.parse(redoStack.pop());
        undoStack.push(JSON.stringify(state));
        applyState(state);
    }

    function applyState(state) {
        svg.innerHTML = state.svg;
        latexLayer.innerHTML = state.latex;
        // Re-vincular eventos a los nuevos elementos del DOM
        document.querySelectorAll('.sketch-path').forEach(el => makeMovable(el, 'path'));
        document.querySelectorAll('.draggable-item').forEach(el => {
            makeMovable(el, 'div');
            makeManualResize(el, el.querySelector('.resize-handle'));
        });
    }

    // --- LIBRER√çA ---
    const library = {
        "Letras Griegas": [{ s: "\\alpha" }, { s: "\\beta" }, { s: "\\pi" }, { s: "\\theta" }, { s: "\\omega" }],
        "Principales": [{ s: "\\sum" }, { s: "\\sqrt{x}" }, { s: "\\int" }, { s: "\\infty" }, { s: "\\pm" }],
        "Matrices": [{ s: "\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}" }]
    };

    function initLibrary() {
        Object.keys(library).forEach((cat, i) => {
            const btn = document.createElement('button');
            btn.className = `pill ${i === 0 ? 'active' : ''}`;
            btn.innerText = cat;
            btn.onclick = () => {
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                renderSymbols(cat);
            };
            categoryPills.appendChild(btn);
        });
        renderSymbols(Object.keys(library)[0]);
        saveState(); // Guardar estado inicial vac√≠o
    }

    function renderSymbols(cat) {
        symbolDisplay.innerHTML = '';
        library[cat].forEach(item => {
            const b = document.createElement('div');
            b.className = 'symbol-btn';
            katex.render(item.s, b);
            b.onclick = () => addLatexItem(item.s);
            symbolDisplay.appendChild(b);
        });
    }
    initLibrary();

    // --- MODOS ---
    function setMode(m, btn) {
        mode = m;
        polyPoints = [];
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    // --- EVENTOS DE MOUSE ---
    svg.onmousedown = (e) => {
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        startX = x; startY = y;

        if (mode === 'SELECT') {
            deselectAll();
            isDrawing = true;
            selectionRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            selectionRect.setAttribute("class", "selection-box");
            svg.appendChild(selectionRect);
            return;
        }

        isDrawing = true;
        if (mode === 'DRAW') {
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentPath.setAttribute("d", `M ${x} ${y}`);
        } else if (mode === 'RECT') {
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        } else if (mode === 'CIRCLE') {
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        } else if (mode === 'POLY') {
            if (polyPoints.length === 0) {
                currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                svg.appendChild(currentPath);
            }
            polyPoints.push(`${x},${y}`);
            currentPath.setAttribute("points", polyPoints.join(' '));
        }

        if (currentPath && mode !== 'POLY') {
            currentPath.setAttribute("class", "sketch-path");
            currentPath.setAttribute("stroke", "var(--text-main)");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke-width", "3");
            currentPath.setAttribute("transform", "translate(0,0) scale(1)");
            svg.appendChild(currentPath);
        }
    };

    svg.onmousemove = (e) => {
        if (!isDrawing) return;
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (mode === 'SELECT' && selectionRect) {
            let w = x - startX, h = y - startY;
            selectionRect.setAttribute("width", Math.abs(w));
            selectionRect.setAttribute("height", Math.abs(h));
            selectionRect.setAttribute("x", w < 0 ? x : startX);
            selectionRect.setAttribute("y", h < 0 ? y : startY);
        } else if (currentPath) {
            if (mode === 'DRAW') {
                const d = currentPath.getAttribute("d");
                currentPath.setAttribute("d", `${d} L ${x} ${y}`);
            } else if (mode === 'RECT') {
                let w = x - startX, h = y - startY;
                currentPath.setAttribute("width", Math.abs(w));
                currentPath.setAttribute("height", Math.abs(h));
                currentPath.setAttribute("x", w < 0 ? x : startX);
                currentPath.setAttribute("y", h < 0 ? y : startY);
            } else if (mode === 'CIRCLE') {
                let r = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                currentPath.setAttribute("cx", startX);
                currentPath.setAttribute("cy", startY);
                currentPath.setAttribute("r", r);
            }
        }
    };

    window.onmouseup = () => {
        if (mode === 'SELECT' && selectionRect) {
            const box = selectionRect.getBoundingClientRect();
            document.querySelectorAll('.sketch-path, .draggable-item').forEach(item => {
                const r = item.getBoundingClientRect();
                if (!(r.left > box.right || r.right < box.left || r.top > box.bottom || r.bottom < box.top)) {
                    item.classList.add('selected');
                    selectedElements.push(item);
                }
            });
            selectionRect.remove();
            selectionRect = null;
        }
        if (isDrawing && currentPath && mode !== 'POLY') {
            makeMovable(currentPath, 'path');
            saveState();
            currentPath = null;
        }
        isDrawing = false;
    };

    svg.ondblclick = () => {
        if (mode === 'POLY' && currentPath) {
            makeMovable(currentPath, 'path');
            saveState();
            currentPath = null;
            polyPoints = [];
        }
        deselectAll();
    };

    // --- COPIAR Y PEGAR ---
    window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'c') {
            clipboard = selectedElements.map(el => el.cloneNode(true));
        }
        if (e.ctrlKey && e.key === 'v') {
            clipboard.forEach(clone => {
                if (clone.tagName.toLowerCase() === 'div') {
                    clone.style.left = (parseFloat(clone.style.left) + 20) + "px";
                    clone.style.top = (parseFloat(clone.style.top) + 20) + "px";
                    latexLayer.appendChild(clone);
                    makeMovable(clone, 'div');
                    makeManualResize(clone, clone.querySelector('.resize-handle'));
                } else {
                    let t = clone.getAttribute("transform");
                    let match = t.match(/translate\(([^,)]+),? ?([^)]+)\)/);
                    let tx = parseFloat(match[1]) + 20;
                    let ty = parseFloat(match[2]) + 20;
                    clone.setAttribute("transform", t.replace(/translate\([^)]+\)/, `translate(${tx},${ty})`));
                    svg.appendChild(clone);
                    makeMovable(clone, 'path');
                }
            });
            saveState();
        }
        if (e.ctrlKey && e.key === 'z') undo();
        if (e.ctrlKey && e.key === 'y') redo();
    });

    // --- LATEX PANEL ---
    function openLatexPanel() {
        document.getElementById('latex-input-panel').style.display = 'flex';
        document.getElementById('latex-input-field').focus();
    }
    function closeLatexPanel() {
        document.getElementById('latex-input-panel').style.display = 'none';
        document.getElementById('latex-input-field').value = '';
    }
    function confirmLatex() {
        const val = document.getElementById('latex-input-field').value;
        if(val) addLatexItem(val);
        closeLatexPanel();
    }

    function addLatexItem(tex) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-item';
        wrapper.style.left = '150px'; wrapper.style.top = '150px';
        wrapper.style.transform = "scale(1)";
        wrapper.dataset.tex = tex;

        const content = document.createElement('div');
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        
        wrapper.appendChild(content);
        wrapper.appendChild(handle);
        latexLayer.appendChild(wrapper);
        katex.render(tex, content);

        wrapper.ondblclick = (e) => {
            e.stopPropagation();
            const n = prompt("Editar:", wrapper.dataset.tex);
            if(n) { wrapper.dataset.tex = n; katex.render(n, content); saveState(); }
        };

        makeMovable(wrapper, 'div');
        makeManualResize(wrapper, handle);
        saveState();
    }

    // --- MOVIMIENTO ---
    function makeMovable(el, type) {
        let dragging = false;
        let iX, iY;

        el.addEventListener('mousedown', (e) => {
            if (mode === 'ERASE') {
                el.remove();
                selectedElements = selectedElements.filter(i => i !== el);
                saveState();
                return;
            }
            if (!el.classList.contains('selected')) {
                deselectAll();
                el.classList.add('selected');
                selectedElements = [el];
            }
            e.stopPropagation();
            dragging = true;
            iX = e.clientX; iY = e.clientY;
        });

        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            let dx = e.clientX - iX;
            let dy = e.clientY - iY;
            selectedElements.forEach(item => moverElementoIndividual(item, dx, dy));
            iX = e.clientX; iY = e.clientY;
        });

        window.addEventListener('mouseup', () => {
            if(dragging) { dragging = false; saveState(); }
        });

        el.addEventListener('wheel', (e) => {
            e.preventDefault();
            let s = 1;
            const t = type === 'path' ? el.getAttribute("transform") : el.style.transform;
            const m = t.match(/scale\(([^)]+)\)/);
            if(m) s = parseFloat(m[1]);
            s += e.deltaY * -0.001;
            s = Math.max(0.1, s);
            if(type === 'path') el.setAttribute("transform", t.replace(/scale\([^)]+\)/, `scale(${s})`));
            else el.style.transform = `scale(${s})`;
            saveState();
        }, { passive: false });
    }

    function moverElementoIndividual(item, dx, dy) {
        if (item.tagName.toLowerCase() === 'div') {
            item.style.left = (parseFloat(item.style.left) + dx) + "px";
            item.style.top = (parseFloat(item.style.top) + dy) + "px";
        } else {
            let t = item.getAttribute("transform") || "translate(0,0) scale(1)";
            let translateMatch = t.match(/translate\(([^,)]+),? ?([^)]+)\)/);
            let tx = parseFloat(translateMatch[1]) + dx;
            let ty = parseFloat(translateMatch[2]) + dy;
            let scalePart = t.match(/scale\([^)]+\)/)[0];
            item.setAttribute("transform", `translate(${tx},${ty}) ${scalePart}`);
        }
    }

    function makeManualResize(el, handle) {
        let resizing = false;
        handle.onmousedown = (e) => { e.stopPropagation(); resizing = true; };
        document.addEventListener('mousemove', (e) => {
            if (!resizing) return;
            let s = parseFloat(el.style.transform.match(/scale\(([^)]+)\)/)[1]);
            s += (e.movementX + e.movementY) * 0.01;
            el.style.transform = `scale(${Math.max(0.2, s)})`;
        });
        document.addEventListener('mouseup', () => { if(resizing) { resizing = false; saveState(); } });
    }

    function deselectAll() {
        document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
        selectedElements = [];
    }

    function clearBoard() { if(confirm("¬øBorrar todo?")) { svg.innerHTML = ''; latexLayer.innerHTML = ''; saveState(); } }

    async function exportPNG() {
        deselectAll();
        const canvas = await html2canvas(document.getElementById('board-container'));
        const link = document.createElement('a');
        link.download = 'tablero.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
