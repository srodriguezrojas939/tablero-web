


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Matemático Pro</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        /* =========================================
           ESTÉTICA GENERAL (SOLO GRISES)
        ========================================= */
        :root {
            --bg-panel: #F2F2F2;
            --white: #FFFFFF;
            --black: #1A1A1A;
            --gray-light: #E0E0E0;
            --gray-medium: #888888;
            --gray-dark: #333333;
            --accent: #555555;
            --selection: rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--white);
            color: var(--black);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 10px;
            text-align: center;
            background: var(--white);
            border-bottom: 1px solid var(--gray-light);
        }

        h1 { font-size: 16px; margin: 0; letter-spacing: 1px; text-transform: uppercase; color: var(--gray-dark); }

        /* =========================================
           TOOLBAR
        ========================================= */
        .toolbar {
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--gray-light);
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 4px;
            border: 1px solid var(--gray-light);
            background: var(--white);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: var(--gray-dark);
        }

        .btn:hover { background: var(--gray-light); }
        .btn.active { background: var(--gray-dark); color: var(--white); border-color: var(--black); }

        .divider { border-left: 1px solid var(--gray-medium); height: 20px; margin: 0 10px; align-self: center; }

        /* =========================================
           CONTENEDOR DE DIBUJO
        ========================================= */
        #viewport-container {
            flex-grow: 1;
            position: relative;
            background-color: var(--white);
            overflow: hidden;
        }

        svg { width: 100%; height: 100%; display: block; touch-action: none; }

        /* Capas */
        .grid-lines { stroke: var(--gray-light); stroke-width: 0.5; }
        .snap-point { fill: var(--gray-medium); opacity: 0.2; }
        
        /* Elementos Dibujados */
        .stroke-pencil { fill: none; stroke: var(--black); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .polyline { fill: none; stroke: var(--gray-dark); stroke-width: 2; }
        
        /* Selección */
        .selection-box { fill: var(--selection); stroke: var(--gray-medium); stroke-dasharray: 4; }
        .selected-element { outline: 2px solid var(--gray-medium); }

        /* LaTeX y UI */
        .latex-container { 
            cursor: move; 
            user-select: none; 
            background: transparent;
            display: inline-block;
        }
        
        .resize-handle {
            fill: var(--white);
            stroke: var(--black);
            stroke-width: 1;
            cursor: nwse-resize;
        }

        #latex-input-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            padding: 15px;
            border: 1px solid var(--gray-light);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
            z-index: 2000;
        }
    </style>
</head>
<body>

<header>
    <h1>Tablero Matemático Gris</h1>
</header>

<div class="toolbar">
    <button class="btn active" id="mode-pencil" onclick="setMode('PENCIL')">Lápiz</button>
    <button class="btn" id="mode-poly" onclick="setMode('POLY')">Polilínea</button>
    <button class="btn" id="mode-select" onclick="setMode('SELECT')">Selector</button>
    <div class="divider"></div>
    <button class="btn" onclick="document.getElementById('img-input').click()">+ Imagen</button>
    <input type="file" id="img-input" hidden accept="image/*" onchange="handleImage(event)">
    <button class="btn" onclick="toggleLatexInput()">Σ LaTeX</button>
    <div class="divider"></div>
    <button class="btn" onclick="undo()">Deshacer</button>
    <button class="btn" onclick="redo()">Rehacer</button>
    <div class="divider"></div>
    <button class="btn" id="mode-snap" onclick="toggleSnap()">Snap: ON</button>
    <button class="btn" style="color:red" onclick="clearAll()">Limpiar</button>
</div>

<div id="viewport-container">
    <div id="latex-input-panel">
        <input type="text" id="latex-text" placeholder="Escribe LaTeX aquí (ej: \frac{a}{b})" style="width: 250px; padding: 5px;">
        <button class="btn" onclick="addLatex()">Insertar</button>
    </div>

    <svg id="canvas">
        <defs>
            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#E0E0E0" stroke-width="0.5"/>
            </pattern>
        </defs>
        
        <rect width="100%" height="100%" fill="url(#grid)" />

        <g id="main-group">
            <g id="layer-images"></g>   <g id="layer-latex"></g>    <g id="layer-drawings"></g> <g id="layer-ui"></g>       </g>
    </svg>
</div>

<script>
    /* ==========================================================================
       SECCIÓN 1: VARIABLES GLOBALES Y CONFIGURACIÓN
       ========================================================================== */
    let mode = 'PENCIL';
    let isSnap = true;
    const gridStep = 40;
    
    let drawing = false;
    let currentPath = null;
    let points = [];
    
    let selectionStart = null;
    let selectedElements = [];
    let isDragging = false;
    let dragTarget = null;
    let lastMousePos = { x: 0, y: 0 };

    let undoStack = [];
    let redoStack = [];

    const svg = document.getElementById('canvas');
    const layers = {
        images: document.getElementById('layer-images'),
        latex: document.getElementById('layer-latex'),
        drawings: document.getElementById('layer-drawings'),
        ui: document.getElementById('layer-ui')
    };

    /* ==========================================================================
       SECCIÓN 2: UTILIDADES Y SNAP
       ========================================================================== */
    function getCoords(e) {
        const rect = svg.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;
        if (isSnap) {
            x = Math.round(x / gridStep) * gridStep;
            y = Math.round(y / gridStep) * gridStep;
        }
        return { x, y };
    }

    function setMode(newMode) {
        mode = newMode;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`mode-${newMode.toLowerCase().substring(0,4)}`)?.classList.add('active');
        if(mode !== 'SELECT') clearSelection();
    }

    function toggleSnap() {
        isSnap = !isSnap;
        document.getElementById('mode-snap').innerText = `Snap: ${isSnap ? 'ON' : 'OFF'}`;
    }

    function saveState() {
        const state = {
            drawings: layers.drawings.innerHTML,
            latex: layers.latex.innerHTML,
            images: layers.images.innerHTML
        };
        undoStack.push(state);
        redoStack = [];
    }

    function undo() {
        if (undoStack.length === 0) return;
        const current = {
            drawings: layers.drawings.innerHTML,
            latex: layers.latex.innerHTML,
            images: layers.images.innerHTML
        };
        redoStack.push(current);
        const state = undoStack.pop();
        layers.drawings.innerHTML = state.drawings;
        layers.latex.innerHTML = state.latex;
        layers.images.innerHTML = state.images;
        rebindEvents();
    }

    /* ==========================================================================
       SECCIÓN 3: HERRAMIENTAS DE DIBUJO (LÁPIZ Y POLILÍNEA)
       ========================================================================== */
    svg.onmousedown = (e) => {
        const coords = getCoords(e);
        lastMousePos = coords;

        if (mode === 'PENCIL') {
            saveState();
            drawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentPath.setAttribute("class", "stroke-pencil");
            currentPath.setAttribute("d", `M ${coords.x} ${coords.y}`);
            layers.drawings.appendChild(currentPath);
        } 
        else if (mode === 'POLY') {
            if (!drawing) {
                saveState();
                drawing = true;
                points = [coords];
                currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                currentPath.setAttribute("class", "polyline");
                layers.drawings.appendChild(currentPath);
            } else {
                points.push(coords);
            }
        }
        else if (mode === 'SELECT') {
            const target = e.target.closest('.draggable');
            if (target) {
                isDragging = true;
                dragTarget = target;
            } else {
                selectionStart = coords;
                clearSelection();
            }
        }
    };

    svg.onmousemove = (e) => {
        const coords = getCoords(e);

        if (drawing && mode === 'PENCIL') {
            const d = currentPath.getAttribute("d");
            currentPath.setAttribute("d", `${d} L ${coords.x} ${coords.y}`);
        }
        else if (drawing && mode === 'POLY') {
            const tempPoints = [...points, coords].map(p => `${p.x},${p.y}`).join(" ");
            currentPath.setAttribute("points", tempPoints);
        }
        else if (isDragging && dragTarget) {
            const dx = coords.x - lastMousePos.x;
            const dy = coords.y - lastMousePos.y;
            
            if (dragTarget.tagName === 'foreignObject' || dragTarget.tagName === 'image') {
                dragTarget.setAttribute("x", parseFloat(dragTarget.getAttribute("x")) + dx);
                dragTarget.setAttribute("y", parseFloat(dragTarget.getAttribute("y")) + dy);
            }
            lastMousePos = coords;
        }
        else if (selectionStart) {
            updateSelectionBox(selectionStart, coords);
        }
    };

    window.onmouseup = () => {
        if (mode === 'PENCIL') drawing = false;
        if (isDragging) { isDragging = false; dragTarget = null; }
        selectionStart = null;
        layers.ui.innerHTML = '';
    };

    // Doble click para cerrar polilínea
    svg.ondblclick = () => {
        if (mode === 'POLY') drawing = false;
    };

    /* ==========================================================================
       SECCIÓN 4: LATEX E IMÁGENES
       ========================================================================== */
    function toggleLatexInput() {
        const panel = document.getElementById('latex-input-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function addLatex() {
        const text = document.getElementById('latex-text').value;
        if (!text) return;
        saveState();
        
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("x", 100);
        fo.setAttribute("y", 100);
        fo.setAttribute("width", "200");
        fo.setAttribute("height", "100");
        fo.setAttribute("class", "draggable latex-element");
        
        const div = document.createElement("div");
        div.className = "latex-container";
        div.innerHTML = `\\(${text}\\)`;
        
        fo.appendChild(div);
        layers.latex.appendChild(fo);
        
        MathJax.typeset();
        toggleLatexInput();
        rebindEvents();
    }

    function handleImage(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            saveState();
            const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
            img.setAttribute("href", event.target.result);
            img.setAttribute("x", 50);
            img.setAttribute("y", 50);
            img.setAttribute("width", "200");
            img.setAttribute("class", "draggable");
            img.style.cursor = "move";
            layers.images.appendChild(img);
            rebindEvents();
        };
        reader.readAsDataURL(file);
    }

    /* ==========================================================================
       SECCIÓN 5: SELECTOR INTELIGENTE Y REBIND
       ========================================================================== */
    function updateSelectionBox(start, end) {
        layers.ui.innerHTML = '';
        const x = Math.min(start.x, end.x);
        const y = Math.min(start.y, end.y);
        const w = Math.abs(start.x - end.x);
        const h = Math.abs(start.y - end.y);
        
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("width", w);
        rect.setAttribute("height", h);
        rect.setAttribute("class", "selection-box");
        layers.ui.appendChild(rect);
    }

    function clearSelection() {
        document.querySelectorAll('.selected-element').forEach(el => el.classList.remove('selected-element'));
    }

    function rebindEvents() {
        // Asegurar que elementos nuevos tengan clase draggable
        document.querySelectorAll('.latex-element, image').forEach(el => {
            el.classList.add('draggable');
        });
    }

    function clearAll() {
        if(confirm("¿Limpiar todo el tablero?")) {
            saveState();
            layers.drawings.innerHTML = '';
            layers.latex.innerHTML = '';
            layers.images.innerHTML = '';
        }
    }
</script>

</body>
</html>
