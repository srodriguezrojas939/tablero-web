<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Grayscale Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        /* --- PALETA DE COLORES (SOLO BLANCOS Y GRISES) --- */
        :root {
            --bg-outer: #F0F0F0;     /* Fondo exterior gris claro */
            --board-bg: #FFFFFF;     /* Fondo del tablero BLANCO PURO */
            --text-primary: #222222; /* Texto casi negro */
            --text-secondary: #666666; /* Texto gris medio */
            --accent-gray: #888888;  /* Acento gris para estados activos */
            --ui-bg: #FFFFFF;        /* Fondo de elementos UI */
            --pill-bg: #E0E0E0;      /* Fondo de pildoras inactivas */
            --border-color: #CCCCCC; /* Color de bordes suaves */
            --shadow: rgba(0,0,0,0.15); /* Sombra suave negra */
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-outer); }

        /* --- HEADER (GRAYSCALE) --- */
        header {
            position: absolute; top: 15px; left: 20px; z-index: 100;
            display: flex; align-items: baseline; gap: 10px; pointer-events: none;
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; color: var(--text-primary); }
        header span { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--text-secondary); font-weight: bold; }

        /* --- LIBRER√çA DE S√çMBOLOS (ESQUINA INFERIOR DERECHA & SCROLLS) --- */
        .symbol-library {
            position: absolute;
            bottom: 90px; /* Encima de la barra principal */
            right: 20px;  /* Esquina derecha */
            width: 400px; /* M√°s ancho para acomodar scrolls */
            background: var(--ui-bg);
            border-radius: 12px; padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 1000;
        }

        /* Scroll horizontal para categor√≠as */
        .pill-container {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: thin; scrollbar-color: var(--accent-gray) transparent;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 12px;
        }
        /* Scroll horizontal para s√≠mbolos */
        .symbol-grid {
            display: flex; /* Cambiado de grid a flex para scroll horizontal */
            gap: 8px; overflow-x: auto; padding-bottom: 5px;
            scrollbar-width: thin; scrollbar-color: var(--accent-gray) transparent;
        }

        .pill {
            padding: 6px 14px; background: var(--pill-bg); border-radius: 20px;
            font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: 0.2s; border: none; color: var(--text-secondary); flex-shrink: 0;
        }
        .pill.active { background: var(--text-primary); color: var(--board-bg); }

        .symbol-btn {
            background: var(--board-bg); border: 1px solid var(--border-color); border-radius: 8px;
            height: 50px; width: 60px; /* Ancho fijo para scroll */
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0;
            color: var(--text-primary);
        }
        .symbol-btn:hover { border-color: var(--text-primary); background: #f9f9f9; }
        .symbol-btn span { font-size: 16px; margin-bottom: 2px; }
        .symbol-btn small { font-size: 9px; text-transform: uppercase; color: var(--text-secondary); }

        /* --- TABLERO (FONDO BLANCO) --- */
        #board-container { width: 100vw; height: 100vh; position: relative; background: var(--board-bg); }
        svg { width: 100%; height: 100%; cursor: crosshair; }

        /* Elementos interactivos */
        .draggable-item {
            position: absolute; cursor: move; padding: 8px;
            border-radius: 4px; transform-origin: center; /* Crucial para escalado */
        }
        .draggable-item:hover { outline: 1px dashed var(--accent-gray); }
        .draggable-item.delete-mode:hover { outline: 2px solid red; cursor: not-allowed; opacity: 0.7; } /* Indicador visual de borrado */

        /* Estilos de Dibujo */
        .sketch-path {
            fill: none; stroke: var(--text-primary); stroke-width: 3;
            stroke-linecap: round; stroke-linejoin: round; cursor: move;
            transform-origin: center; /* Crucial para escalado */
            pointer-events: all; /* Asegura que capture eventos de mouse */
        }
        .sketch-path:hover { opacity: 0.7; }
        .sketch-path.delete-mode:hover { stroke: red; cursor: not-allowed; }

        /* --- BARRA DE HERRAMIENTAS PRINCIPAL (REDISE√ëADA) --- */
        .toolbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--ui-bg); padding: 8px 15px; border-radius: 50px;
            display: flex; gap: 10px; box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid var(--border-color); z-index: 100;
        }
        .tool-btn {
            border: 1px solid transparent; background: none; font-size: 18px;
            cursor: pointer; padding: 8px 12px; border-radius: 12px; color: var(--text-secondary);
            display: flex; align-items: center; gap: 5px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px;
        }
        .tool-btn i { font-style: normal; font-size: 18px; }
        .tool-btn:hover { background: var(--bg-outer); color: var(--text-primary); }
        .tool-btn.active { background: var(--text-primary); color: var(--board-bg); }
        .divider { width: 1px; background: var(--border-color); margin: 0 5px; }
    </style>
</head>
<body>

<header>
    <h1>Tablero</h1>
    <span>Escala de Grises</span>
</header>

<div class="symbol-library">
    <div class="pill-container" id="category-pills">
        </div>
    <div class="symbol-grid" id="symbol-display">
        </div>
</div>

<div class="toolbar">
    <button class="tool-btn active" onclick="setMode('DRAW')" title="Dibujar"><i>‚úé</i> L√°piz</button>
    <button class="tool-btn" onclick="setMode('DELETE')" title="Modo Borrador (Click para eliminar)"><i>‚úñ</i> Borrador</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="copyLatex()" title="Copiar todo el LaTeX al portapapeles"><i>üìã</i> Copiar LaTeX</button>
    <button class="tool-btn" onclick="clearBoard()" title="Limpiar Tablero"><i>üóë</i> Limpiar</button>
    <div class="divider"></div>
    <button class="tool-btn" onclick="exportPNG()" title="Descargar Imagen"><i>‚¨á</i> PNG</button>
</div>

<div id="board-container">
    <svg id="svg-canvas"></svg>
    <div id="latex-layer"></div>
</div>

<script>
    let mode = 'DRAW'; // Modos: DRAW, DELETE, MOVE (Move es impl√≠cito al no estar en draw/delete)
    let isDrawing = false;
    let currentPath = null;

    const svg = document.getElementById('svg-canvas');
    const latexLayer = document.getElementById('latex-layer');
    const symbolDisplay = document.getElementById('symbol-display');
    const categoryPills = document.getElementById('category-pills');
    const boardContainer = document.getElementById('board-container');

    // --- CONFIGURACI√ìN DE LIBRER√çA (Expandida para probar el scroll) ---
    const library = {
        "Principales": [
            { s: "\\sum", n: "sum" }, { s: "\\int", n: "int" }, { s: "\\prod", n: "prod" },
            { s: "\\sqrt{x}", n: "sqrt" }, { s: "\\frac{a}{b}", n: "frac" }, { s: "x^2", n: "pow" },
            { s: "x_i", n: "sub" }, { s: "\\lim", n: "lim" }
        ],
        "Letras Griegas": [
            { s: "\\alpha", n: "alpha" }, { s: "\\beta", n: "beta" }, { s: "\\gamma", n: "gamma" },
            { s: "\\delta", n: "delta" }, { s: "\\epsilon", n: "epsilon" }, { s: "\\theta", n: "theta" },
            { s: "\\lambda", n: "lambda" }, { s: "\\pi", n: "pi" }, { s: "\\sigma", n: "sigma" },
            { s: "\\omega", n: "omega" }, { s: "\\Delta", n: "Delta" }, { s: "\\Omega", n: "Omega" }
        ],
        "L√≥gica/Conjuntos": [
            { s: "\\forall", n: "forall" }, { s: "\\exists", n: "exists" }, { s: "\\in", n: "in" },
            { s: "\\subset", n: "subset" }, { s: "\\cup", n: "cup" }, { s: "\\cap", n: "cap" },
            { s: "\\rightarrow", n: "to" }, { s: "\\leftrightarrow", n: "iff" }, { s: "\\neg", n: "neg" }
        ],
        "Matrices/Otros": [
             { s: "\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}", n: "pmatrix" },
             { s: "\\infty", n: "infty" }, { s: "\\partial", n: "partial" }, { s: "\\nabla", n: "nabla" },
             { s: "\\neq", n: "neq" }, { s: "\\approx", n: "approx" }
        ]
    };

    // Cargar Pildoras
    Object.keys(library).forEach((cat, index) => {
        const btn = document.createElement('button');
        btn.className = `pill ${index === 0 ? 'active' : ''}`;
        btn.innerText = cat;
        btn.onclick = () => {
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            renderSymbols(cat);
        };
        categoryPills.appendChild(btn);
    });

    function renderSymbols(cat) {
        symbolDisplay.innerHTML = '';
        library[cat].forEach(item => {
            const b = document.createElement('div');
            b.className = 'symbol-btn';
            b.innerHTML = `<span></span><small>${item.n}</small>`;
            symbolDisplay.appendChild(b);
            katex.render(item.s, b.querySelector('span'), { throwOnError: false });
            b.onclick = () => addLatexItem(item.s);
        });
    }
    renderSymbols("Principales");

    // --- L√ìGICA DEL TABLERO Y MODOS ---
    function setMode(m) {
        mode = m;
        // Actualizar UI de botones
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // Cursor y estado visual seg√∫n modo
        if (mode === 'DRAW') {
            svg.style.cursor = 'crosshair';
            boardContainer.classList.remove('delete-active');
        } else if (mode === 'DELETE') {
            svg.style.cursor = 'not-allowed';
            boardContainer.classList.add('delete-active');
        } else {
            svg.style.cursor = 'default';
            boardContainer.classList.remove('delete-active');
        }
        updateDeleteModeVisuals();
    }

    function updateDeleteModeVisuals() {
        const elements = document.querySelectorAll('.draggable-item, .sketch-path');
        elements.forEach(el => {
            if (mode === 'DELETE') el.classList.add('delete-mode');
            else el.classList.remove('delete-mode');
        });
    }

    // --- DIBUJO (L√ÅPIZ) ---
    svg.onmousedown = (e) => {
        if (mode !== 'DRAW') return;
        // Evitar dibujar si se hace click sobre un elemento existente (para moverlo)
        if (e.target.classList.contains('sketch-path') || e.target.closest('.draggable-item')) return;

        isDrawing = true;
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        currentPath.setAttribute("class", "sketch-path");
        currentPath.setAttribute("d", `M ${x} ${y}`);
        // Inicializar transformaci√≥n para que el escalado funcione bien
        currentPath.setAttribute("transform", "translate(0,0) scale(1)");
        svg.appendChild(currentPath);
    };

    svg.onmousemove = (e) => {
        if (!isDrawing || !currentPath) return;
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const d = currentPath.getAttribute("d");
        currentPath.setAttribute("d", `${d} L ${x} ${y}`);
    };

    window.onmouseup = () => {
        if (isDrawing && currentPath) {
            // Al terminar de dibujar, a√±adir funcionalidades
            makeInteractive(currentPath, 'path');
        }
        isDrawing = false;
        currentPath = null;
    };

    // --- LATEX ---
    function addLatexItem(tex) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-item';
        // Posici√≥n inicial centrada
        wrapper.style.left = (boardContainer.offsetWidth / 2 - 50) + 'px';
        wrapper.style.top = (boardContainer.offsetHeight / 2 - 50) + 'px';
        wrapper.dataset.latex = tex; // Guardar el c√≥digo LaTeX crudo para copiar
        wrapper.style.transform = "scale(1)"; // Inicializar escala

        const content = document.createElement('div');
        wrapper.appendChild(content);
        latexLayer.appendChild(wrapper);
        
        katex.render(tex, content, { throwOnError: false });
        makeInteractive(wrapper, 'div');
    }

    // --- FUNCIONES CENTRALES DE INTERACCI√ìN (MOVER, ESCALAR, BORRAR) ---
    function makeInteractive(el, type) {
        makeMovable(el, type);
        makeScalable(el);
        makeDeletable(el);
        if(mode === 'DELETE') el.classList.add('delete-mode');
    }

    function makeDeletable(el) {
        el.addEventListener('click', (e) => {
            if (mode === 'DELETE') {
                e.stopPropagation(); // Evitar otros eventos
                el.remove();
            }
        });
        // Para elementos SVG, necesitamos mousedown tambi√©n porque a veces no disparan click bien si se mueven un pixel
        if (el.tagName === 'path') {
             el.addEventListener('mousedown', (e) => {
                if (mode === 'DELETE') {
                    e.stopPropagation();
                    el.remove();
                }
            });
        }
    }

    // --- ESCALADO UNIVERSAL (L√ÅPIZ Y LATEX) ---
    function makeScalable(el) {
        el.addEventListener('wheel', (e) => {
            // Permitir escalado en modo DRAW o si no hay modo activo (move impl√≠cito)
            if (mode === 'DELETE') return;
            e.preventDefault();
            e.stopPropagation();

            // Obtener la transformaci√≥n actual
            let currentTransform = el.style.transform || el.getAttribute("transform") || "scale(1)";
            
            // Extraer la escala actual usando Regex
            let scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
            let scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;

            // Calcular nueva escala
            scale += e.deltaY * -0.001;
            scale = Math.min(Math.max(0.3, scale), 5); // L√≠mites de escala (0.3x a 5x)

            // Aplicar la nueva transformaci√≥n manteniendo la traslaci√≥n si existe
            if (el.tagName === 'path') {
                // Para SVG paths, mantenemos el translate existente en el atributo
                let translateMatch = currentTransform.match(/translate\(([^)]+)\)/);
                let translatePart = translateMatch ? translateMatch[0] : "translate(0,0)";
                el.setAttribute("transform", `${translatePart} scale(${scale})`);
            } else {
                // Para DIVs de LaTeX, usamos estilo CSS directo
                el.style.transform = `scale(${scale})`;
            }
        });
    }

    // --- MOVIMIENTO UNIVERSAL ---
    function makeMovable(el, type) {
        let isDragging = false;
        let startX, startY;
        // Posici√≥n inicial para SVG paths
        let initialTranslateX = 0, initialTranslateY = 0;

        el.addEventListener('mousedown', (e) => {
            if (mode === 'DELETE') return;
            // En modo DRAW, solo permitir mover si se hace click directo en el elemento, no en el fondo
            if (mode === 'DRAW' && e.target !== el && !el.contains(e.target)) return;

            e.stopPropagation();
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            svg.style.cursor = 'grabbing';

            if (type === 'path') {
                // Obtener la traslaci√≥n actual del path SVG
                const transform = el.getAttribute("transform") || "";
                const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
                if (match) {
                    initialTranslateX = parseFloat(match[1]);
                    initialTranslateY = parseFloat(match[2]);
                } else {
                    initialTranslateX = 0; initialTranslateY = 0;
                }
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            if (type === 'path') {
                // Mover path SVG actualizando el atributo transform translate, manteniendo scale
                let currentTransform = el.getAttribute("transform") || "scale(1)";
                let scalePart = currentTransform.match(/scale\([^)]+\)/) || ["scale(1)"];
                el.setAttribute("transform", `translate(${initialTranslateX + dx},${initialTranslateY + dy}) ${scalePart[0]}`);
            } else {
                // Mover DIV LaTeX usando top/left CSS
                el.style.left = (el.offsetLeft + dx) + 'px';
                el.style.top = (el.offsetTop + dy) + 'px';
            }
            startX = e.clientX;
            startY = e.clientY;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                 svg.style.cursor = mode === 'DRAW' ? 'crosshair' : (mode === 'DELETE' ? 'not-allowed' : 'default');
            }
        });
    }

    // --- FUNCIONALIDADES DE BARRA DE HERRAMIENTAS ---
    function clearBoard() {
        if (confirm('¬øBorrar todo el tablero?')) {
            svg.innerHTML = '';
            latexLayer.innerHTML = '';
        }
    }

    async function copyLatex() {
        const latexItems = Array.from(latexLayer.getElementsByClassName('draggable-item'));
        if (latexItems.length === 0) {
            alert("No hay elementos LaTeX para copiar.");
            return;
        }
        // Extraer el LaTeX crudo guardado en el dataset
        const allLatex = latexItems.map(item => item.dataset.latex).join('\n');
        try {
            await navigator.clipboard.writeText(allLatex);
            alert("LaTeX copiado al portapapeles:\n\n" + allLatex);
        } catch (err) {
            alert('Error al copiar: ' + err);
        }
    }

    async function exportPNG() {
        // Desactivar temporalmente los bordes de selecci√≥n/borrado para la captura
        const wasDeleteMode = mode === 'DELETE';
        if (wasDeleteMode) {
             setMode('MOVE'); // Cambiar a un modo neutro
             updateDeleteModeVisuals();
        }
        
        const canvas = await html2canvas(boardContainer, {
            backgroundColor: '#FFFFFF', // Asegurar fondo blanco en la captura
            scale: 2, // Mayor calidad
            logging: false
        });
        
        const link = document.createElement('a');
        link.download = 'tablero-grayscale.png';
        link.href = canvas.toDataURL('image/png');
        link.click();

        if (wasDeleteMode) setMode('DELETE'); // Restaurar modo
    }
</script>
</body>
</html>
